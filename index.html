<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.1.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.1.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="iOS 修炼中...">
<meta property="og:type" content="website">
<meta property="og:title" content="以梦为马">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="以梦为马">
<meta property="og:description" content="iOS 修炼中...">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="以梦为马">
<meta name="twitter:description" content="iOS 修炼中...">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>以梦为马</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">以梦为马</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">谨以此纪念岁月</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-主页 menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />主页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-归档">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之 - AFNetworking - 上传、下载、网络监听/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之 - AFNetworking - 上传、下载、网络监听/" itemprop="url">
                  iOS开发之 - AFNetworking - 上传、下载、网络监听
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这一篇是接着上一篇总结的，如果有朋友需要了解网络请求的内容，可以<a href="http://www.jianshu.com/p/d23f4f913af1" target="_blank" rel="noopener">到这里</a>。和上篇一样，先说下这篇文章的大概内容，以便朋友们能够快速找到自己需要的。这篇文章主要介绍了 AFNetworking 的三个很广泛的应用：上传、下载以及网络监听。如果有朋友想了解苹果自带的 NSURLSession 相关的上传与下载，可以<a href="http://www.jianshu.com/p/be94889824d9" target="_blank" rel="noopener">到这里</a>。接下来是使用 AFNetworking 上传、下载以及网络监听的 demo.</p>
<h2 id="一、上传："><a href="#一、上传：" class="headerlink" title="一、上传："></a>一、上传：</h2><p>这里介绍了 AFN 的两种上传方式：</p>
<p>1.通过工程中的文件上传<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建管理者对象</span></span><br><span class="line">AFHTTPSessionManager *sessionManager = [AFHTTPSessionManager manager];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求参数</span></span><br><span class="line"><span class="built_in">NSString</span> *urlStr = <span class="string">@" "</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSDictionary</span> *dic = @&#123;<span class="string">@" "</span> : <span class="string">@" "</span>,<span class="string">@" "</span> : <span class="string">@" "</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送 post 请求，上传一张图片</span></span><br><span class="line">[sessionManager POST:urlStr parameters:dic constructingBodyWithBlock:^(<span class="keyword">id</span>&lt;AFMultipartFormData&gt;  _Nonnull formData) &#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *filePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@"a.jpg"</span> ofType:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSData</span> *imgData = [<span class="built_in">NSData</span> dataWithContentsOfFile:filePath];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将图片数据拼接，进行上传</span></span><br><span class="line">[formData appendPartWithFileData:imgData name:<span class="string">@"pic"</span> fileName:<span class="string">@"filename"</span> mimeType:<span class="string">@"image/jpg"</span>];</span><br><span class="line"></span><br><span class="line">&#125; progress:^(<span class="built_in">NSProgress</span> * _Nonnull uploadProgress) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取上传的进度</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%.2f"</span>,uploadProgress.fractionCompleted);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,[<span class="built_in">NSThread</span> currentThread]); <span class="comment">//子线程</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; success:^(<span class="built_in">NSURLSessionDataTask</span> * _Nonnull task, <span class="keyword">id</span>  _Nullable responseObject) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求成功</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"请求成功：%@"</span>,responseObject);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,[<span class="built_in">NSThread</span> currentThread]); <span class="comment">//主线程</span></span><br><span class="line"></span><br><span class="line">&#125; failure:^(<span class="built_in">NSURLSessionDataTask</span> * _Nullable task, <span class="built_in">NSError</span> * _Nonnull error) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求失败</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"请求失败：%@"</span>,error);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>2.根据URL路径上传<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建管理者对象</span></span><br><span class="line">AFHTTPSessionManager *sessionManager = [AFHTTPSessionManager manager];</span><br><span class="line"></span><br><span class="line">[sessionManager <span class="string">POST:</span>@<span class="string">" "</span> <span class="string">parameters:</span>@&#123;@<span class="string">" "</span> : @<span class="string">" "</span>&#125; <span class="string">constructingBodyWithBlock:</span>^(id&lt;AFMultipartFormData&gt; formData) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在block中设置需要上传的文件</span></span><br><span class="line">[formData <span class="string">appendPartWithFileURL:</span>[NSURL <span class="string">fileURLWithPath:</span>@<span class="string">"文件路径"</span>] <span class="string">name:</span>@<span class="string">"file"</span> <span class="string">error:</span>nil];</span><br><span class="line"></span><br><span class="line">&#125; <span class="string">success:</span>^(NSURLSessionDataTask *task, id responseObject) &#123;</span><br><span class="line"></span><br><span class="line">NSLog(@<span class="string">"成功：%@"</span>, responseObject);</span><br><span class="line"></span><br><span class="line">&#125; <span class="string">failure:</span>^(NSURLSessionDataTask *task, NSError *error) &#123;</span><br><span class="line">NSLog(@<span class="string">"失败：%@"</span>, error);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<h2 id="二、下载"><a href="#二、下载" class="headerlink" title="二、下载"></a>二、下载</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建管理者对象</span></span><br><span class="line">AFHTTPSessionManager *manager = [AFHTTPSessionManager manager];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 确定请求的URL地址</span></span><br><span class="line"><span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@" "</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建请求对象</span></span><br><span class="line"><span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:url];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下载文件</span></span><br><span class="line"><span class="built_in">NSURLSessionDownloadTask</span> *task = [manager downloadTaskWithRequest:request progress:^(<span class="built_in">NSProgress</span> * _Nonnull downloadProgress) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// block会实时调用</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%.2f"</span>,downloadProgress.fractionCompleted);</span><br><span class="line"></span><br><span class="line">&#125; destination:^<span class="built_in">NSURL</span> * _Nonnull(<span class="built_in">NSURL</span> * _Nonnull targetPath, <span class="built_in">NSURLResponse</span> * _Nonnull response) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NSHomeDirectory()可以得到应用程序目录的路径</span></span><br><span class="line"><span class="comment">// 返回一个URL存储文件</span></span><br><span class="line"><span class="built_in">NSString</span> *filePath = [<span class="built_in">NSHomeDirectory</span>() stringByAppendingPathComponent:<span class="string">@"Documents/***.mp3"</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> fileURLWithPath:filePath];</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> url;</span><br><span class="line"></span><br><span class="line">&#125; completionHandler:^(<span class="built_in">NSURLResponse</span> * _Nonnull response, <span class="built_in">NSURL</span> * _Nullable filePath, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (error) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"下载失败 ~~~ %@"</span>,error);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"下载成功"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开始下载任务</span></span><br><span class="line">[task resume];</span><br></pre></td></tr></table></figure>
<h2 id="三、网络监听（监听手机网络的不同状态）"><a href="#三、网络监听（监听手机网络的不同状态）" class="headerlink" title="三、网络监听（监听手机网络的不同状态）"></a>三、网络监听（监听手机网络的不同状态）</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得网络监控的管理者</span></span><br><span class="line">AFNetworkReachabilityManager *manager = [AFNetworkReachabilityManager manager];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只要网络环境发生变化，就会调用此 block</span></span><br><span class="line">[manager <span class="string">setReachabilityStatusChangeBlock:</span>^(AFNetworkReachabilityStatus status) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 枚举里面的四个状态</span></span><br><span class="line"><span class="comment">AFNetworkReachabilityStatusUnknown          = -1,  未知</span></span><br><span class="line"><span class="comment">AFNetworkReachabilityStatusNotReachable     = 0,   不可用</span></span><br><span class="line"><span class="comment">AFNetworkReachabilityStatusReachableViaWWAN = 1,   手机自带网络</span></span><br><span class="line"><span class="comment">AFNetworkReachabilityStatusReachableViaWiFi = 2,   wifi</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (status) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">AFNetworkReachabilityStatusUnknown:</span></span><br><span class="line">NSLog(@<span class="string">"未知"</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">AFNetworkReachabilityStatusNotReachable:</span></span><br><span class="line">NSLog(@<span class="string">"不可用"</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">AFNetworkReachabilityStatusReachableViaWWAN:</span></span><br><span class="line">NSLog(@<span class="string">"手机自带网络"</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">AFNetworkReachabilityStatusReachableViaWiFi:</span></span><br><span class="line">NSLog(@<span class="string">"Wifi"</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="string">default:</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开始监听</span></span><br><span class="line">[manager startMonitoring];</span><br></pre></td></tr></table></figure>
<p>这是今天做的一些关于 AFNetworking 的总结，如果有错误或疏忽的地方，希望大家能够指出！谢谢大家！！！</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之 - AFNetworking - 网络请求/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之 - AFNetworking - 网络请求/" itemprop="url">
                  iOS开发之 - AFNetworking - 网络请求
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>最近一直很忙也没有时间写博客，今天正好有点空闲时间，所以就对 <a href="https://github.com/AFNetworking/AFNetworking/" target="_blank" rel="noopener">AFNetworking</a> 做了一些简单的总结，特地记录下来，以便遇到的朋友们看看！！！</p>
</blockquote>
<p>先说下这篇文章的大概内容，以便朋友们能够快速找到自己需要的。这篇文章主要介绍了三种网络请求的渠道，第一种是通过苹果自带的 NSURLSession 请求网络；第二种是通过 AFNetworking2.x 请求网络；最后一种是通过 AFNetworking3.0 请求网络。下边是这三种网络请求渠道的 demo.</p>
<h2 id="一、苹果自带的请求网络方法："><a href="#一、苹果自带的请求网络方法：" class="headerlink" title="一、苹果自带的请求网络方法："></a>一、苹果自带的请求网络方法：</h2><p>这里介绍了三种，GET 请求、POST 请求、代理方式请求。</p>
<p>1.GET 请求:<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得 NSURLSession 对象</span></span><br><span class="line"><span class="built_in">NSURLSession</span> *session =  [<span class="built_in">NSURLSession</span> sessionWithConfiguration:[<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration] delegate:<span class="literal">nil</span> delegateQueue:[<span class="built_in">NSOperationQueue</span> mainQueue]];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建任务</span></span><br><span class="line"><span class="built_in">NSURLSessionDataTask</span> *dataTask = [session dataTaskWithRequest:[<span class="built_in">NSURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@" "</span>]] completionHandler:^(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"data ~~~ %@ ~~~ response ~~~ %@ ~~~ error~~~ %@"</span>, data, response , error);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动任务</span></span><br><span class="line">[dataTask resume];</span><br></pre></td></tr></table></figure></p>
<p>2.POST 请求:<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得NSURLSession对象</span></span><br><span class="line"><span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sharedSession];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建请求</span></span><br><span class="line"><span class="built_in">NSMutableURLRequest</span> *request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@" "</span>]];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置请求方法</span></span><br><span class="line">request.HTTPMethod = <span class="string">@"POST"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置请求体</span></span><br><span class="line">request.HTTPBody = [<span class="string">@" "</span> dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建任务</span></span><br><span class="line"><span class="built_in">NSURLSessionDataTask</span> *task = [session dataTaskWithRequest:request completionHandler:^(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"data ~~~ %@ ~~~ response ~~~ %@ ~~~ error~~~ %@"</span>, data, response , error);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动任务</span></span><br><span class="line">[task resume];</span><br></pre></td></tr></table></figure></p>
<p>3.代理:NSURLSessionDataDelegate<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">[<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableURLRequest</span> *request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@" "</span>]];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:[<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration] delegate:<span class="keyword">self</span> delegateQueue:[<span class="built_in">NSOperationQueue</span> mainQueue]];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果创建task时，有block，代理会失效</span></span><br><span class="line"><span class="built_in">NSURLSessionDataTask</span> *task = [session dataTaskWithRequest:request];</span><br><span class="line"></span><br><span class="line">[task resume];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSURLSessionDataDelegate</span></span><br><span class="line"><span class="meta">#pragma mark - 接收到响应头调用的协议方法</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">didReceiveResponse:(<span class="built_in">NSURLResponse</span> *)response</span><br><span class="line">completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionResponseDisposition</span> disposition))completionHandler &#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSHTTPURLResponse</span> *httpRes = (<span class="built_in">NSHTTPURLResponse</span> *)response;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,httpRes.allHeaderFields);</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过设置 completionHandler, Block 可以设置后面的响应体中的数据是否继续发送,默认是不发送</span></span><br><span class="line">completionHandler(<span class="built_in">NSURLSessionResponseAllow</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 数据请求完成后，调用的协议方法，data是响应体中的数据</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">didReceiveData:(<span class="built_in">NSData</span> *)data &#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 不管请求成功还是失败，最终都会调用此方法</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session task:(<span class="built_in">NSURLSessionTask</span> *)task didCompleteWithError:(<span class="built_in">NSError</span> *)error &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (error) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"请求失败"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"请求成功"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="二、AFNetworking2-x"><a href="#二、AFNetworking2-x" class="headerlink" title="二、AFNetworking2.x"></a>二、AFNetworking2.x</h2><p>1.GET 请求<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AFHTTPRequestOperationManager *operationManager = [AFHTTPRequestOperationManager manager];</span><br><span class="line"></span><br><span class="line">[operationManager GET:<span class="string">@" "</span> parameters:<span class="literal">nil</span></span><br><span class="line">success:^(AFHTTPRequestOperation *operation, <span class="keyword">id</span> responseObject) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"请求成功"</span>);</span><br><span class="line">&#125; failure:^(AFHTTPRequestOperation *operation, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"请求失败"</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>2.POST 请求</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AFHTTPRequestOperationManager *operationManager = [AFHTTPRequestOperationManager manager];</span><br><span class="line"></span><br><span class="line">[operationManager POST:<span class="string">@" "</span> parameters:<span class="literal">nil</span></span><br><span class="line">success:^(AFHTTPRequestOperation *operation, <span class="keyword">id</span> responseObject) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"请求成功"</span>);</span><br><span class="line">&#125; failure:^(AFHTTPRequestOperation *operation, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"请求失败"</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h2 id="三、AFNetworking3-0"><a href="#三、AFNetworking3-0" class="headerlink" title="三、AFNetworking3.0"></a>三、AFNetworking3.0</h2><p>1.GET 请求</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">AFHTTPSessionManager *sessionManager = [AFHTTPSessionManager manager];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析服务器返回的JSON数据</span></span><br><span class="line"><span class="comment">//        [AFJSONResponseSerializer serializer];</span></span><br><span class="line"><span class="comment">// 解析服务器返回的XML数据</span></span><br><span class="line"><span class="comment">//        [AFXMLParserResponseSerializer serializer];</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数1: 请求的网址</span></span><br><span class="line"><span class="comment">// 参数2: 参数</span></span><br><span class="line"><span class="comment">// 参数3: 当前的进度</span></span><br><span class="line"><span class="comment">// 参数4: 请求成功</span></span><br><span class="line"><span class="comment">// 参数5: 请求失败</span></span><br><span class="line">[sessionManager GET:<span class="string">@" "</span> parameters:<span class="literal">nil</span> progress:^(<span class="built_in">NSProgress</span> * _Nonnull downloadProgress) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"进度"</span>);</span><br><span class="line">&#125; success:^(<span class="built_in">NSURLSessionDataTask</span> * _Nonnull task, <span class="keyword">id</span>  _Nullable responseObject) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"请求成功"</span>);</span><br><span class="line">&#125; failure:^(<span class="built_in">NSURLSessionDataTask</span> * _Nullable task, <span class="built_in">NSError</span> * _Nonnull error) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"请求失败"</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>2.POST 请求<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建管理者对象</span></span><br><span class="line">AFHTTPSessionManager *sessionManager = [AFHTTPSessionManager manager];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置请求参数</span></span><br><span class="line"><span class="built_in">NSString</span> *urlStr = <span class="string">@" "</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要设置 body 体</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *dic = @&#123;<span class="string">@" "</span> : <span class="string">@" "</span>,<span class="string">@" "</span> : <span class="string">@" "</span>&#125;;</span><br><span class="line"></span><br><span class="line">[sessionManager POST:urlStr parameters:dic progress:^(<span class="built_in">NSProgress</span> * _Nonnull downloadProgress) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"进度"</span>);</span><br><span class="line">&#125; success:^(<span class="built_in">NSURLSessionDataTask</span> * _Nonnull task, <span class="keyword">id</span>  _Nullable responseObject) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"请求成功"</span>);</span><br><span class="line">&#125; failure:^(<span class="built_in">NSURLSessionDataTask</span> * _Nullable task, <span class="built_in">NSError</span> * _Nonnull error) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"请求失败"</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>上面的一些代码都是基础性代码，因此也没怎么做注释，如果有疑问的话可以私信交流…另外代码有什么问题的话也希望大家能够指出！谢谢大家！</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之 - MD5加密/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之 - MD5加密/" itemprop="url">
                  iOS开发之 - MD5加密
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>MD5（消息摘要算法第五版）是计算机安全领域广泛使用的一种散列函数，用以提供消息的完整性保护。</p>
</blockquote>
<ul>
<li><p>MD5特点：<br>1、压缩性：任意长度的数据，算出的MD5值长度都是固定的。<br>2、容易计算：从原数据计算出MD5值很容易。<br>3、抗修改性：对原数据进行任何改动，哪怕只修改1个字节，所得到的MD5值都有很大区别。<br>4、强抗碰撞：已知原数据和其MD5值，想找到一个具有相同MD5值的数据（即伪造数据）是非常困难的。</p>
</li>
<li><p>事先介绍一个概念，因为下边有用到👇<br>加盐：所谓加盐， 就是在原本需要加密的信息基础上，糅入其它内容salt。</p>
</li>
<li><p>接下来是一些代码的实现，方便起见，这里创建了一个分类NSString+MD5。</p>
</li>
</ul>
<p>分类 NSString+MD5.h 中的代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSString</span> (<span class="title">MD5</span>)</span></span><br><span class="line"><span class="comment">/** 直接加密 */</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)MD5_32BIT;</span><br><span class="line"><span class="comment">/** 加盐 */</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)MD5_saltStr:(<span class="built_in">NSString</span> *)saltStr;</span><br><span class="line"><span class="comment">/** 多次加密 */</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)MD5_againStr:(<span class="built_in">NSString</span> *)againStr;</span><br><span class="line"><span class="comment">/** 乱序加密 */</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)MD5_Chaos:(<span class="built_in">NSString</span> *)chaosStr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>这里是分类 NSString+MD5.m 中的代码，需要导入头文件 #import &lt;CommonCrypto/CommonDigest.h&gt;：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"NSString+MD5.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;CommonCrypto/CommonDigest.h&gt;</span></span></span><br><span class="line"><span class="meta">#define salt @<span class="meta-string">"qwertyuiop"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSString</span> (<span class="title">MD5</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接加密</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)MD5_32BIT &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *cStr = [<span class="keyword">self</span> UTF8String];</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> digest[CC_MD5_DIGEST_LENGTH];</span><br><span class="line"></span><br><span class="line">CC_MD5( cStr, (CC_LONG)<span class="keyword">self</span>.length, digest );</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableString</span> *result = [<span class="built_in">NSMutableString</span> stringWithCapacity:CC_MD5_DIGEST_LENGTH * <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CC_MD5_DIGEST_LENGTH; i++)</span><br><span class="line">[result appendFormat:<span class="string">@"%02X"</span>, digest[i]];</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加盐</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)MD5_saltStr:(<span class="built_in">NSString</span> *)saltStr &#123;</span><br><span class="line"></span><br><span class="line">saltStr = [saltStr stringByAppendingString:salt];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *result =[saltStr MD5_32BIT];</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多次加密</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)MD5_againStr:(<span class="built_in">NSString</span> *)againStr &#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *result = [againStr MD5_32BIT];</span><br><span class="line"></span><br><span class="line">result = [result MD5_32BIT];</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 乱序加密</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)MD5_Chaos:(<span class="built_in">NSString</span> *)chaosStr &#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *result =[chaosStr MD5_32BIT];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *header =[result substringFromIndex:<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *footer=[result substringFromIndex:<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">result =[footer stringByAppendingString:header];</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>接着在控制器中调用：<br><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">import</span> <span class="string">"ViewController.h"</span></span><br><span class="line">#<span class="keyword">import</span> <span class="string">"NSString+MD5.h"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@implementation</span> ViewController</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">[<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">NSString *<span class="built_in">string</span> = @<span class="string">"10.24"</span>;</span><br><span class="line"><span class="comment">// 调用 MD5 加密并打印结果</span></span><br><span class="line">NSLog(@<span class="string">"MD5Result = %@"</span>, [<span class="built_in">string</span> MD5_32BIT]);</span><br><span class="line">NSLog(@<span class="string">"MD5_saltResult = %@"</span>, [<span class="built_in">string</span> MD5_saltStr:<span class="built_in">string</span>]);</span><br><span class="line">NSLog(@<span class="string">"MD5_againResult = %@"</span>, [<span class="built_in">string</span> MD5_againStr:<span class="built_in">string</span>]);</span><br><span class="line">NSLog(@<span class="string">"chaosResult = %@"</span>, [<span class="built_in">string</span> MD5_Chaos:<span class="built_in">string</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里是打印结果：<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2016-10-26</span> <span class="number">08</span>:<span class="number">15:49.616</span> md<span class="number">5[92278</span>:<span class="number">6185546</span>] MD5Result = F7F942B87C2D0B62FC27AD465CF0D05B</span><br><span class="line"><span class="number">2016-10-26</span> <span class="number">08</span>:<span class="number">15:49.616</span> md<span class="number">5[92278</span>:<span class="number">6185546</span>] MD5_saltResult = <span class="number">1</span>C2140C07ADD1E334896D499E8C4968C</span><br><span class="line"><span class="number">2016-10-26</span> <span class="number">08</span>:<span class="number">15:49.617</span> md<span class="number">5[92278</span>:<span class="number">6185546</span>] MD5_againResult = <span class="number">01</span>AE5309B5A8E672AE4D427FE987E06A</span><br><span class="line"><span class="number">2016-10-26</span> <span class="number">08</span>:<span class="number">15:49.617</span> md<span class="number">5[92278</span>:<span class="number">6185546</span>] chaosResult = F942B87C2D0B62FC27AD465CF0D05BF942B87C2D0B62FC27AD465CF0D05B</span><br></pre></td></tr></table></figure></p>
<hr>
<p>总结：大家应该都知道有一个MD5破解网站，名字叫做 <a href="http://www.cmd5.com" target="_blank" rel="noopener">md5在线解密加密</a>，因此我们在使用MD5加密的时候，最好使用多次加密，加盐，乱序加密等，不然会很容易被破解。至于其它加密，等以后用到了会继续整理出来，如果文章有什么不足之处，还请朋友们能过指出来，谢谢大家！</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之 - Runtime/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之 - Runtime/" itemprop="url">
                  iOS开发之 - Runtime
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/2665449-59759f8fb21bb6a9.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="iOS开发之 - Runtime"></p>
<blockquote>
<p>想总结 Runtime 不是一天两天了，前几天利用空闲时间已经打好文稿，但觉得还有需要改进的地方，现在已经改过来了，这里贴出来与大家分享下（如果还有什么小问题，还望各位朋友指出来哈）! 下面我们就开始进入运行时 Runtime 的世界吧！</p>
</blockquote>
<h2 id="一、Runtime简介"><a href="#一、Runtime简介" class="headerlink" title="一、Runtime简介"></a>一、Runtime简介</h2><p>Runtime简称运行时，是系统在运行的时候的一些机制，其中最主要的是消息机制。它是一套比较底层的纯 C 语言 API, 属于一个 C 语言库，包含了很多底层的 C 语言 API。我们平时编写的 OC 代码，在程序运行过程时，其实最终都是转成了 Runtime 的 C 语言代码。如下所示:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// OC代码:</span></span><br><span class="line"><span class="selector-attr">[Person coding]</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//运行时 runtime 会将它转化成 C 语言的代码:</span></span><br><span class="line"><span class="selector-tag">objc_msgSend</span>(Person, <span class="variable">@selector</span>(coding));</span><br></pre></td></tr></table></figure>
<h2 id="二、相关函数"><a href="#二、相关函数" class="headerlink" title="二、相关函数"></a>二、相关函数</h2><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历某个类所有的成员变量</span></span><br><span class="line"><span class="keyword">class</span><span class="number">_</span>copyIvarList</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历某个类所有的方法</span></span><br><span class="line"><span class="keyword">class</span><span class="number">_</span>copyMethodList</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取指定名称的成员变量</span></span><br><span class="line"><span class="keyword">class</span><span class="number">_</span>getInstanceVariable</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取成员变量名</span></span><br><span class="line">ivar<span class="number">_</span>getName</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取成员变量类型编码</span></span><br><span class="line">ivar<span class="number">_</span>getTypeEncoding</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取某个对象成员变量的值</span></span><br><span class="line"><span class="keyword">object</span><span class="number">_</span>getIvar</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置某个对象成员变量的值</span></span><br><span class="line"><span class="keyword">object</span><span class="number">_</span>setIvar</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给对象发送消息</span></span><br><span class="line">objc<span class="number">_m</span>sgSend</span><br></pre></td></tr></table></figure>
<h2 id="三、相关应用"><a href="#三、相关应用" class="headerlink" title="三、相关应用"></a>三、相关应用</h2><ul>
<li>1.利用Runtime遍历模型对象的所有属性</li>
<li>2.归档与解档</li>
<li>3.字典模型互转(利用 Runtime 遍历模型对象的所有属性, 根据属性名从字典中取出对的值,设置到模型的属性上)</li>
<li>4.动态添加/修改属性、动态添加/修改/替换方法(修改Person的身高体重等；替换 coding 方法为 eating 等)</li>
</ul>
<h2 id="四、演示代码"><a href="#四、演示代码" class="headerlink" title="四、演示代码"></a>四、演示代码</h2><h3 id="演示代码一：遍历对象的属性"><a href="#演示代码一：遍历对象的属性" class="headerlink" title="演示代码一：遍历对象的属性"></a>演示代码一：遍历对象的属性</h3><p>新建一个Person类，继承自NSObject，在.h文件中设置它的属性如下</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NNPerson</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line"><span class="built_in">NSString</span> * _str1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSString</span> * str2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *str3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSDictionary</span> * dict;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSArray</span> *ary;</span><br></pre></td></tr></table></figure>
<p>在 ViewController 中获取它的属性，代码如下</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"NNPerson.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">[<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 NNModel 中所有的变量并且输出变量名及类型</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">Ivar * ivars = class_copyIvarList([NNPerson <span class="keyword">class</span>], &amp;count);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i ++) &#123;</span><br><span class="line">Ivar ivar = ivars[i];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"类型: %s -名字: %s "</span>, ivar_getTypeEncoding(ivar), ivar_getName(ivar));</span><br><span class="line">&#125;</span><br><span class="line">free(ivars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="演示代码二：归档解档"><a href="#演示代码二：归档解档" class="headerlink" title="演示代码二：归档解档"></a>演示代码二：归档解档</h3><p>新建一个类，继承自 NSObject 。.m中的代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark -归档</span></span><br><span class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)aCoder &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//获取类中所有属性</span></span><br><span class="line">Ivar *vars = class_copyIvarList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;count);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i ++) &#123;</span><br><span class="line">Ivar var = vars[i];</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name = ivar_getName(var);</span><br><span class="line"><span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line"><span class="comment">//利用 KVC 进行取值，根据属性名称获取对应的值</span></span><br><span class="line"><span class="keyword">id</span> value = [<span class="keyword">self</span> valueForKey:key];</span><br><span class="line">[aCoder encodeObject:value forKey:key];</span><br><span class="line">&#125;</span><br><span class="line">free(vars);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -解档</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)aDecoder &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//获取类中所有属性</span></span><br><span class="line">Ivar *vars = class_copyIvarList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;count);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i ++) &#123;</span><br><span class="line">Ivar var = vars[i];</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name = ivar_getName(var);</span><br><span class="line"><span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line"></span><br><span class="line"><span class="comment">//进行解档取值</span></span><br><span class="line"><span class="keyword">id</span> value = [aDecoder decodeObjectForKey:key];</span><br><span class="line"></span><br><span class="line"><span class="comment">//利用 KVC 对属性赋值</span></span><br><span class="line">[<span class="keyword">self</span> setValue:value forKey:key];</span><br><span class="line">&#125;</span><br><span class="line">free(vars);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ViewController中的代码：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">[<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">LZNArchive *archive = [LZNArchive objectWithKeyValues:<span class="keyword">self</span>.Mydictionary];</span><br><span class="line"><span class="built_in">NSString</span> *path = <span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>).lastObject;</span><br><span class="line">path = [path stringByAppendingPathComponent:<span class="string">@"hello"</span>];</span><br><span class="line">[<span class="built_in">NSKeyedArchiver</span> archiveRootObject:archive toFile:path];</span><br><span class="line">LZNArchive *m = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithFile:path];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="演示代码三：字典与模型互转"><a href="#演示代码三：字典与模型互转" class="headerlink" title="演示代码三：字典与模型互转"></a>演示代码三：字典与模型互转</h3><p>首先应导入一个 plist 文件，将文件中的内容读取到字典中；然后新建一个分类如: NSObject+KeyValues<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark -字典转模型</span></span><br><span class="line"></span><br><span class="line">+(<span class="keyword">instancetype</span>)objectWithDict:(<span class="built_in">NSDictionary</span> *)dict &#123;</span><br><span class="line"><span class="keyword">id</span> objc = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line"></span><br><span class="line"><span class="comment">//遍历字典中的属性</span></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> *key <span class="keyword">in</span> dict.allKeys) &#123;</span><br><span class="line"><span class="keyword">id</span> value = dict[key];</span><br><span class="line">objc_property_t property = class_getProperty(<span class="keyword">self</span>, key.UTF8String);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">objc_property_attribute_t *attributeList = property_copyAttributeList(property, &amp;count);</span><br><span class="line">objc_property_attribute_t attribute = attributeList[<span class="number">0</span>];</span><br><span class="line"><span class="built_in">NSString</span> *string = [<span class="built_in">NSString</span> stringWithUTF8String:attribute.value];</span><br><span class="line"><span class="keyword">if</span> ([string isEqualToString:<span class="string">@"@\"LZNArchive\""</span>]) &#123;</span><br><span class="line">value = [<span class="keyword">self</span> objectWithDict:value];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//生成 setter 方法，并用 objc_msgSend 调用</span></span><br><span class="line"><span class="built_in">NSString</span> *methodName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"set%@%@:"</span>,[key substringToIndex:<span class="number">1</span>].uppercaseString,[key substringFromIndex:<span class="number">1</span>]];</span><br><span class="line">SEL <span class="keyword">setter</span> = sel_registerName(methodName.UTF8String);</span><br><span class="line"><span class="keyword">if</span> ([objc respondsToSelector:<span class="keyword">setter</span>]) &#123;</span><br><span class="line">((<span class="keyword">void</span> (*) (<span class="keyword">id</span>,SEL,<span class="keyword">id</span>)) objc_msgSend) (objc,<span class="keyword">setter</span>,value);</span><br><span class="line">&#125;</span><br><span class="line">free(attributeList);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> objc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -模型转字典</span></span><br><span class="line">-(<span class="built_in">NSDictionary</span> *)keyValuesWithObject &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">objc_property_t *propertyList = class_copyPropertyList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;count);</span><br><span class="line"><span class="built_in">NSMutableDictionary</span> *dict = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line"></span><br><span class="line"><span class="comment">//遍历模型中属性</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i ++) &#123;</span><br><span class="line">objc_property_t property = propertyList[i];</span><br><span class="line"></span><br><span class="line"><span class="comment">//生成 getter 方法，并用 objc_msgSend 调用</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *propertyName = property_getName(property);</span><br><span class="line">SEL <span class="keyword">getter</span> = sel_registerName(propertyName);</span><br><span class="line"><span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:<span class="keyword">getter</span>]) &#123;</span><br><span class="line"><span class="keyword">id</span> value = ((<span class="keyword">id</span> (*) (<span class="keyword">id</span>,SEL)) objc_msgSend) (<span class="keyword">self</span>,<span class="keyword">getter</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断当前属性</span></span><br><span class="line"><span class="keyword">if</span> ([value isKindOfClass:[<span class="keyword">self</span> <span class="keyword">class</span>]] &amp;&amp; value) &#123;</span><br><span class="line">value = [value keyValuesWithObject];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (value) &#123;</span><br><span class="line"><span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:propertyName];</span><br><span class="line">[dict setObject:value forKey:key];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">free(propertyList);</span><br><span class="line"><span class="keyword">return</span> dict;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="演示代码四：objc-msgSend-消息传递"><a href="#演示代码四：objc-msgSend-消息传递" class="headerlink" title="演示代码四：objc_msgSend 消息传递"></a>演示代码四：objc_msgSend 消息传递</h3><p>新建一个类，继承自NSObject，.m中的代码如下:<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sayHello &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"Hello!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)showName:(<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"My name is %@"</span>,name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)showAge:(<span class="built_in">NSInteger</span>)age &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"My age is %ld"</span>, age);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">float</span>)showHeight&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">180.0</span>f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="built_in">NSString</span> *)showInformation &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">@"Nice to meet you!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ViewController中的代码:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">LZN_msgSend *msgSend = [[LZN_msgSend alloc] init];</span><br><span class="line">((<span class="keyword">void</span> (*) (<span class="keyword">id</span>, SEL)) objc_msgSend) (msgSend, sel_registerName(<span class="string">"sayHello"</span>));</span><br><span class="line"></span><br><span class="line">((<span class="keyword">void</span> (*) (<span class="keyword">id</span>, SEL, <span class="built_in">NSString</span> *)) objc_msgSend) (msgSend, sel_registerName(<span class="string">"showName:"</span>), <span class="string">@"Liu Zhong Ning"</span>);</span><br><span class="line"></span><br><span class="line">((<span class="keyword">void</span> (*) (<span class="keyword">id</span>, SEL, <span class="built_in">NSInteger</span>)) objc_msgSend) (msgSend, sel_registerName(<span class="string">"showAge:"</span>), <span class="number">23</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> f = ((<span class="keyword">float</span> (*) (<span class="keyword">id</span>, SEL)) objc_msgSend_fpret) (msgSend, sel_registerName(<span class="string">"showHeight"</span>));</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"and height is %.2fcm"</span>,f);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *information = ((<span class="built_in">NSString</span>* (*) (<span class="keyword">id</span>, SEL)) objc_msgSend) (msgSend, sel_registerName(<span class="string">"showInformation"</span>));</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,information);</span><br></pre></td></tr></table></figure></p>
<p><em>the end</em></p>
<hr>
<p><strong>结束语：Runtime 相关的知识就整理了这么些，希望对看到的朋友们有用！另外如果 demo 有什么问题，还烦请大家告知，一起进步！谢谢O(∩_∩)O~! 另祝大家周末愉快哈！</strong></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之 - SDWebImage 的使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之 - SDWebImage 的使用/" itemprop="url">
                  iOS开发之 - SDWebImage 的使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/2665449-6e9f0fccaeeca1e8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="SDWebImage"></p>
<blockquote>
<p><a href="https://github.com/rs/SDWebImage" target="_blank" rel="noopener">SDWebImage</a> 是一个开源的第三方库，在我们 iOS 开发中用到 SDWebImage 的地方有很多，比如在 tableView 中，在 collectionView 中……不然它也不会高达 16000+ 这么多的 Star 了😄。下面是总结的一些 SDWebImage 相关的具体用法。</p>
</blockquote>
<p>首先用 cocoapods 导入 SDWebImage 框架，网上有很多安装以及使用 cocoapods 的教程，在此就不累述了，这篇文章的内容是在导入 SDWebImage 基础之上的，主要是总结了一些 SDWebImage 的具体用法。</p>
<ul>
<li><p>简单下载图片</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">方式一：</span><br><span class="line"><span class="comment">// 只下载图片</span></span><br><span class="line">[self.imageView <span class="string">sd_setImageWithURL:</span>@<span class="string">"URL地址"</span>]];</span><br><span class="line"></span><br><span class="line">方式二：</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">第一个参数:图片的url</span></span><br><span class="line"><span class="comment">第二个参数:占位图片</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">[self.imageView <span class="string">sd_setImageWithURL:</span>[NSURL <span class="string">URLWithString:</span>@<span class="string">"URL地址"</span>]</span><br><span class="line"><span class="string">placeholderImage:</span>[UIImage <span class="string">imageNamed:</span> @<span class="string">"占位图片名"</span>]];</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载成功或失败之后做的事情</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">方式一：</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">第一个参数:图片的url</span></span><br><span class="line"><span class="comment">block:下载成功或失败之后的回调</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">[<span class="keyword">self</span>.imageView sd_setImageWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"URL地址"</span>]</span><br><span class="line">completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">NSURL</span> *imageURL) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"下载成功或失败之后的回调"</span>);</span><br><span class="line">&#125;];</span><br><span class="line">方式二：</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">第一个参数:图片的url</span></span><br><span class="line"><span class="comment">第二个参数:占位图片</span></span><br><span class="line"><span class="comment">block:下载成功或失败之后的回调</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">[<span class="keyword">self</span>.imageView sd_setImageWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"URL地址"</span>]</span><br><span class="line">placeholderImage:[<span class="built_in">UIImage</span> imageNamed: <span class="string">@"占位图片名"</span>]</span><br><span class="line">completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">NSURL</span> *imageURL) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"下载成功或失败之后的回调"</span>);</span><br><span class="line">&#125;];</span><br><span class="line">方式三：</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">第一个参数:图片的url</span></span><br><span class="line"><span class="comment">第二个参数:占位图片</span></span><br><span class="line"><span class="comment">第三个参数:下载图片的策略</span></span><br><span class="line"><span class="comment">第四个参数:progress进度</span></span><br><span class="line"><span class="comment">第五个参数:completed 下载完成之后的回调</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">[<span class="keyword">self</span>.imageView sd_setImageWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"URL地址"</span>]</span><br><span class="line">placeholderImage:[<span class="built_in">UIImage</span> imageNamed: <span class="string">@"占位图片名"</span>]</span><br><span class="line">options:SDWebImageRetryFailed</span><br><span class="line">progress:^(<span class="built_in">NSInteger</span> receivedSize, <span class="built_in">NSInteger</span> expectedSize) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"progress进度"</span>);</span><br><span class="line">&#125;</span><br><span class="line">completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">NSURL</span> *imageURL) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"下载成功或失败之后的回调"</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
</li>
<li><p>借用一个方法简单的介绍一下 options 中的选项</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"><span class="comment">//失败后重试</span></span><br><span class="line">SDWebImageRetryFailed = <span class="number">1</span> &lt;&lt; <span class="number">0</span>,</span><br><span class="line"><span class="comment">//UI交互期间开始下载，导致延迟下载比如UIScrollView减速。</span></span><br><span class="line">SDWebImageLowPriority = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,</span><br><span class="line"><span class="comment">//只进行内存缓存</span></span><br><span class="line">SDWebImageCacheMemoryOnly = <span class="number">1</span> &lt;&lt; <span class="number">2</span>,</span><br><span class="line"><span class="comment">//这个标志可以渐进式下载,显示的图像是逐步在下载</span></span><br><span class="line">SDWebImageProgressiveDownload = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,</span><br><span class="line"><span class="comment">//刷新缓存</span></span><br><span class="line">SDWebImageRefreshCached = <span class="number">1</span> &lt;&lt; <span class="number">4</span>,</span><br><span class="line"><span class="comment">//后台下载</span></span><br><span class="line">SDWebImageContinueInBackground = <span class="number">1</span> &lt;&lt; <span class="number">5</span>,</span><br><span class="line"><span class="comment">//NSMutableURLRequest.HTTPShouldHandleCookies = YES;</span></span><br><span class="line">SDWebImageHandleCookies = <span class="number">1</span> &lt;&lt; <span class="number">6</span>,</span><br><span class="line"><span class="comment">//允许使用无效的SSL证书</span></span><br><span class="line"><span class="comment">//SDWebImageAllowInvalidSSLCertificates = 1 &lt;&lt; 7,</span></span><br><span class="line"><span class="comment">//优先下载</span></span><br><span class="line">SDWebImageHighPriority = <span class="number">1</span> &lt;&lt; <span class="number">8</span>,</span><br><span class="line"><span class="comment">//延迟占位符</span></span><br><span class="line">SDWebImageDelayPlaceholder = <span class="number">1</span> &lt;&lt; <span class="number">9</span>,</span><br><span class="line"><span class="comment">//改变动画形象</span></span><br><span class="line">SDWebImageTransformAnimatedImage = <span class="number">1</span> &lt;&lt; <span class="number">10</span>,</span><br><span class="line">*/</span><br><span class="line">[self.imageView sd_setImageWithURL:[NSURL URLWithString:@<span class="string">"URL地址"</span>]</span><br><span class="line">placeholderImage:[UIImage imageNamed: @<span class="string">"占位图片名"</span>]</span><br><span class="line">options:SDWebImageRetryFailed];</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 SDWebImageManager 下载图片</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SDWebImageManager *imageManager = [SDWebImageManager sharedManager];</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">第一个参数:图片的url</span></span><br><span class="line"><span class="comment">第二个参数:下载图片的(策略)</span></span><br><span class="line"><span class="comment">第三个参数:progress进度</span></span><br><span class="line"><span class="comment">第四个参数:completed 下载完成之后的回调</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">[imageManager downloadImageWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"URL地址"</span>]</span><br><span class="line">options:SDWebImageRetryFailed</span><br><span class="line">progress:^(<span class="built_in">NSInteger</span> receivedSize, <span class="built_in">NSInteger</span> expectedSize) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"progress进度"</span>);</span><br><span class="line">&#125;</span><br><span class="line">completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">BOOL</span> finished, <span class="built_in">NSURL</span> *imageURL) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"下载成功或失败之后的回调"</span>);</span><br><span class="line"><span class="keyword">if</span> (image) &#123;</span><br><span class="line"><span class="keyword">self</span>.image = image;</span><br><span class="line">&#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 SDWebImageDownloader 下载图片</p>
</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SDWebImageDownloader *imageDownloader = [SDWebImageDownloader sharedDownloader];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">第一个参数:图片的url</span></span><br><span class="line"><span class="comment">第二个参数:下载图片的策略</span></span><br><span class="line"><span class="comment">第三个参数:progressBlock 进度</span></span><br><span class="line"><span class="comment">第四个参数:completedBlock 下载完成之后的回调</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">[imageDownloader downloadImageWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"URL地址"</span>]</span><br><span class="line">options:SDWebImageDownloaderLowPriority</span><br><span class="line">progress:^(<span class="built_in">NSInteger</span> receivedSize, <span class="built_in">NSInteger</span> expectedSize) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"progress进度"</span>);</span><br><span class="line">&#125;</span><br><span class="line">completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *error, <span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"下载成功或失败之后的回调"</span>);</span><br><span class="line"><span class="keyword">if</span> (image) &#123;</span><br><span class="line"><span class="keyword">self</span>.image = image;</span><br><span class="line">&#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<ul>
<li>内存警告时调用</li>
</ul>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当程序收到内存警告时会调用这个方法</span></span><br><span class="line">- (<span class="keyword">void</span>)didReceiveMemoryWarning &#123;</span><br><span class="line">[<span class="meta">super didReceiveMemoryWarning</span>];</span><br><span class="line"><span class="comment">// 清除缓存</span></span><br><span class="line">[<span class="meta">[SDWebImageManager sharedManager</span>].imageCache clearDisk]; <span class="comment">// clean:删除过期缓存</span></span><br><span class="line">[<span class="meta">[SDWebImageManager sharedManager</span>].imageCache cleanDisk]; <span class="comment">// clear:直接删除然后重新创建</span></span><br><span class="line"><span class="comment">// 取消下载</span></span><br><span class="line">[<span class="meta">[SDWebImageManager sharedManager</span>] cancelAll];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其它一些很有用的方法</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 取消掉当前所有的下载</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">cancelAll</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否有图片在下载</span></span><br><span class="line"><span class="selector-tag">-</span> (BOOL)<span class="selector-tag">isRunning</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将图片存入cache的方法</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">saveImageToCache</span><span class="selector-pseudo">:(UIImage</span> *)<span class="selector-tag">image</span> <span class="selector-tag">forURL</span><span class="selector-pseudo">:(NSURL</span> *)<span class="selector-tag">url</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过图片的url判断其是否已经存在</span></span><br><span class="line"><span class="selector-tag">-</span> (BOOL)<span class="selector-tag">cachedImageExistsForURL</span><span class="selector-pseudo">:(NSURL</span> *)<span class="selector-tag">url</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测一个image是否已经被缓存到磁盘(是否存且仅存在disk里).</span></span><br><span class="line"><span class="selector-tag">-</span> (BOOL)<span class="selector-tag">diskImageExistsForURL</span><span class="selector-pseudo">:(NSURL</span> *)<span class="selector-tag">url</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果检测到图片已经被缓存,那么执行回调block</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">cachedImageExistsForURL</span><span class="selector-pseudo">:(NSURL</span> *)<span class="selector-tag">url</span></span><br><span class="line"><span class="selector-tag">completion</span><span class="selector-pseudo">:(SDWebImageCheckCacheCompletionBlock)completionBlock</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果检测到图片已经在磁盘中,那么执行回调block</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">diskImageExistsForURL</span><span class="selector-pseudo">:(NSURL</span> *)<span class="selector-tag">url</span></span><br><span class="line"><span class="selector-tag">completion</span><span class="selector-pseudo">:(SDWebImageCheckCacheCompletionBlock)completionBlock</span>;</span><br></pre></td></tr></table></figure>
<p>以上是关于 SDWebImage 的一些用法总结，以后再用到其它的了，会再来补充。另外如果有写错的地方，欢迎朋友们指正！谢谢😊！</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之 - WKWebView VS UIWebView/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之 - WKWebView VS UIWebView/" itemprop="url">
                  iOS开发之 - WKWebView VS UIWebView
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>WKWebView是苹果在 iOS 8 中推出的新框架，相比UIWebView来说，WKWebView 性能好，速度快，内存小，功能多，且支持了更多的 HTML5 特性……因此本小白禁不住“诱惑”利用了一晚上的时间，整理了一些关于 WKWebView 的资料，与大家分享下！在说 WKWebView 之前，我们先说说他的老大哥 UIWebView ！！！</p>
</blockquote>
<p>UIWebView 是苹果在 iOS 2 之后推出的，由于资格比较“老”，大家对 UIWebView 应该也不会陌生，这里直接上代码：</p>
<h3 id="1-UIWebView-基本使用"><a href="#1-UIWebView-基本使用" class="headerlink" title="1.UIWebView 基本使用"></a>1.UIWebView 基本使用</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建webview</span></span><br><span class="line"><span class="built_in">UIWebView</span> *webView = [[<span class="built_in">UIWebView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">20</span>, NNWidth, NNHeight - <span class="number">20</span>)];</span><br><span class="line"><span class="comment">// 网络请求</span></span><br><span class="line"><span class="built_in">NSURLRequest</span> *request =[<span class="built_in">NSURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://www.baidu.com"</span>]];</span><br><span class="line"><span class="comment">// 加载网页</span></span><br><span class="line">[webView loadRequest:request];</span><br><span class="line"><span class="comment">// 添加到界面</span></span><br><span class="line">[<span class="keyword">self</span>.view addSubview:webView];</span><br></pre></td></tr></table></figure>
<h3 id="2-UIWebView-常用方法"><a href="#2-UIWebView-常用方法" class="headerlink" title="2.UIWebView 常用方法"></a>2.UIWebView 常用方法</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">webView reload</span>]; <span class="comment">// 刷新</span></span><br><span class="line">[<span class="meta">webView stopLoading</span>]; <span class="comment">// 停止加载</span></span><br><span class="line">[<span class="meta">webView goBack</span>]; <span class="comment">// 后退</span></span><br><span class="line">[<span class="meta">webView goForward</span>]; <span class="comment">// 前进</span></span><br><span class="line">[<span class="meta">webView canGoBack</span>]; <span class="comment">// 是否可以后退</span></span><br><span class="line">[<span class="meta">webView canGoForward</span>]; <span class="comment">// 是否可以向前</span></span><br><span class="line">[<span class="meta">webView isLoading</span>]; <span class="comment">// 是否正在加载</span></span><br></pre></td></tr></table></figure>
<h3 id="3-UIWebView-相关代理协议"><a href="#3-UIWebView-相关代理协议" class="headerlink" title="3.UIWebView 相关代理协议"></a>3.UIWebView 相关代理协议</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - UIWebViewDelegate</span></span><br><span class="line"><span class="comment">/// 是否允许加载网页</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)webView:(<span class="built_in">UIWebView</span> *)webView shouldStartLoadWithRequest:(<span class="built_in">NSURLRequest</span> *)request navigationType:(<span class="built_in">UIWebViewNavigationType</span>)navigationType &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"允许加载网页"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 开始加载网页时调用</span></span><br><span class="line">- (<span class="keyword">void</span>)webViewDidStartLoad:(<span class="built_in">UIWebView</span> *)webView &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"开始加载网页"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// 网页加载完成时调用</span></span><br><span class="line">- (<span class="keyword">void</span>)webViewDidFinishLoad:(<span class="built_in">UIWebView</span> *)webView &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"网页加载完成"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 网页加载错误时调用</span></span><br><span class="line">- (<span class="keyword">void</span>)webView:(<span class="built_in">UIWebView</span> *)webView didFailLoadWithError:(<span class="built_in">NSError</span> *)error &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"网页加载错误时调用"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="这里是-UIWebView-的效果图！！！"><a href="#这里是-UIWebView-的效果图！！！" class="headerlink" title="这里是 UIWebView 的效果图！！！"></a>这里是 UIWebView 的效果图！！！</h3><p><img src="http://upload-images.jianshu.io/upload_images/2665449-ab410b93f7c4d753.gif?imageMogr2/auto-orient/strip" alt="UIWebView加载网页"><br><img src="http://upload-images.jianshu.io/upload_images/2665449-14ead660659b5a2b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="代理方法输出的顺序"></p>
<h3 id="因为主要想与大家分享的是-WKWebView，所以对-UIWebView-的介绍就到此为止了。接下来的-WKWebView-才是今晚的主角！！！"><a href="#因为主要想与大家分享的是-WKWebView，所以对-UIWebView-的介绍就到此为止了。接下来的-WKWebView-才是今晚的主角！！！" class="headerlink" title="因为主要想与大家分享的是 WKWebView，所以对 UIWebView 的介绍就到此为止了。接下来的 WKWebView 才是今晚的主角！！！"></a>因为主要想与大家分享的是 WKWebView，所以对 UIWebView 的介绍就到此为止了。接下来的 WKWebView 才是今晚的主角！！！</h3><hr>
<p><strong>依然是先介绍 WKWebView 的基本使用</strong></p>
<h3 id="1-WKWebView-基本使用"><a href="#1-WKWebView-基本使用" class="headerlink" title="1. WKWebView 基本使用"></a>1. WKWebView 基本使用</h3><blockquote>
<p>这里加一个不用提示的提示：WKWebView 和 UIWebview 的基本使用方法相类似，但是需要导入头文件 #import &lt;WebKit/WebKit.h&gt;，其它步骤如下</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建webview</span></span><br><span class="line"><span class="built_in">WKWebView</span> *webView = [[<span class="built_in">WKWebView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">20</span>, NNWidth, NNHeight - <span class="number">20</span>)];</span><br><span class="line"><span class="comment">// 创建请求</span></span><br><span class="line"><span class="built_in">NSURLRequest</span> *request =[<span class="built_in">NSURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://www.baidu.com"</span>]];</span><br><span class="line"><span class="comment">// 加载网页</span></span><br><span class="line">[webView loadRequest:request];</span><br><span class="line"><span class="comment">// 将webView添加到界面</span></span><br><span class="line">[<span class="keyword">self</span>.view addSubview:webView];</span><br></pre></td></tr></table></figure>
<p>ps:这里就不再补充效果图了，除了速度内存优于 UIWebView，显示的效果差不多。。。</p>
<h3 id="2-WKWebView-加载文件"><a href="#2-WKWebView-加载文件" class="headerlink" title="2. WKWebView 加载文件"></a>2. WKWebView 加载文件</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建webview</span></span><br><span class="line"><span class="built_in">WKWebView</span> *webView = [[<span class="built_in">WKWebView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">20</span>, NNWidth, NNHeight - <span class="number">20</span>)];</span><br><span class="line"><span class="comment">// 创建url(可以随便从桌面拉张图片)</span></span><br><span class="line"><span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> fileURLWithPath:<span class="string">@"/Users/ios/Desktop/图片/90416596477f347431a929dc73b9f404.jpg"</span>];</span><br><span class="line"><span class="comment">// 加载文件</span></span><br><span class="line">[webView loadFileURL:url allowingReadAccessToURL:url];</span><br><span class="line"><span class="comment">// 最后将webView添加到界面</span></span><br><span class="line">[<span class="keyword">self</span>.view addSubview:webView];</span><br></pre></td></tr></table></figure>
<h4 id="这里是加载文件效果图！"><a href="#这里是加载文件效果图！" class="headerlink" title="这里是加载文件效果图！"></a>这里是加载文件效果图！</h4><p><img src="http://upload-images.jianshu.io/upload_images/2665449-026af846596935f2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="加载本地图片"></p>
<h3 id="3-WKWebView-与-JS-代码交互"><a href="#3-WKWebView-与-JS-代码交互" class="headerlink" title="3. WKWebView 与 JS 代码交互"></a>3. WKWebView 与 JS 代码交互</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 图片缩放的 JS 代码</span></span><br><span class="line"><span class="built_in">NSString</span> *JSImage = <span class="string">@"var count = document.images.length;for (var i = 0; i &lt; count; i++) &#123;var image = document.images[i];image.style.width=375;&#125;;window.alert('找到' + count + '张图');"</span>;</span><br><span class="line"><span class="comment">// 初始化 WKUserScript</span></span><br><span class="line"><span class="built_in">WKUserScript</span> *script = [[<span class="built_in">WKUserScript</span> alloc] initWithSource:JSImage injectionTime:<span class="built_in">WKUserScriptInjectionTimeAtDocumentEnd</span> forMainFrameOnly:<span class="literal">YES</span>];</span><br><span class="line"><span class="comment">// 初始化WKWebViewConfiguration</span></span><br><span class="line"><span class="built_in">WKWebViewConfiguration</span> *configuration = [[<span class="built_in">WKWebViewConfiguration</span> alloc] init];</span><br><span class="line">[configuration.userContentController addUserScript:script];</span><br><span class="line">_webView = [[<span class="built_in">WKWebView</span> alloc] initWithFrame:<span class="keyword">self</span>.view.bounds configuration:configuration];</span><br><span class="line"><span class="comment">// 这里需要从网上找到一张图片的地址</span></span><br><span class="line">[_webView loadHTMLString:<span class="string">@"&lt;head&gt;&lt;/head&gt;![](http://upload-images.jianshu.io/upload_images/2665449-f109bc70619e2a92.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)"</span>baseURL:<span class="literal">nil</span>];</span><br><span class="line">[<span class="keyword">self</span>.view addSubview:_webView];</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-311830759271b58f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="与 JS 交互效果图"></p>
<h3 id="4-WKWebView-常用的代理协议"><a href="#4-WKWebView-常用的代理协议" class="headerlink" title="4. WKWebView 常用的代理协议"></a>4. WKWebView 常用的代理协议</h3><p><em>WKWebView 的代理方法还是蛮有趣的，大家可以试下哈！</em></p>
<h4 id="4-1-WKNavigationDelegate-协议"><a href="#4-1-WKNavigationDelegate-协议" class="headerlink" title="4.1 WKNavigationDelegate 协议"></a>4.1 WKNavigationDelegate 协议</h4><p>这里简单罗列了几个常用的方法。以下四个与 UIWebView 中的方法相同：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#pragma</span> <span class="selector-tag">mark</span> <span class="selector-tag">-</span> <span class="selector-tag">WKNavigationDelegate</span></span><br><span class="line"><span class="comment">// 页面开始加载时调用</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">webView</span><span class="selector-pseudo">:(WKWebView</span> *)<span class="selector-tag">webView</span> <span class="selector-tag">didStartProvisionalNavigation</span><span class="selector-pseudo">:(WKNavigation</span> *)<span class="selector-tag">navigation</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 内容开始返回时调用</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">webView</span><span class="selector-pseudo">:(WKWebView</span> *)<span class="selector-tag">webView</span> <span class="selector-tag">didCommitNavigation</span><span class="selector-pseudo">:(WKNavigation</span> *)<span class="selector-tag">navigation</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 页面加载完成时调用</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">webView</span><span class="selector-pseudo">:(WKWebView</span> *)<span class="selector-tag">webView</span> <span class="selector-tag">didFinishNavigation</span><span class="selector-pseudo">:(WKNavigation</span> *)<span class="selector-tag">navigation</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 页面加载失败时调用</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">webView</span><span class="selector-pseudo">:(WKWebView</span> *)<span class="selector-tag">webView</span> <span class="selector-tag">didFailProvisionalNavigation</span><span class="selector-pseudo">:(WKNavigation</span> *)<span class="selector-tag">navigation</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>新增的三个代理方法:<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 这个方法是服务器重定向时调用，即 接收到服务器跳转请求之后调用</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">webView</span><span class="selector-pseudo">:(WKWebView</span> *)<span class="selector-tag">webView</span> <span class="selector-tag">didReceiveServerRedirectForProvisionalNavigation</span><span class="selector-pseudo">:(WKNavigation</span> *)<span class="selector-tag">navigation</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 在收到响应后，决定是否跳转</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">webView</span><span class="selector-pseudo">:(WKWebView</span> *)<span class="selector-tag">webView</span> <span class="selector-tag">decidePolicyForNavigationResponse</span><span class="selector-pseudo">:(WKNavigationResponse</span> *)<span class="selector-tag">navigationResponse</span> <span class="selector-tag">decisionHandler</span><span class="selector-pseudo">:(void</span> (^)(WKNavigationResponsePolicy))<span class="selector-tag">decisionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 在发送请求之前，决定是否跳转</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">webView</span><span class="selector-pseudo">:(WKWebView</span> *)<span class="selector-tag">webView</span> <span class="selector-tag">decidePolicyForNavigationAction</span><span class="selector-pseudo">:(WKNavigationAction</span> *)<span class="selector-tag">navigationAction</span> <span class="selector-tag">decisionHandler</span><span class="selector-pseudo">:(void</span> (^)(WKNavigationActionPolicy))<span class="selector-tag">decisionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="4-2-WKUIDelegate-协议"><a href="#4-2-WKUIDelegate-协议" class="headerlink" title="4.2 WKUIDelegate 协议"></a>4.2 WKUIDelegate 协议</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#pragma</span> <span class="selector-tag">mark</span> <span class="selector-tag">-</span> <span class="selector-tag">WKUIDelegate</span></span><br><span class="line"><span class="comment">/// 创建一个新的WebView</span></span><br><span class="line"><span class="selector-tag">-</span> (WKWebView *)<span class="selector-tag">webView</span><span class="selector-pseudo">:(WKWebView</span> *)<span class="selector-tag">webView</span> <span class="selector-tag">createWebViewWithConfiguration</span><span class="selector-pseudo">:(WKWebViewConfiguration</span> *)<span class="selector-tag">configuration</span> <span class="selector-tag">forNavigationAction</span><span class="selector-pseudo">:(WKNavigationAction</span> *)<span class="selector-tag">navigationAction</span> <span class="selector-tag">windowFeatures</span><span class="selector-pseudo">:(WKWindowFeatures</span> *)<span class="selector-tag">windowFeatures</span> &#123;</span><br><span class="line"><span class="selector-tag">return</span> <span class="selector-tag">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*  web界面中有弹出警告框时调用</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*  @param webView           实现该代理的webview</span></span><br><span class="line"><span class="comment">*  @param message           警告框中的内容</span></span><br><span class="line"><span class="comment">*  @param frame             主窗口</span></span><br><span class="line"><span class="comment">*  @param completionHandler 警告框消失调用</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">webView</span><span class="selector-pseudo">:(WKWebView</span> *)<span class="selector-tag">webView</span> <span class="selector-tag">runJavaScriptAlertPanelWithMessage</span><span class="selector-pseudo">:(NSString</span> *)<span class="selector-tag">message</span> <span class="selector-tag">initiatedByFrame</span><span class="selector-pseudo">:(void</span> (^)())<span class="selector-tag">completionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 输入框</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">webView</span><span class="selector-pseudo">:(WKWebView</span> *)<span class="selector-tag">webView</span> <span class="selector-tag">runJavaScriptTextInputPanelWithPrompt</span><span class="selector-pseudo">:(NSString</span> *)<span class="selector-tag">prompt</span> <span class="selector-tag">defaultText</span><span class="selector-pseudo">:(nullable</span> <span class="selector-tag">NSString</span> *)<span class="selector-tag">defaultText</span> <span class="selector-tag">initiatedByFrame</span><span class="selector-pseudo">:(WKFrameInfo</span> *)<span class="selector-tag">frame</span> <span class="selector-tag">completionHandler</span><span class="selector-pseudo">:(void</span> (^)(NSString * __nullable result))<span class="selector-tag">completionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// 确认框</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">webView</span><span class="selector-pseudo">:(WKWebView</span> *)<span class="selector-tag">webView</span> <span class="selector-tag">runJavaScriptConfirmPanelWithMessage</span><span class="selector-pseudo">:(NSString</span> *)<span class="selector-tag">message</span> <span class="selector-tag">initiatedByFrame</span><span class="selector-pseudo">:(WKFrameInfo</span> *)<span class="selector-tag">frame</span> <span class="selector-tag">completionHandler</span><span class="selector-pseudo">:(void</span> (^)(BOOL result))<span class="selector-tag">completionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// 警告框</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">webView</span><span class="selector-pseudo">:(WKWebView</span> *)<span class="selector-tag">webView</span> <span class="selector-tag">runJavaScriptAlertPanelWithMessage</span><span class="selector-pseudo">:(NSString</span> *)<span class="selector-tag">message</span> <span class="selector-tag">initiatedByFrame</span><span class="selector-pseudo">:(WKFrameInfo</span> *)<span class="selector-tag">frame</span> <span class="selector-tag">completionHandler</span><span class="selector-pseudo">:(void</span> (^)(void))<span class="selector-tag">completionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-另外搜集了一些-WKWebView-常用的属性："><a href="#5-另外搜集了一些-WKWebView-常用的属性：" class="headerlink" title="5.另外搜集了一些 WKWebView 常用的属性："></a>5.另外搜集了一些 WKWebView 常用的属性：</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">•    <span class="string">WKBackForwardListItem:</span> webview中后退列表里的某一个网页。</span><br><span class="line">•    <span class="string">WKFrameInfo:</span> 包含一个网页的布局信息。</span><br><span class="line">•    <span class="string">WKNavigation:</span> 包含一个网页的加载进度信息。</span><br><span class="line">•    <span class="string">WKPreferences:</span> 概括一个 webview 的偏好设置。</span><br><span class="line">•    <span class="string">WKProcessPool:</span> 表示一个 web 内容加载池。</span><br><span class="line">•    <span class="string">WKScriptMessage:</span> 包含网页发出的信息。</span><br><span class="line">•    <span class="string">WKUserScript:</span>表示可以被网页接受的用户脚本。</span><br><span class="line">•    <span class="string">WKWebViewConfiguration:</span> 初始化 webview 的设置。</span><br><span class="line">•    <span class="string">WKWindowFeatures:</span> 指定加载新网页时的窗口属性。</span><br><span class="line">•    <span class="string">WKScriptMessageHandler:</span> 提供从网页中收消息的回调方法。</span><br></pre></td></tr></table></figure>
<p>小尾巴:正像开头说的那样， WKWebView 相比UIWebView来说性能好，速度快，内存小，功能多……但现在开发中普遍用的还是 UIWebView，这是因为大多数App需要支持iOS7及以上的版本。但苹果之所以推出 WKWebView 就是为了弥补 UIWebView 的种种不足，逐渐取代 UIWebView，相信不久的将来，网页会成为 WKWebView 的天下！</p>
<p><em>今天就简单的写到这里，以后如果用到其它的了，再和大家分享😄!</em></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之 - 刷新框架 MJRefresh 的使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之 - 刷新框架 MJRefresh 的使用/" itemprop="url">
                  iOS开发之 - 刷新框架 MJRefresh 的使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/2665449-9e9c86ec592c3c2f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MJRefresh"></p>
<blockquote>
<p>下拉刷新控件目前比较火的有好几种，此前用过<a href="https://github.com/CoderMJLee/MJRefresh/blob/master/README.md" target="_blank" rel="noopener">MJRefresh</a> 和<a href="https://github.com/samvermette/SVPullToRefresh" target="_blank" rel="noopener"> SVPullToRefresh</a>，相对而言，还是觉得 MJRefresh 更好用！因此抽了些时间整理了 MJRefresh 的用法。以下是文章内容。。。</p>
</blockquote>
<h1 id="【文章目录】"><a href="#【文章目录】" class="headerlink" title="【文章目录】"></a>【文章目录】</h1><h2 id="一、类结构图"><a href="#一、类结构图" class="headerlink" title="一、类结构图"></a>一、类结构图</h2><ul>
<li>MJRefreshComponent.h</li>
<li>MJRefreshHeader.h</li>
<li>MJRefreshFooter.h</li>
<li>MJRefreshAutoFooter.h</li>
</ul>
<h2 id="二、参考例子"><a href="#二、参考例子" class="headerlink" title="二、参考例子"></a>二、参考例子</h2><ul>
<li>下拉刷新01-默认</li>
<li>下拉刷新02-动画图片</li>
<li>下拉刷新03-隐藏时间</li>
<li>下拉刷新04-隐藏状态和时间</li>
<li>下拉刷新05-自定义文字</li>
<li>下拉刷新06-自定义刷新控件</li>
<li>上拉刷新01-默认</li>
<li>上拉刷新02-动画图片</li>
<li>上拉刷新03-隐藏刷新状态的文字</li>
<li>上拉刷新04-全部加载完毕</li>
<li>上拉刷新05-自定义文字</li>
<li>上拉刷新06-加载后隐藏</li>
<li>上拉刷新07-自动回弹的上拉01</li>
<li>上拉刷新08-自动回弹的上拉02</li>
<li>上拉刷新09-自定义刷新控件(自动刷新)</li>
<li>上拉刷新10-自定义刷新控件(自动回弹)</li>
<li>UICollectionView01-上下拉刷新</li>
<li>UIWebView01-下拉刷新</li>
</ul>
<h1 id="【文章内容】"><a href="#【文章内容】" class="headerlink" title="【文章内容】"></a>【文章内容】</h1><h2 id="1-类结构图"><a href="#1-类结构图" class="headerlink" title="1.类结构图"></a>1.类结构图</h2><p><img src="http://upload-images.jianshu.io/upload_images/2665449-4a80291bb05b5283.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="类结构图"></p>
<h3 id="MJRefreshComponent-h"><a href="#MJRefreshComponent-h" class="headerlink" title="MJRefreshComponent.h"></a>MJRefreshComponent.h</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 刷新控件的基类 */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MJRefreshComponent</span> : <span class="title">UIView</span></span></span><br><span class="line"><span class="meta">#pragma mark - 刷新状态控制</span></span><br><span class="line"><span class="comment">/** 进入刷新状态 */</span></span><br><span class="line">- (<span class="keyword">void</span>)beginRefreshing;</span><br><span class="line"><span class="comment">/** 结束刷新状态 */</span></span><br><span class="line">- (<span class="keyword">void</span>)endRefreshing;</span><br><span class="line"><span class="comment">/** 是否正在刷新 */</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isRefreshing;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 其它</span></span><br><span class="line"><span class="comment">/** 根据拖拽比例自动切换透明度 */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>, <span class="keyword">getter</span>=isAutomaticallyChangeAlpha) <span class="built_in">BOOL</span> automaticallyChangeAlpha;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="MJRefreshHeader-h"><a href="#MJRefreshHeader-h" class="headerlink" title="MJRefreshHeader.h"></a>MJRefreshHeader.h</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MJRefreshHeader</span> : <span class="title">MJRefreshComponent</span></span></span><br><span class="line"><span class="comment">/** 创建 header */</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)headerWithRefreshingBlock:(MJRefreshComponentRefreshingBlock)refreshingBlock;</span><br><span class="line"><span class="comment">/** 创建 header */</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)headerWithRefreshingTarget:(<span class="keyword">id</span>)target refreshingAction:(SEL)action;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 这个 key 用来存储上一次下拉刷新成功的时间 */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *lastUpdatedTimeKey;</span><br><span class="line"><span class="comment">/** 上一次下拉刷新成功的时间 */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSDate</span> *lastUpdatedTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 忽略多少 scrollView 的 contentInset 的顶部 */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> ignoredScrollViewContentInsetTop;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="MJRefreshFooter-h"><a href="#MJRefreshFooter-h" class="headerlink" title="MJRefreshFooter.h"></a>MJRefreshFooter.h</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MJRefreshFooter</span> : <span class="title">MJRefreshComponent</span></span></span><br><span class="line"><span class="comment">/** 创建 footer */</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)footerWithRefreshingBlock:(MJRefreshComponentRefreshingBlock)refreshingBlock;</span><br><span class="line"><span class="comment">/** 创建 footer */</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)footerWithRefreshingTarget:(<span class="keyword">id</span>)target refreshingAction:(SEL)action;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 提示没有更多的数据 */</span></span><br><span class="line">- (<span class="keyword">void</span>)noticeNoMoreData;</span><br><span class="line"><span class="comment">/** 重置没有更多的数据（消除没有更多数据的状态） */</span></span><br><span class="line">- (<span class="keyword">void</span>)resetNoMoreData;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 忽略多少 scrollView 的 contentInset 的底部*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> ignoredScrollViewContentInsetBottom;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 自动根据有无数据来显示和隐藏 */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> automaticallyHidden;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="MJRefreshAutoFooter-h"><a href="#MJRefreshAutoFooter-h" class="headerlink" title="MJRefreshAutoFooter.h"></a>MJRefreshAutoFooter.h</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">MJRefreshAutoFooter </span>: MJRefreshFooter</span><br><span class="line"><span class="comment">/** 是否自动刷新(默认为 YES) */</span></span><br><span class="line"><span class="variable">@property</span> (assign, nonatomic, getter=isAutomaticallyRefresh) BOOL automaticallyRefresh;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 当底部控件出现多少时就自动刷新(默认为1.0，也就是底部控件完全出现时，才会自动刷新) */</span></span><br><span class="line"><span class="variable">@property</span> (assign, nonatomic) CGFloat appearencePercentTriggerAutoRefresh;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="2-参考例子"><a href="#2-参考例子" class="headerlink" title="2.参考例子"></a>2.参考例子</h2><p>ps: 可以下载 <a href="https://github.com/CoderMJLee/MJRefresh" target="_blank" rel="noopener">MJRefresh</a>试试<br><img src="http://upload-images.jianshu.io/upload_images/2665449-9bfe1621e9aea9f6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MJRefresh 演示"></p>
<h3 id="下拉刷新01-默认"><a href="#下拉刷新01-默认" class="headerlink" title="下拉刷新01-默认"></a>下拉刷新01-默认</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">self</span>.<span class="built_in">table</span>View.mj_header = [MJRefreshNormalHeader headerWithRefreshingBlock:^&#123;</span><br><span class="line">// 进入刷新状态后会自动调用这个<span class="built_in">block</span></span><br><span class="line">&#125;];</span><br><span class="line">// 或</span><br><span class="line">// 设置回调（一旦进入刷新状态，就调用 target 的 action，也就是调用 <span class="literal">self</span> 的 <span class="built_in">load</span>NewData 方法）</span><br><span class="line"><span class="literal">self</span>.<span class="built_in">table</span>View.mj_header = [MJRefreshNormalHeader headerWithRefreshingTarget:<span class="literal">self</span> refreshingAction:@selector(<span class="built_in">load</span>NewData)];</span><br><span class="line">// 马上进入刷新状态</span><br><span class="line">[<span class="literal">self</span>.<span class="built_in">table</span>View.mj_header beginRefreshing];</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-a3bfaa0e6bfbc461.gif?imageMogr2/auto-orient/strip" alt="下拉刷新01-默认"></p>
<h3 id="下拉刷新02-动画图片"><a href="#下拉刷新02-动画图片" class="headerlink" title="下拉刷新02-动画图片"></a>下拉刷新02-动画图片</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置回调（一旦进入刷新状态，就调用 targett 的 action，即调用 self 的 loadNewData 方法）</span></span><br><span class="line">MJRefreshGifHeader *header = [MJRefreshGifHeader <span class="string">headerWithRefreshingTarget:</span>self <span class="string">refreshingAction:</span><span class="meta">@selector</span>(loadNewData)];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置普通状态的动画图片</span></span><br><span class="line">NSArray *idleImages = @[@<span class="string">"图片1"</span>, @<span class="string">"图片2"</span>, @<span class="string">"图片3"</span>];</span><br><span class="line">[header <span class="string">setImages:</span>idleImages <span class="string">forState:</span>MJRefreshStateIdle];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置即将刷新状态的动画图片（一松开就会刷新的状态）</span></span><br><span class="line">NSArray *pullingImages = @[@<span class="string">"图片1"</span>, @<span class="string">"图片2"</span>, @<span class="string">"图片3"</span>];</span><br><span class="line">[header <span class="string">setImages:</span>pullingImages <span class="string">forState:</span>MJRefreshStatePulling];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置正在刷新状态的动画图片</span></span><br><span class="line">NSArray *refreshingImages = @[@<span class="string">"图片1"</span>, @<span class="string">"图片2"</span>, @<span class="string">"图片3"</span>];</span><br><span class="line">[header <span class="string">setImages:</span>refreshingImages <span class="string">forState:</span>MJRefreshStateRefreshing];</span><br><span class="line"><span class="comment">// 设置 header</span></span><br><span class="line">self.tableView.mj_header = header;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-392f24b00061ea83.gif?imageMogr2/auto-orient/strip" alt="下拉刷新02-动画图片"></p>
<h3 id="下拉刷新03-隐藏时间"><a href="#下拉刷新03-隐藏时间" class="headerlink" title="下拉刷新03-隐藏时间"></a>下拉刷新03-隐藏时间</h3><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 隐藏时间</span></span><br><span class="line">header.lastUpdatedTimeLabel.hidden = <span class="keyword">YES</span>;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-a3c38c436477cacc.gif?imageMogr2/auto-orient/strip" alt="下拉刷新03-隐藏时间"></p>
<h3 id="下拉刷新04-隐藏状态和时间"><a href="#下拉刷新04-隐藏状态和时间" class="headerlink" title="下拉刷新04-隐藏状态和时间"></a>下拉刷新04-隐藏状态和时间</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 隐藏时间</span><br><span class="line">header.lastUpdatedTimeLabel.hidden = YES;</span><br><span class="line"></span><br><span class="line">// 隐藏状态</span><br><span class="line">header.<span class="keyword">state</span>Label.hidden = YES;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-bea00ff6a76a81fd.gif?imageMogr2/auto-orient/strip" alt="下拉刷新04-隐藏状态和时间"></p>
<h3 id="下拉刷新05-自定义文字"><a href="#下拉刷新05-自定义文字" class="headerlink" title="下拉刷新05-自定义文字"></a>下拉刷新05-自定义文字</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 设置文字</span><br><span class="line">[header <span class="built_in">set</span>Title:@<span class="string">"Pull down to refresh"</span> <span class="keyword">for</span>State:MJRefreshStateIdle];</span><br><span class="line">[header <span class="built_in">set</span>Title:@<span class="string">"Release to refresh"</span> <span class="keyword">for</span>State:MJRefreshStatePulling];</span><br><span class="line">[header <span class="built_in">set</span>Title:@<span class="string">"Loading ..."</span> <span class="keyword">for</span>State:MJRefreshStateRefreshing];</span><br><span class="line"></span><br><span class="line">// 设置字体</span><br><span class="line">header.<span class="keyword">state</span>Label.font = [UIFont systemFontOfSize:<span class="number">15</span>];</span><br><span class="line">header.lastUpdatedTimeLabel.font = [UIFont systemFontOfSize:<span class="number">14</span>];</span><br><span class="line"></span><br><span class="line">// 设置颜色</span><br><span class="line">header.<span class="keyword">state</span>Label.textColor = [UIColor redColor];</span><br><span class="line">header.lastUpdatedTimeLabel.textColor = [UIColor blueColor];</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-ad9e5a170567e3bb.gif?imageMogr2/auto-orient/strip" alt="下拉刷新05-自定义文字"></p>
<h3 id="下拉刷新06-自定义刷新控件"><a href="#下拉刷新06-自定义刷新控件" class="headerlink" title="下拉刷新06-自定义刷新控件"></a>下拉刷新06-自定义刷新控件</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.tableView.mj_header = [MJDIYHeader <span class="symbol">headerWithRefreshingTarget:</span><span class="keyword">self</span> <span class="symbol">refreshingAction:</span><span class="variable">@selector</span>(loadNewData)];</span><br><span class="line">/<span class="regexp">/ 具体实现参考 MJDIYHeader.h 和 MJDIYHeader.m</span></span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-02fca65a8c891905.gif?imageMogr2/auto-orient/strip" alt="下拉刷新06-自定义刷新控件"></p>
<h3 id="上拉刷新01-默认"><a href="#上拉刷新01-默认" class="headerlink" title="上拉刷新01-默认"></a>上拉刷新01-默认</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">self</span>.<span class="built_in">table</span>View.mj_footer = [MJRefreshAutoNormalFooter footerWithRefreshingBlock:^&#123;</span><br><span class="line">// 进入刷新状态后会自动调用这个 <span class="built_in">block</span></span><br><span class="line">&#125;];</span><br><span class="line">// 或</span><br><span class="line">// 设置回调（一旦进入刷新状态，就调用 target 的 action，即调用 <span class="literal">self</span> 的 <span class="built_in">load</span>MoreData 方法）</span><br><span class="line"><span class="literal">self</span>.<span class="built_in">table</span>View.mj_footer = [MJRefreshAutoNormalFooter footerWithRefreshingTarget:<span class="literal">self</span> refreshingAction:@selector(<span class="built_in">load</span>MoreData)];</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-475e06e1f29fb149.gif?imageMogr2/auto-orient/strip" alt="上拉刷新01-默认"></p>
<h3 id="上拉刷新02-动画图片"><a href="#上拉刷新02-动画图片" class="headerlink" title="上拉刷新02-动画图片"></a>上拉刷新02-动画图片</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 设置回调（一旦进入刷新状态，就调用 target 的 action，即调用 self 的 loadMoreData 方法）</span></span><br><span class="line">MJRefreshAutoGifFooter *footer = [MJRefreshAutoGifFooter <span class="string">footerWithRefreshingTarget:</span>self <span class="string">refreshingAction:</span><span class="meta">@selector</span>(loadMoreData)];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置刷新图片</span></span><br><span class="line">NSArray *refreshingImages = @[@<span class="string">"图片1"</span>, @<span class="string">"图片2"</span>, @<span class="string">"图片3"</span>];</span><br><span class="line">[footer <span class="string">setImages:</span>refreshingImages <span class="string">forState:</span>MJRefreshStateRefreshing];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置尾部</span></span><br><span class="line">self.tableView.mj_footer = footer;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-15a83363eff10b1e.gif?imageMogr2/auto-orient/strip" alt="上拉刷新02-动画图片"></p>
<h3 id="上拉刷新03-隐藏刷新状态的文字"><a href="#上拉刷新03-隐藏刷新状态的文字" class="headerlink" title="上拉刷新03-隐藏刷新状态的文字"></a>上拉刷新03-隐藏刷新状态的文字</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 隐藏刷新状态的文字</span><br><span class="line">footer.refreshingTitleHidden = YES;</span><br><span class="line">// 如果没有上面的方法，就用footer.<span class="keyword">state</span>Label.hidden = YES;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-7dcd46bd73d0423f.gif?imageMogr2/auto-orient/strip" alt="上拉刷新03-隐藏刷新状态的文字"></p>
<h3 id="上拉刷新04-全部加载完毕"><a href="#上拉刷新04-全部加载完毕" class="headerlink" title="上拉刷新04-全部加载完毕"></a>上拉刷新04-全部加载完毕</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 变为没有更多数据的状态</span></span><br><span class="line">[<span class="meta">footer endRefreshingWithNoMoreData</span>];</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-3f0e9a88feb33219.gif?imageMogr2/auto-orient/strip" alt="上拉刷新04-全部加载完毕"></p>
<h3 id="上拉刷新05-自定义文字"><a href="#上拉刷新05-自定义文字" class="headerlink" title="上拉刷新05-自定义文字"></a>上拉刷新05-自定义文字</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 设置文字</span><br><span class="line">[footer <span class="built_in">set</span>Title:@<span class="string">"Click or drag up to refresh"</span> <span class="keyword">for</span>State:MJRefreshStateIdle];</span><br><span class="line">[footer <span class="built_in">set</span>Title:@<span class="string">"Loading more ..."</span> <span class="keyword">for</span>State:MJRefreshStateRefreshing];</span><br><span class="line">[footer <span class="built_in">set</span>Title:@<span class="string">"No more data"</span> <span class="keyword">for</span>State:MJRefreshStateNoMoreData];</span><br><span class="line"></span><br><span class="line">// 设置字体</span><br><span class="line">footer.<span class="keyword">state</span>Label.font = [UIFont systemFontOfSize:<span class="number">17</span>];</span><br><span class="line"></span><br><span class="line">// 设置颜色</span><br><span class="line">footer.<span class="keyword">state</span>Label.textColor = [UIColor blueColor];</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-f9383ff9ab48a6b2.gif?imageMogr2/auto-orient/strip" alt="上拉刷新05-自定义文字"></p>
<h3 id="上拉刷新06-加载后隐藏"><a href="#上拉刷新06-加载后隐藏" class="headerlink" title="上拉刷新06-加载后隐藏"></a>上拉刷新06-加载后隐藏</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 隐藏当前的上拉刷新控件</span></span><br><span class="line"><span class="keyword">self</span>.tableView.mj_footer.hidden = <span class="literal">YES</span>;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-44824bc808564096.gif?imageMogr2/auto-orient/strip" alt="上拉刷新06-加载后隐藏"></p>
<h3 id="上拉刷新07-自动回弹的上拉01"><a href="#上拉刷新07-自动回弹的上拉01" class="headerlink" title="上拉刷新07-自动回弹的上拉01"></a>上拉刷新07-自动回弹的上拉01</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">self</span>.<span class="built_in">table</span>View.mj_footer = [MJRefreshBackNormalFooter footerWithRefreshingTarget:<span class="literal">self</span> refreshingAction:@selector(<span class="built_in">load</span>MoreData)];</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-ab778a9f00a22a4f.gif?imageMogr2/auto-orient/strip" alt="上拉刷新07-自动回弹的上拉01"></p>
<h3 id="上拉刷新08-自动回弹的上拉02"><a href="#上拉刷新08-自动回弹的上拉02" class="headerlink" title="上拉刷新08-自动回弹的上拉02"></a>上拉刷新08-自动回弹的上拉02</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">MJRefreshBackGifFooter *footer = [MJRefreshBackGifFooter <span class="string">footerWithRefreshingTarget:</span>self <span class="string">refreshingAction:</span><span class="meta">@selector</span>(loadMoreData)];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置普通状态的动画图片</span></span><br><span class="line">NSArray *idleImages = @[@<span class="string">"图片1"</span>, @<span class="string">"图片2"</span>, @<span class="string">"图片3"</span>];</span><br><span class="line">[footer <span class="string">setImages:</span>idleImages <span class="string">forState:</span>MJRefreshStateIdle];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置即将刷新状态的动画图片（一松开就会刷新的状态）</span></span><br><span class="line">NSArray *pullingImages = @[@<span class="string">"图片1"</span>, @<span class="string">"图片2"</span>, @<span class="string">"图片3"</span>];</span><br><span class="line"></span><br><span class="line">[footer <span class="string">setImages:</span>pullingImages <span class="string">forState:</span>MJRefreshStatePulling];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置正在刷新状态的动画图片</span></span><br><span class="line">NSArray *refreshingImages = @[@<span class="string">"图片1"</span>, @<span class="string">"图片2"</span>, @<span class="string">"图片3"</span>];</span><br><span class="line">[footer <span class="string">setImages:</span>refreshingImages <span class="string">forState:</span>MJRefreshStateRefreshing];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置尾部</span></span><br><span class="line">self.tableView.mj_footer = footer;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-7ff75c5dc70d3d33.gif?imageMogr2/auto-orient/strip" alt="上拉刷新08-自动回弹的上拉02"></p>
<h3 id="上拉刷新09-自定义刷新控件-自动刷新"><a href="#上拉刷新09-自定义刷新控件-自动刷新" class="headerlink" title="上拉刷新09-自定义刷新控件(自动刷新)"></a>上拉刷新09-自定义刷新控件(自动刷新)</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.tableView.mj_footer = [MJDIYAutoFooter <span class="symbol">footerWithRefreshingTarget:</span><span class="keyword">self</span> <span class="symbol">refreshingAction:</span><span class="variable">@selector</span>(loadMoreData)];</span><br><span class="line">/<span class="regexp">/ 具体实现参考MJDIYAutoFooter.h和MJDIYAutoFooter.m</span></span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-504544818173e40a.gif?imageMogr2/auto-orient/strip" alt="上拉刷新09-自定义刷新控件(自动刷新)"></p>
<h3 id="上拉刷新10-自定义刷新控件-自动回弹"><a href="#上拉刷新10-自定义刷新控件-自动回弹" class="headerlink" title="上拉刷新10-自定义刷新控件(自动回弹)"></a>上拉刷新10-自定义刷新控件(自动回弹)</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.tableView.mj_footer = [MJDIYBackFooter <span class="symbol">footerWithRefreshingTarget:</span><span class="keyword">self</span> <span class="symbol">refreshingAction:</span><span class="variable">@selector</span>(loadMoreData)];</span><br><span class="line">/<span class="regexp">/ 具体实现参考MJDIYBackFooter.h和MJDIYBackFooter.m</span></span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-39f29fe70a310b80.gif?imageMogr2/auto-orient/strip" alt="上拉刷新10-自定义刷新控件(自动回弹)"></p>
<h3 id="UICollectionView01-上下拉刷新"><a href="#UICollectionView01-上下拉刷新" class="headerlink" title="UICollectionView01-上下拉刷新"></a>UICollectionView01-上下拉刷新</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下拉刷新</span></span><br><span class="line">self.collectionView.mj_header = [MJRefreshNormalHeader <span class="string">headerWithRefreshingBlock:</span>^&#123;</span><br><span class="line"><span class="comment">// 进入刷新状态后会自动调用这个block</span></span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 上拉刷新</span></span><br><span class="line">self.collectionView.mj_footer = [MJRefreshAutoNormalFooter <span class="string">footerWithRefreshingBlock:</span>^&#123;</span><br><span class="line"><span class="comment">// 进入刷新状态后会自动调用这个block</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-0d4fd9a97ffb9513.gif?imageMogr2/auto-orient/strip" alt="UICollectionView01-上下拉刷新"></p>
<h3 id="UIWebView01-下拉刷新"><a href="#UIWebView01-下拉刷新" class="headerlink" title="UIWebView01-下拉刷新"></a>UIWebView01-下拉刷新</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加下拉刷新控件</span></span><br><span class="line">self.webView.scrollView.mj_header = [MJRefreshNormalHeader <span class="string">headerWithRefreshingBlock:</span>^&#123;</span><br><span class="line"><span class="comment">// 进入刷新状态后会自动调用这个block</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-ee3c092adb2b9561.gif?imageMogr2/auto-orient/strip" alt="UIWebView01-下拉刷新"></p>
<ul>
<li><em>over</em><br>以上是 MJRefresh 的具体用法，有兴趣的朋友还可以参考下<a href="https://github.com/CoderMJLee/MJRefresh/blob/master/README.md" target="_blank" rel="noopener">MJRefresh/README.md</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之 - 多线程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之 - 多线程/" itemprop="url">
                  iOS开发之 - 多线程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/2665449-72633919539a5942.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="iOS开发之 － 多线程"></p>
<blockquote>
<p>最近利用晚上的空闲时间，整理了一下多线程相关的知识，几经更改，就变成你现在看到的模样了（如有失误之处，还请不吝赐教）。把多线程相关的知识总结在这里，只希望对看到的朋友们有所帮助！文章有些长，涵盖的知识点也比较多，希望朋友们能够耐心读完哈！我们这篇文章主要包括以下几个模块：</p>
</blockquote>
<ul>
<li><strong>（一）iOS开发之多线程 基础知识</strong></li>
<li><strong>（二）iOS开发之多线程 NSThread</strong></li>
<li><strong>（三）iOS开发之多线程 NSOperation</strong></li>
<li><strong>（四）iOS开发之多线程 GCD</strong></li>
<li><strong>（五）iOS开发之多线程 线程间的通信</strong></li>
</ul>
<p><em>下面我们开始了解 iOS 多线程的基础知识，如果在此之前对多线程已经有所了解的朋友，大可跳过这一部分，直接看后边三种多线程编程的 demo 即可！</em></p>
<h2 id="（一）iOS-开发之多线程-基础知识"><a href="#（一）iOS-开发之多线程-基础知识" class="headerlink" title="（一）iOS 开发之多线程 基础知识"></a>（一）iOS 开发之多线程 基础知识</h2><h3 id="1-多线程简介"><a href="#1-多线程简介" class="headerlink" title="1.多线程简介:"></a>1.多线程简介:</h3><p>一个进程要想执行任务, 必须得有线程(每个进程至少要有一条线程), 线程是进程的基本执行单元, 一个进程（程序）的所有任务都在线程中执行.</p>
<h3 id="2-多线程的原理"><a href="#2-多线程的原理" class="headerlink" title="2.多线程的原理:"></a>2.多线程的原理:</h3><p>同一时间, CPU 只能处理一条线程,只有一条线程在工作.<br>多线程并发(同时)执行, 其实是 CPU 快速地在多条线程之间调度.<br>如果 CPU 调度线程的时间足够快,就造成了多线程并发执行的假象.</p>
<h3 id="3-多线程的优缺点"><a href="#3-多线程的优缺点" class="headerlink" title="3.多线程的优缺点:"></a>3.多线程的优缺点:</h3><h4 id="多线程的优点"><a href="#多线程的优点" class="headerlink" title="多线程的优点:"></a>多线程的优点:</h4><p>能适当提高程序的执行效率.<br>能适当提高资源利用率(CPU、内存利用率).</p>
<h4 id="多线程的缺点"><a href="#多线程的缺点" class="headerlink" title="多线程的缺点:"></a>多线程的缺点:</h4><p>开启线程需要占用一定的内存空间(默认情况下，主线程占用1M，子线程占用512KB),如果开启大量的线程,会占用大量的内存空间,降低程序的性能.</p>
<h3 id="4-多线程在-iOS-开发中的应用"><a href="#4-多线程在-iOS-开发中的应用" class="headerlink" title="4.多线程在 iOS 开发中的应用:"></a>4.多线程在 iOS 开发中的应用:</h3><p>主线程:一个 iOS 程序运行后，默认会开启1条线程，称为“主线程”或“ UI 线程”.<br>主线程的主要作用:刷新 UI 界面、处理 UI 事件(比如点击事件、滚动事件、拖拽事件等).</p>
<h3 id="5-iOS-中三种多线程编程的技术，分别是："><a href="#5-iOS-中三种多线程编程的技术，分别是：" class="headerlink" title="5.iOS 中三种多线程编程的技术，分别是："></a>5.iOS 中三种多线程编程的技术，分别是：</h3><h4 id="（一）NSThread"><a href="#（一）NSThread" class="headerlink" title="（一）NSThread"></a>（一）NSThread</h4><h4 id="（二）Cocoa-NSOperation"><a href="#（二）Cocoa-NSOperation" class="headerlink" title="（二）Cocoa NSOperation"></a>（二）Cocoa NSOperation</h4><h4 id="（三）GCD（全称：Grand-Central-Dispatch）"><a href="#（三）GCD（全称：Grand-Central-Dispatch）" class="headerlink" title="（三）GCD（全称：Grand Central Dispatch）"></a>（三）GCD（全称：Grand Central Dispatch）</h4><p>这三种编程方式从上到下，抽象度层次是从低到高的，抽象度越高的使用越简单，也是Apple最推荐使用的。</p>
<h4 id="三种方式的优缺点介绍："><a href="#三种方式的优缺点介绍：" class="headerlink" title="三种方式的优缺点介绍："></a>三种方式的优缺点介绍：</h4><h5 id="NSThread"><a href="#NSThread" class="headerlink" title="NSThread:"></a>NSThread:</h5><p>优点：NSThread 比其他两个轻量级<br>缺点：需要自己管理线程的生命周期，线程同步。线程同步对数据的加锁会有一定的系统开销。</p>
<h5 id="Cocoa-NSOperation"><a href="#Cocoa-NSOperation" class="headerlink" title="Cocoa NSOperation"></a>Cocoa NSOperation</h5><p>优点：不需要关心线程管理，数据同步的事情，可以把精力放在自己需要执行的操作上。<br>Cocoa operation 相关的类是 NSOperation ，NSOperationQueue。<br>NSOperation是个抽象类，使用它必须用它的子类，可以实现它或者使用它定义好的两个子类：NSInvocationOperation 和 NSBlockOperation。<br>创建NSOperation子类的对象，把对象添加到NSOperationQueue队列里执行。</p>
<h5 id="GCD"><a href="#GCD" class="headerlink" title="GCD"></a>GCD</h5><p>Grand Central Dispatch (GCD)是Apple开发的一个多核编程的解决方法。在iOS4.0开始之后才能使用。GCD是一个替代诸如NSThread, NSOperationQueue, NSInvocationOperation等技术的很高效和强大的技术。</p>
<hr>
<p><em>对 iOS 基础知识有了一定了解之后，下边我们开始看多线程相关的一些 demo， 建议朋友们试试下边的 demo，这样更方便理解！如有疑问，或发现某些 demo 写的有误，还请朋友们告知！</em></p>
<p><strong>下边我们开始了解NSThread，NSThread 其实用的真不多，主要还是用另外两种，不过作为 iOS 开发者，还是应该对它有些了解的，下边是 NSThread 相关的 demo ！</strong></p>
<h2 id="（二）iOS-开发之多线程-NSThread"><a href="#（二）iOS-开发之多线程-NSThread" class="headerlink" title="（二）iOS 开发之多线程 NSThread"></a>（二）iOS 开发之多线程 NSThread</h2><h3 id="一、NSThread-初始化"><a href="#一、NSThread-初始化" class="headerlink" title="一、NSThread 初始化"></a>一、NSThread 初始化</h3><h4 id="1-动态方法"><a href="#1-动态方法" class="headerlink" title="1.动态方法"></a>1.动态方法</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)initWithTarget:(<span class="keyword">id</span>)target selector:(SEL)selector object:(<span class="keyword">id</span>)argument</span><br><span class="line"><span class="comment">// 初始化线程</span></span><br><span class="line"><span class="built_in">NSThread</span>* thread = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(doSomething:)object:<span class="literal">nil</span>];</span><br><span class="line"><span class="comment">// 线程名字</span></span><br><span class="line">thread.name = <span class="string">@"MYThread"</span>;</span><br><span class="line"><span class="comment">// 启动线程</span></span><br><span class="line">[thread start];</span><br></pre></td></tr></table></figure>
<h4 id="2-静态方法"><a href="#2-静态方法" class="headerlink" title="2.静态方法"></a>2.静态方法</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)detachNewThreadSelector:(SEL)aSelector toTarget:(<span class="keyword">id</span>)aTarget withObject:(<span class="keyword">id</span>)anArgument</span><br><span class="line">[<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(doSomething:) toTarget:<span class="keyword">self</span> withObject:<span class="literal">nil</span>];</span><br><span class="line"><span class="comment">// 调用完毕后，会马上创建并开启新线程</span></span><br></pre></td></tr></table></figure>
<h4 id="3-隐式创建线程的方法："><a href="#3-隐式创建线程的方法：" class="headerlink" title="3.隐式创建线程的方法："></a>3.隐式创建线程的方法：</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)performSelectorInBackground:(SEL)aSelector withObject:(<span class="keyword">id</span>)arg;</span><br><span class="line">[<span class="keyword">self</span> performSelectorInBackground:<span class="keyword">@selector</span>(run) withObject:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<p><strong>提示朋友们一下:第一种方式会直接创建线程并且开始运行线程，第二种方式是先创建线程对象，然后再运行线程操作，在运行线程操作前可以设置线程的优先级等线程信息</strong></p>
<h3 id="二、线程间的通信"><a href="#二、线程间的通信" class="headerlink" title="二、线程间的通信"></a>二、线程间的通信</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在主线程上执行操作</span></span><br><span class="line">[<span class="keyword">self</span> performSelectorOnMainThread:<span class="keyword">@selector</span>(run) withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">YES</span>];</span><br><span class="line"><span class="comment">//在当前线程执行操作</span></span><br><span class="line">[<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(run) withObject:<span class="literal">nil</span>];</span><br><span class="line"><span class="comment">//在指定线程上执行操作</span></span><br><span class="line">[<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(run) onThread:thread withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">YES</span>];</span><br></pre></td></tr></table></figure>
<h3 id="三、一些简单方法"><a href="#三、一些简单方法" class="headerlink" title="三、一些简单方法"></a>三、一些简单方法</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取当前线程</span></span><br><span class="line"><span class="built_in">NSThread</span> *thread = [<span class="built_in">NSThread</span> currentThread];</span><br><span class="line"><span class="comment">//获取主线程</span></span><br><span class="line"><span class="built_in">NSThread</span> *main = [<span class="built_in">NSThread</span> mainThread];</span><br><span class="line"><span class="comment">//睡眠，相当于暂停</span></span><br><span class="line">[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br></pre></td></tr></table></figure>
<hr>
<p><em>NSThread  就说到这，一起再看下NSOperation， NSOperation 在开发中用的还是挺多的，虽然苹果建议使用 GCD ，但依然有开发者觉得 NSOperation  比 GCD 更好用！仁者见仁智者见智吧！本小白觉得如果能掌握还是都掌握的好！</em></p>
<h2 id="（三）iOS开发之多线程-NSOperation"><a href="#（三）iOS开发之多线程-NSOperation" class="headerlink" title="（三）iOS开发之多线程 NSOperation"></a>（三）iOS开发之多线程 NSOperation</h2><h3 id="一、创建线程的方式"><a href="#一、创建线程的方式" class="headerlink" title="一、创建线程的方式"></a>一、创建线程的方式</h3><p>使用NSOperation创建线程的方式有3种:</p>
<p>（1）NSInvocationOperation 方式<br>（2）NSBlockOperation 方式<br>（3）自定义子类继承NSOperation,实现内部相应的⽅法</p>
<p>下面是这三种方式创建线程的具体方法：</p>
<h4 id="1-NSInvocationOperation"><a href="#1-NSInvocationOperation" class="headerlink" title="1.NSInvocationOperation"></a>1.NSInvocationOperation</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)invocationOperation</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//创建NSInvocationOperation对象</span></span><br><span class="line"><span class="built_in">NSInvocationOperation</span> *operation = [[<span class="built_in">NSInvocationOperation</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(run) object:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//开始执行操作</span></span><br><span class="line">[operation start];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//一旦执行操作,就会调用target的run方法</span></span><br></pre></td></tr></table></figure>
<p>提示:默认情况下,调用了start方法后并不会开一条新线程去执行操作,只有将NSOperation放到一个NSOperationQueue中,才会异步执行操作.</p>
<h4 id="2-NSBlockOperation"><a href="#2-NSBlockOperation" class="headerlink" title="2.NSBlockOperation"></a>2.NSBlockOperation</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)blockOperation</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//创建NSBlockOperation对象</span></span><br><span class="line"><span class="built_in">NSBlockOperation</span> *operation = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line"><span class="comment">// 主线程</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"1---%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 添加任务(在子线程执行)</span></span><br><span class="line">[operation addExecutionBlock:^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"2---%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line">[operation addExecutionBlock:^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"3---%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">//开启执行操作</span></span><br><span class="line">[operation start];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>提示:只要NSBlockOperation封装的操作数 &gt; 1,就会异步执行操作</p>
<h4 id="3-自定义子类继承自NSOperation"><a href="#3-自定义子类继承自NSOperation" class="headerlink" title="3.自定义子类继承自NSOperation"></a>3.自定义子类继承自NSOperation</h4><p>自定义NSOperation子类需要重写 - (void)main方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)main</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 新建一个自动释放池，如果是异步执行操作，那么将无法访问到主线程的自动释放池</span></span><br><span class="line"><span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"1 - %ld - %@"</span>, i, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//检测操作是否被取消,对取消做出响应</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.isCancelled) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"2 - %ld - %@"</span>, i, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.isCancelled) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"3 - %ld - %@"</span>, i, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.isCancelled) <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、NSOperationQueue的应用"><a href="#二、NSOperationQueue的应用" class="headerlink" title="二、NSOperationQueue的应用"></a>二、NSOperationQueue的应用</h3><p>一个NSOperation对象可以通过调用start方法来执行任务,默认是同步执行的.也可以将NSOperation添加到一个NSOperationQueue中去执行,而且是异步执行的.</p>
<h4 id="1-NSOperationQueue简单创建"><a href="#1-NSOperationQueue简单创建" class="headerlink" title="1.NSOperationQueue简单创建"></a>1.NSOperationQueue简单创建</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一种方式</span></span><br><span class="line">- (<span class="keyword">void</span>)operationQueue</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 创建NSOperationQueue队列</span></span><br><span class="line"><span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line"><span class="comment">// 创建NSInvocationOperation对象</span></span><br><span class="line"><span class="built_in">NSInvocationOperation</span> *operation1 = [[<span class="built_in">NSInvocationOperation</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(run1) object:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSInvocationOperation</span> *operation2 = [[<span class="built_in">NSInvocationOperation</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(run2) object:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建NSBlockOperation对象</span></span><br><span class="line"><span class="built_in">NSBlockOperation</span> *operation3 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"1 --- %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line">[operation3 addExecutionBlock:^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"2 --- %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="built_in">NSBlockOperation</span> *operation4 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"3 --- %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 添加任务到队列中</span></span><br><span class="line">[queue addOperation:operation1];</span><br><span class="line">[queue addOperation:operation2];</span><br><span class="line">[queue addOperation:operation3];</span><br><span class="line">[queue addOperation:operation4];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//第二种方式</span></span><br><span class="line">- (<span class="keyword">void</span>)operationQueue2</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 创建NSOperationQueue队列</span></span><br><span class="line"><span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">[queue addOperationWithBlock:^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"1 --- %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line">[queue addOperationWithBlock:^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"2 --- %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-NSOperation中的操作依赖"><a href="#2-NSOperation中的操作依赖" class="headerlink" title="2.NSOperation中的操作依赖"></a>2.NSOperation中的操作依赖</h4><p>NSOperation之间可以设置依赖来保证执行顺序,比如一定要让操作A执行完后,才能执行操作B,可以这么写[operationB addDependency:operationA]; // 操作B依赖于操作operationA,另外,通过removeDependency方法可以删除依赖对象.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - 依赖操作调整执行顺序</span></span><br><span class="line">- (<span class="keyword">void</span>)<span class="built_in">NSOperationTest1</span> &#123;</span><br><span class="line"><span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line"><span class="built_in">NSBlockOperation</span> *op1 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"~~1~~%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="built_in">NSBlockOperation</span> *op2 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"~~2~~%@~~%d~~"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="built_in">NSBlockOperation</span> *op3 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"~~3~~%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line">[op2 addExecutionBlock:^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"~~4~~%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line">op3.completionBlock = ^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"~~5~~%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 设置依赖</span></span><br><span class="line">[op1 addDependency:op2];</span><br><span class="line">[op1 addDependency:op3];</span><br><span class="line">[queue addOperation:op1];</span><br><span class="line">[queue addOperation:op2];</span><br><span class="line">[queue addOperation:op3];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-线程间的通信"><a href="#3-线程间的通信" class="headerlink" title="3.线程间的通信"></a>3.线程间的通信</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - NSOperation实现线程间的通信</span></span><br><span class="line">- (<span class="keyword">void</span>)<span class="built_in">NSOperationTest2</span> &#123;</span><br><span class="line">[[[<span class="built_in">NSOperationQueue</span> alloc] init] addOperationWithBlock:^&#123;</span><br><span class="line"><span class="built_in">NSData</span> *data = [<span class="built_in">NSData</span> dataWithContentsOfURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://img.lanrentuku.com/img/allimg/1310/13822295641903.jpg"</span>]];</span><br><span class="line"></span><br><span class="line"><span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithData:data];</span><br><span class="line"></span><br><span class="line">[[<span class="built_in">NSOperationQueue</span> mainQueue] addOperationWithBlock:^&#123;</span><br><span class="line"><span class="keyword">self</span>.imageview.image = image;</span><br><span class="line">&#125;];</span><br><span class="line">&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三、一些简单方法-1"><a href="#三、一些简单方法-1" class="headerlink" title="三、一些简单方法"></a>三、一些简单方法</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 取消单个操作</span></span><br><span class="line">[operation cancel];</span><br><span class="line"><span class="comment">// 取消queue中所有的操作</span></span><br><span class="line">[queue cancelAllOperations];</span><br><span class="line"><span class="comment">//设置队列的最大并发操作数量</span></span><br><span class="line">queue.maxConcurrentOperationCount = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 会阻塞当前线程，等到某个operation执行完毕</span></span><br><span class="line">[operation waitUntilFinished];</span><br><span class="line"><span class="comment">// 阻塞当前线程，等待queue的所有操作执行完毕</span></span><br><span class="line">[queue waitUntilAllOperationsAreFinished];</span><br><span class="line"><span class="comment">// 暂停queue YES代表暂停队列,NO代表恢复队列</span></span><br><span class="line">[queue setSuspended:<span class="literal">YES</span>];</span><br></pre></td></tr></table></figure>
<hr>
<p><em>NSOperation 常用的基本上也就上面那些了。。。GCD 就不用多说了，老东家苹果推荐的，不过我却觉得名字太长~~~，一开始总是记不住，多敲就好了！所有编程语言大概都有这么一个绝招O(∩_∩)O！</em></p>
<h2 id="（四）iOS开发之多线程-GCD"><a href="#（四）iOS开发之多线程-GCD" class="headerlink" title="（四）iOS开发之多线程 GCD"></a>（四）iOS开发之多线程 GCD</h2><h3 id="一、GCD-术语"><a href="#一、GCD-术语" class="headerlink" title="一、GCD 术语"></a>一、GCD 术语</h3><p>要理解GCD ，我们先来熟悉与线程和并发相关的几个概念。</p>
<h4 id="1-Serial-vs-Concurrent-串行-vs-并发"><a href="#1-Serial-vs-Concurrent-串行-vs-并发" class="headerlink" title="1.Serial vs. Concurrent 串行 vs. 并发"></a>1.Serial vs. Concurrent 串行 vs. 并发</h4><p>任务串行执行就是每次只有一个任务被执行，任务并发执行就是在同一时间可以有多个任务被执行。</p>
<h4 id="2-同步（Synchronous）与异步（Asynchronous）"><a href="#2-同步（Synchronous）与异步（Asynchronous）" class="headerlink" title="2.同步（Synchronous）与异步（Asynchronous）"></a>2.同步（Synchronous）与异步（Asynchronous）</h4><p>同步，意味着在当前线程中执行任务，不具备开启新的线程的能力。<br>异步，在新的线程中执行任务，具备开启新的线程的能力。</p>
<h4 id="3-临界区（Critical-Section）"><a href="#3-临界区（Critical-Section）" class="headerlink" title="3.临界区（Critical Section）"></a>3.临界区（Critical Section）</h4><p>就是一段代码不能被并发执行，即两个线程不能同时执行这段代码。</p>
<h4 id="4-死锁（Deadlock）"><a href="#4-死锁（Deadlock）" class="headerlink" title="4.死锁（Deadlock）"></a>4.死锁（Deadlock）</h4><p>停止等待事情的线程会导致多个线程相互维持等待，即死锁。</p>
<h4 id="5-Thread-Safe-线程安全"><a href="#5-Thread-Safe-线程安全" class="headerlink" title="5.Thread Safe 线程安全"></a>5.Thread Safe 线程安全</h4><p>线程安全的代码能在多线程或并发任务中被安全的调用，而不会导致任何问题（数据损坏，崩溃等）。</p>
<h4 id="6-Queues-队列"><a href="#6-Queues-队列" class="headerlink" title="6.Queues 队列"></a>6.Queues 队列</h4><p>GCD 提供有 dispatch queues 来处理代码块，这些队列管理你提供给 GCD 的任务并用 FIFO 顺序执行这些任务。</p>
<h3 id="二、代码演示"><a href="#二、代码演示" class="headerlink" title="二、代码演示"></a>二、代码演示</h3><h3 id="1、dispatch-async-异步函数"><a href="#1、dispatch-async-异步函数" class="headerlink" title="1、dispatch_async(异步函数)"></a>1、dispatch_async(异步函数)</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//异步函数 + 并发队列:可以同时开启多条线程,任务是并行的</span></span><br><span class="line"><span class="comment">// 1.创建并发队列</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line"><span class="comment">//2.将任务加入队列</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span> ; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%ld~~~~1~~~~%@"</span>, i, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%ld~~~2~~~%@"</span>, i, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%ld~~~~3~~~~%@"</span>, i, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//异步函数 + 串行队列:会开启新的线程，但是任务是串行的，执行完一个任务，再执行下一个任务</span></span><br><span class="line"><span class="comment">// 1.创建串行队列</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"YMWM"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="comment">// 2.将任务加入队列</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span> ; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"1~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"2~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"2~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="2、dispatch-sync-同步函数"><a href="#2、dispatch-sync-同步函数" class="headerlink" title="2、dispatch_sync(同步函数)"></a>2、dispatch_sync(同步函数)</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//同步函数 + 并发队列:不会开启新的线程</span></span><br><span class="line"><span class="comment">// 1.获得全局的并发队列</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// 2.将任务加入队列</span></span><br><span class="line"><span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"1~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"2~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"3~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//同步函数 + 串行队列:不会开启新的线程</span></span><br><span class="line"><span class="comment">// 1.创建串行队列</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"YMWM"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="comment">// 2.将任务加入队列</span></span><br><span class="line"><span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"1~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"2~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"3~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="3-两者在主队列中的应用"><a href="#3-两者在主队列中的应用" class="headerlink" title="3.两者在主队列中的应用"></a>3.两者在主队列中的应用</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//异步函数 + 主队列：只在主线程中执行任务</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"1~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"2~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"3~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//同步函数 + 主队列：死循环</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();</span><br><span class="line"><span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"1~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"1~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"1~~~%@~~~~~%ld"</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="4、dispatch-group-async的使用"><a href="#4、dispatch-group-async的使用" class="headerlink" title="4、dispatch_group_async的使用"></a>4、dispatch_group_async的使用</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// 创建一个队列组</span></span><br><span class="line">dispatch_group_t group = dispatch_group_create();</span><br><span class="line">dispatch_group_async(group, queue, ^&#123;</span><br><span class="line"><span class="comment">//添加操作...</span></span><br><span class="line">[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"1%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_group_async(group, queue, ^&#123;</span><br><span class="line"><span class="comment">//添加操作...</span></span><br><span class="line">[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"2%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_group_async(group, queue, ^&#123;</span><br><span class="line"><span class="comment">//添加操作...</span></span><br><span class="line">[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"3%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 回到主线程</span></span><br><span class="line">dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"回到主线程刷新UI"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="5、dispatch-barrier-async的使用"><a href="#5、dispatch-barrier-async的使用" class="headerlink" title="5、dispatch_barrier_async的使用"></a>5、dispatch_barrier_async的使用</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"YMWM"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">.5</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"1%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">.5</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"2%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_barrier_async(queue, ^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"barrier --- %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">.5</span>];</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"3%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"4%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="6、dispatch-apply的使用"><a href="#6、dispatch-apply的使用" class="headerlink" title="6、dispatch_apply的使用"></a>6、dispatch_apply的使用</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//执行某个代码片段10次</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">dispatch_apply(<span class="number">10</span>, queue, ^(size_t index) &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="7、dispatch-once-t的使用"><a href="#7、dispatch-once-t的使用" class="headerlink" title="7、dispatch_once_t的使用"></a>7、dispatch_once_t的使用</h4><p>第一个参数predicate，该参数是检查后面第二个参数所代表的代码块是否被调用的谓词，第二个参数则是在整个应用程序中只会被调用一次的代码块<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line"><span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="8-dispatch-after的使用"><a href="#8-dispatch-after的使用" class="headerlink" title="8.dispatch_after的使用"></a>8.dispatch_after的使用</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"-------"</span>);</span><br><span class="line"><span class="comment">//延迟执行，较为精确</span></span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">2.0</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"~~~~~~"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9-线程间的通信"><a href="#9-线程间的通信" class="headerlink" title="9.线程间的通信"></a>9.线程间的通信</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - GCD-线程间的通信</span></span><br><span class="line">- (<span class="keyword">void</span>)downloadImage &#123;</span><br><span class="line"><span class="built_in">NSData</span> *data = [<span class="built_in">NSData</span> dataWithContentsOfURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://img.lanrentuku.com/img/allimg/1310/13822295641903.jpg"</span>]];</span><br><span class="line"></span><br><span class="line"><span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithData:data];</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.imageview.image = image;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10-文件剪切"><a href="#10-文件剪切" class="headerlink" title="10.文件剪切"></a>10.文件剪切</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一种方式</span></span><br><span class="line"><span class="comment">//将文件从from剪切至to</span></span><br><span class="line"><span class="built_in">NSString</span> *from = <span class="string">@"/Users/iOS/Desktop/Test"</span>;</span><br><span class="line"><span class="built_in">NSString</span> *to = <span class="string">@"/Users/iOS/Desktop/test1"</span>;</span><br><span class="line"><span class="built_in">NSFileManager</span> *mgr = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line"><span class="built_in">NSArray</span> *subpaths = [mgr subpathsAtPath:from];</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> *subpath <span class="keyword">in</span> subpaths) &#123;</span><br><span class="line"><span class="built_in">NSString</span> *fromFullpath = [from stringByAppendingPathComponent:subpath];</span><br><span class="line"><span class="built_in">NSString</span> *toFullpath = [to stringByAppendingPathComponent:subpath];</span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line"><span class="comment">//剪切</span></span><br><span class="line">[mgr moveItemAtPath:fromFullpath toPath:toFullpath error:<span class="literal">nil</span>];</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//第二种方式</span></span><br><span class="line"><span class="comment">//将文件从from剪切至to</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">NSString</span> *from = <span class="string">@"/Users/iOS/Desktop/Test"</span>;</span><br><span class="line"><span class="built_in">NSString</span> *to = <span class="string">@"/Users/iOS/Desktop/test1"</span>;</span><br><span class="line"><span class="built_in">NSFileManager</span> *mag = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line"><span class="built_in">NSArray</span> *subpaths = [mag subpathsAtPath:from];</span><br><span class="line">dispatch_apply(subpaths.count, queue, ^(size_t index) &#123;</span><br><span class="line"><span class="built_in">NSString</span> *subpath = subpaths[index];</span><br><span class="line"><span class="built_in">NSString</span> *fromFullpath = [from stringByAppendingPathComponent:subpath];</span><br><span class="line"><span class="built_in">NSString</span> *toFullpath = [to stringByAppendingPathComponent:subpath];</span><br><span class="line"><span class="comment">//        剪切</span></span><br><span class="line">[mag moveItemAtPath:fromFullpath toPath:toFullpath error:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@~~~~~~%@"</span>, [<span class="built_in">NSThread</span> currentThread], subpath);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="三、GCD与非GCD实现单粒设计模式"><a href="#三、GCD与非GCD实现单粒设计模式" class="headerlink" title="三、GCD与非GCD实现单粒设计模式"></a>三、GCD与非GCD实现单粒设计模式</h3><h4 id="1-GCD实现设计模式"><a href="#1-GCD实现设计模式" class="headerlink" title="1.GCD实现设计模式"></a>1.GCD实现设计模式</h4><p>类的.h文件<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PKPerson</span> : <span class="title">NSObject</span></span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)sharedCar;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>类的.m文件<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PKPerson</span>() &lt;<span class="title">NSCopying</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">PKPerson</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例变量，当前类</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> _instance;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重写allocWithZone方法</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)allocWithZone:(<span class="keyword">struct</span> _NSZone *)zone&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该方法整个应用程序只调用一次</span></span><br><span class="line"><span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">_instance = [<span class="keyword">super</span> allocWithZone:zone];</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">return</span> _instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)sharedInstance&#123;</span><br><span class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line"><span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">_instance = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">return</span> _instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保证每复制一个对象也是同一内存空间</span></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone&#123;</span><br><span class="line"><span class="keyword">return</span> _instance;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<h4 id="2-宏定义封装GCD单粒设计模式"><a href="#2-宏定义封装GCD单粒设计模式" class="headerlink" title="2.宏定义封装GCD单粒设计模式"></a>2.宏定义封装GCD单粒设计模式</h4><p>通常当多个类之间有相同的属性和方法时，我们会考虑将相同的部分抽取出来，封装到父类中，但单粒模式不可以这样做，因为单粒模式采用继承方式的话，所有的类会共享一份内存。所以一般采取宏定义封装GCD单粒设计模式。注意，每行的结尾需要添加 “\”。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h文件</span></span><br><span class="line"><span class="meta">#define PKSingletonH + (instancetype)sharedInstance;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// .m文件</span></span><br><span class="line"><span class="meta">#define PKSingletonH \</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> _instace; \</span><br><span class="line">\</span><br><span class="line">+ (<span class="keyword">instancetype</span>)allocWithZone:(<span class="keyword">struct</span> _NSZone *)zone \</span><br><span class="line">&#123; \</span><br><span class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken; \</span><br><span class="line"><span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123; \</span><br><span class="line">_instace = [<span class="keyword">super</span> allocWithZone:zone]; \</span><br><span class="line">&#125;); \</span><br><span class="line"><span class="keyword">return</span> _instace; \</span><br><span class="line">&#125; \</span><br><span class="line">\</span><br><span class="line">+ (<span class="keyword">instancetype</span>)sharedInstance \</span><br><span class="line">&#123; \</span><br><span class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken; \</span><br><span class="line"><span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123; \</span><br><span class="line">_instace = [[<span class="keyword">self</span> alloc] init]; \</span><br><span class="line">&#125;); \</span><br><span class="line"><span class="keyword">return</span> _instace; \</span><br><span class="line">&#125; \</span><br><span class="line">\</span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone \</span><br><span class="line">&#123; \</span><br><span class="line"><span class="keyword">return</span> _instace; \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3-非GCD实现设计模式"><a href="#3-非GCD实现设计模式" class="headerlink" title="3.非GCD实现设计模式"></a>3.非GCD实现设计模式</h4><p>类的.h文件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PKPerson</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)sharedInstance;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>类的.m文件<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"PKPerson.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PKPerson</span>()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">PKPerson</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> _instance;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)allocWithZone:(<span class="keyword">struct</span> _NSZone *)zone</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 同步锁，防止多线程同时进入</span></span><br><span class="line"><span class="keyword">@synchronized</span>(<span class="keyword">self</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (_instance == <span class="literal">nil</span>) &#123;</span><br><span class="line">_instance = [<span class="keyword">super</span> allocWithZone:zone];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> _instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)sharedInstance</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">@synchronized</span>(<span class="keyword">self</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (_instance == <span class="literal">nil</span>) &#123;</span><br><span class="line">_instance = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> _instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> _instance;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<h3 id="四、GCD定时器"><a href="#四、GCD定时器" class="headerlink" title="四、GCD定时器"></a>四、GCD定时器</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"><span class="comment">/** 定时器(这里不用带*，因为dispatch_source_t就是个类，内部已经包含了*) */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) dispatch_source_t timer;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span> *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 获得队列</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个定时器(dispatch_source_t本质还是个OC对象)</span></span><br><span class="line"><span class="keyword">self</span>.timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</span><br><span class="line"></span><br><span class="line"><span class="comment">// GCD的时间参数一般是纳秒（1秒 == 10的9次方纳秒）</span></span><br><span class="line">dispatch_time_t start = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">1.0</span> * <span class="built_in">NSEC_PER_SEC</span>));</span><br><span class="line">uint64_t interval = (uint64_t)(<span class="number">1.0</span> * <span class="built_in">NSEC_PER_SEC</span>);</span><br><span class="line">dispatch_source_set_timer(<span class="keyword">self</span>.timer, start, interval, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置回调</span></span><br><span class="line">dispatch_source_set_event_handler(<span class="keyword">self</span>.timer, ^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"------%@-------"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动定时器</span></span><br><span class="line">dispatch_resume(<span class="keyword">self</span>.timer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><em>三种多线程编程都说完了，代码有些多，不过希望朋友们有所收获，另外再补充一些关于线程间通信的。。。</em></p>
<h2 id="（五）iOS开发之多线程-线程间的通信"><a href="#（五）iOS开发之多线程-线程间的通信" class="headerlink" title="（五）iOS开发之多线程 线程间的通信"></a>（五）iOS开发之多线程 线程间的通信</h2><h3 id="一、简单介绍"><a href="#一、简单介绍" class="headerlink" title="一、简单介绍"></a>一、简单介绍</h3><p>在一个进程中，线程往往不是孤立存在的，多个线程之间需要经常进行通信。以下是线程之间进行通信的方法:</p>
<h3 id="二、常用方法"><a href="#二、常用方法" class="headerlink" title="二、常用方法:"></a>二、常用方法:</h3><h4 id="代码1-performSelector"><a href="#代码1-performSelector" class="headerlink" title="代码1:performSelector"></a>代码1:performSelector</h4><p>performSelector常用方法的常用方法主要有以下几种:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在主线程上执行操作</span></span><br><span class="line">[<span class="keyword">self</span> performSelectorOnMainThread:<span class="keyword">@selector</span>(run) withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">YES</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//在当前线程执行操作</span></span><br><span class="line">[<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(run) withObject:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//在指定线程上执行操作</span></span><br><span class="line">[<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(run) onThread:thread withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">YES</span>];</span><br></pre></td></tr></table></figure></p>
<p>具体代码:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//点击屏幕开始执行以下方法</span></span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span> *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">[<span class="keyword">self</span> performSelectorInBackground:<span class="keyword">@selector</span>(download) withObject:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)download</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 图片的网络路径</span></span><br><span class="line"><span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://img.lanrentuku.com/img/allimg/1310/13822295641903.jpg"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据地址加载图片</span></span><br><span class="line"><span class="built_in">NSData</span> *data = [<span class="built_in">NSData</span> dataWithContentsOfURL:url]; <span class="comment">//耗时操作</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成图片</span></span><br><span class="line"><span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithData:data];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 回到主线程，刷新UI界面</span></span><br><span class="line"><span class="comment">//方式一</span></span><br><span class="line">[<span class="keyword">self</span>.imageView performSelector:<span class="keyword">@selector</span>(setImage:) onThread:[<span class="built_in">NSThread</span> mainThread] withObject:image waitUntilDone:<span class="literal">NO</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//方式二</span></span><br><span class="line"><span class="comment">//    [self.imageView performSelectorOnMainThread:@selector(setImage:) withObject:image waitUntilDone:NO];</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//方式三</span></span><br><span class="line"><span class="comment">//    [self performSelectorOnMainThread:@selector(showImage:) withObject:image waitUntilDone:NO];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//显示图片(如果performSelector调用的是setImage:方法，会直接调用系统的方法)</span></span><br><span class="line"><span class="comment">//- (void)showImage:(UIImage *)image</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//    self.imageView.image = image;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="代码2-NSOperationQueue方式"><a href="#代码2-NSOperationQueue方式" class="headerlink" title="代码2:NSOperationQueue方式"></a>代码2:NSOperationQueue方式</h4><p>一个NSOperation对象可以通过调用start方法来执行任务,默认是同步执行的.也可以将NSOperation添加到一个NSOperationQueue中去执行,而且是异步执行的.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - NSOperation实现线程间的通信</span></span><br><span class="line">- (<span class="keyword">void</span>)<span class="built_in">NSOperationTest</span> &#123;</span><br><span class="line">[[[<span class="built_in">NSOperationQueue</span> alloc] init] addOperationWithBlock:^&#123;</span><br><span class="line"><span class="built_in">NSData</span> *data = [<span class="built_in">NSData</span> dataWithContentsOfURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://img.lanrentuku.com/img/allimg/1310/13822295641903.jpg"</span>]];</span><br><span class="line"><span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithData:data];</span><br><span class="line">[[<span class="built_in">NSOperationQueue</span> mainQueue] addOperationWithBlock:^&#123;</span><br><span class="line"><span class="keyword">self</span>.imageView.image = image;</span><br><span class="line">&#125;];</span><br><span class="line">&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="代码3-GCD方式"><a href="#代码3-GCD方式" class="headerlink" title="代码3:GCD方式"></a>代码3:GCD方式</h4><p>GCD，全称Grand Central Dispath，是苹果开发的一种支持并行操作的机制。它的主要部件是一个FIFO队列和一个线程池，前者用来添加任务，后者用来执行任务。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 图片的网络路径</span></span><br><span class="line"><span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://img.lanrentuku.com/img/allimg/1310/13822295641903.jpg"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载图片</span></span><br><span class="line"><span class="built_in">NSData</span> *data = [<span class="built_in">NSData</span> dataWithContentsOfURL:url];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成图片</span></span><br><span class="line"><span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithData:data];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 回到主线程显示图片</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line"><span class="keyword">self</span>.imageView.image = image;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="三、NSPort方法"><a href="#三、NSPort方法" class="headerlink" title="三、NSPort方法:"></a>三、NSPort方法:</h3><p>NSPort有3个子类，NSSocketPort、NSMessagePort、NSMachPort，但在iOS下只有NSMachPort可用。代码如下:</p>
<p>UIViewController中的代码:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"MyPort.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> () &lt;<span class="title">NSPortDelegate</span>&gt;</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">[<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"><span class="comment">//创建主线程的port</span></span><br><span class="line"><span class="built_in">NSPort</span> *myPort = [<span class="built_in">NSPort</span> port];</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置代理</span></span><br><span class="line">myPort.delegate = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//把port加入runloop</span></span><br><span class="line">[[<span class="built_in">NSRunLoop</span> currentRunLoop] addPort:myPort forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//启动子线程,并传入主线程的port</span></span><br><span class="line">MyPort *work = [[MyPort alloc] init];</span><br><span class="line"></span><br><span class="line">[<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(launchThreadWithPort:)</span><br><span class="line">toTarget:work</span><br><span class="line">withObject:myPort];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)handlePortMessage:(<span class="built_in">NSMessagePort</span>*)message&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"已接到子线程的消息 --- %@"</span>, message);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>MyPort中的代码:</p>
<p>.h文件:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyPort</span> : <span class="title">NSPort</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>.m文件:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"MyPort.h"</span></span></span><br><span class="line"><span class="meta">#define PKMessage 10</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyPort</span> ()&lt;<span class="title">NSMachPortDelegate</span>&gt; </span>&#123;</span><br><span class="line"><span class="built_in">NSPort</span> *firstPort;</span><br><span class="line"><span class="built_in">NSPort</span> *secondPort;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyPort</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)launchThreadWithPort:(<span class="built_in">NSPort</span> *)port &#123;</span><br><span class="line"><span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接收主线程传入的port</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//设置子线程名字</span></span><br><span class="line">[[<span class="built_in">NSThread</span> currentThread] setName:<span class="string">@"MyThread"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//开启runloop</span></span><br><span class="line">[[<span class="built_in">NSRunLoop</span> currentRunLoop] run];</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建自己port</span></span><br><span class="line">secondPort = [<span class="built_in">NSPort</span> port];</span><br><span class="line">secondPort.delegate = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将自己的port添加到runloop,防止runloop执行完毕之后退出,接收主线程发送过来的port消息</span></span><br><span class="line">[[<span class="built_in">NSRunLoop</span> currentRunLoop] addPort:secondPort forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//完成向主线程发送消息</span></span><br><span class="line">[<span class="keyword">self</span> sendPortMessage];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*   完成向主线程发送消息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)sendPortMessage &#123;</span><br><span class="line"><span class="comment">//发送消息到主线程</span></span><br><span class="line">[firstPort sendBeforeDate:[<span class="built_in">NSDate</span> date]</span><br><span class="line">msgid:PKMessage</span><br><span class="line">components:<span class="literal">nil</span></span><br><span class="line">from:secondPort</span><br><span class="line">reserved:<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>提示:通常来说, NSPort可以做的事情通过performSelector也同样可以搞定，因此线程间通信完全可以通过performSelector来实现。<br><strong><end></end></strong></p>
<hr>
<p><strong>结束语：以上是多线程相关的知识总结，本人也是小白级别，如果有写错的地方，还请朋友们能够指出来，谢谢！</strong></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之 - 好玩的富文本/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之 - 好玩的富文本/" itemprop="url">
                  iOS开发之 - 好玩的富文本
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>周末闲着没事，就想着不如把那些容易遗忘的知识点整理一下，一来可以让有需要的朋友少走弯路，二来自己以后再忘记的时候也可以回头看看……但 iOS 中小冷易忘的知识点实在太多了，不知道该从哪里开始整理，“百无聊赖”逛了下淘宝，发现里面好多都是富文本，就想着为什么不从富文本开始呢？反正闲着也是闲着……于是就有了下面这些东西，希望可以帮到看到的盆友们！</p>
<ul>
<li>先写一个小引子<blockquote>
<p>在项目中，很多时候我们都需要把文字设置成倾斜、加粗、加下划线、加删除线、加阴影等等状态，就比如下面这张图：<br><img src="http://upload-images.jianshu.io/upload_images/2665449-efaea7b3b4c215d4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="不是打广告哦"></p>
</blockquote>
</li>
</ul>
<p>但如果我们只是简单的设置字体<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.textView<span class="meta">.text</span> = @<span class="string">"很好玩的富文本"</span><span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>显示出来大概是这个样子滴：<br><img src="http://upload-images.jianshu.io/upload_images/2665449-ab7fd6348e681a88.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="普通文本"></p>
<p>为了让文字变的好看一些，接下来我们尝试一下富文本！</p>
<ul>
<li>改变字体颜色</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableAttributedString</span> *string = [[<span class="built_in">NSMutableAttributedString</span> alloc] initWithString:<span class="string">@"很好玩的富文本"</span>];</span><br><span class="line"></span><br><span class="line">[string addAttribute:<span class="built_in">NSForegroundColorAttributeName</span> value:[<span class="built_in">UIColor</span> blueColor] range:<span class="built_in">NSMakeRange</span>(<span class="number">1</span>, <span class="number">2</span>)];</span><br><span class="line">[string addAttribute:<span class="built_in">NSForegroundColorAttributeName</span> value:[<span class="built_in">UIColor</span> redColor] range:<span class="built_in">NSMakeRange</span>(<span class="number">3</span>, <span class="number">1</span>)];</span><br><span class="line">[string addAttribute:<span class="built_in">NSForegroundColorAttributeName</span> value:[<span class="built_in">UIColor</span> blueColor] range:<span class="built_in">NSMakeRange</span>(<span class="number">4</span>, <span class="number">3</span>)];</span><br><span class="line"><span class="keyword">self</span>.textView.attributedText = string;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-9ab05decdf730650.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="改变字体颜色"></p>
<ul>
<li>改变字体大小</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NSMutableAttributedString *string = [[NSMutableAttributedString alloc] <span class="string">initWithString:</span>@<span class="string">"很好玩的富文本"</span>];</span><br><span class="line">[string <span class="string">addAttribute:</span>NSFontAttributeName <span class="string">value:</span>[UIFont <span class="string">systemFontOfSize:</span><span class="number">20</span>] <span class="string">range:</span>NSMakeRange(<span class="number">1</span>, <span class="number">2</span>)];</span><br><span class="line">[string <span class="string">addAttribute:</span>NSFontAttributeName <span class="string">value:</span>[UIFont <span class="string">systemFontOfSize:</span><span class="number">30</span>] <span class="string">range:</span>NSMakeRange(<span class="number">4</span>, <span class="number">3</span>)];</span><br><span class="line">self.textView.attributedText = string;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-c85ab447f29b3333.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="改变字体大小"></p>
<ul>
<li>给文字添加背景色<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableAttributedString</span> *string = [[<span class="built_in">NSMutableAttributedString</span> alloc] initWithString:<span class="string">@"很好玩的富文本"</span>];</span><br><span class="line">[string addAttribute:<span class="built_in">NSBackgroundColorAttributeName</span> value:[<span class="built_in">UIColor</span> cyanColor] range:<span class="built_in">NSMakeRange</span>(<span class="number">1</span>, <span class="number">2</span>)];</span><br><span class="line">[string addAttribute:<span class="built_in">NSBackgroundColorAttributeName</span> value:[<span class="built_in">UIColor</span> yellowColor] range:<span class="built_in">NSMakeRange</span>(<span class="number">4</span>, <span class="number">3</span>)];</span><br><span class="line"><span class="keyword">self</span>.textView.attributedText = string;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-5b3beb42cba98ef1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="给文字添加背景色"></p>
<ul>
<li>给文字设置间距<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableAttributedString</span> *string = [[<span class="built_in">NSMutableAttributedString</span> alloc] initWithString:<span class="string">@"很好玩的富文本"</span>];</span><br><span class="line">[string addAttribute:<span class="built_in">NSKernAttributeName</span> value:@(<span class="number">20</span>) range:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">6</span>)];</span><br><span class="line"><span class="keyword">self</span>.textView.attributedText = string;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-faf5af7f1000d40e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="给文字设置间距"></p>
<ul>
<li>字体倾斜<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableAttributedString</span> *string = [[<span class="built_in">NSMutableAttributedString</span> alloc] initWithString:<span class="string">@"很好玩的富文本"</span>];</span><br><span class="line">[string addAttribute:<span class="built_in">NSObliquenessAttributeName</span> value:@(<span class="number">0.5</span>) range:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">7</span>)];</span><br><span class="line"><span class="keyword">self</span>.textView.attributedText = string;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-84144fae563a02fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="字体倾斜"></p>
<ul>
<li>字体加粗<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableAttributedString</span> *string = [[<span class="built_in">NSMutableAttributedString</span> alloc] initWithString:<span class="string">@"很好玩的富文本"</span>];</span><br><span class="line">[string addAttribute:<span class="built_in">NSExpansionAttributeName</span> value:@(<span class="number">0.5</span>) range:<span class="built_in">NSMakeRange</span>(<span class="number">4</span>, <span class="number">3</span>)];</span><br><span class="line"><span class="keyword">self</span>.textView.attributedText = string;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-1a4c2b74f132931e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="字体加粗"></p>
<ul>
<li>加下划线并设置下划线颜色<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableAttributedString</span> *string = [[<span class="built_in">NSMutableAttributedString</span> alloc] initWithString:<span class="string">@"很好玩的富文本"</span>];</span><br><span class="line">[string addAttribute:<span class="built_in">NSUnderlineStyleAttributeName</span> value:@(<span class="number">1</span>) range:<span class="built_in">NSMakeRange</span>(<span class="number">4</span>, <span class="number">3</span>)];</span><br><span class="line">[string addAttribute:<span class="built_in">NSUnderlineColorAttributeName</span> value:[<span class="built_in">UIColor</span> blueColor] range:<span class="built_in">NSMakeRange</span>(<span class="number">4</span>, <span class="number">3</span>)];</span><br><span class="line"><span class="keyword">self</span>.textView.attributedText = string;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-54fdb333b29af0a2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="加下划线并设置下划线颜色"></p>
<ul>
<li>加删除线并设置删除线颜色<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableAttributedString</span> *string = [[<span class="built_in">NSMutableAttributedString</span> alloc] initWithString:<span class="string">@"原价666💰，现价只要66💰！"</span>];</span><br><span class="line">[string addAttribute:<span class="built_in">NSStrikethroughStyleAttributeName</span> value:@(<span class="number">1</span>) range:<span class="built_in">NSMakeRange</span>(<span class="number">2</span>, <span class="number">3</span>)];</span><br><span class="line">[string addAttribute:<span class="built_in">NSStrikethroughColorAttributeName</span> value:[<span class="built_in">UIColor</span> blueColor] range:<span class="built_in">NSMakeRange</span>(<span class="number">2</span>, <span class="number">3</span>)];</span><br><span class="line"><span class="keyword">self</span>.textView.attributedText = string;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-7660641928dfc070.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="加删除线并设置删除线颜色"></p>
<ul>
<li>设置文字方向<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NSMutableAttributedString *string = [[NSMutableAttributedString alloc] <span class="string">initWithString:</span>@<span class="string">"很好玩的富文本"</span>];</span><br><span class="line">[string <span class="string">addAttribute:</span>NSVerticalGlyphFormAttributeName <span class="string">value:</span>@(<span class="number">1</span>) <span class="string">range:</span>NSMakeRange(<span class="number">0</span>, <span class="number">7</span>)];</span><br><span class="line">[string <span class="string">addAttribute:</span>NSWritingDirectionAttributeName <span class="string">value:</span>@[@(<span class="number">2</span>),@(<span class="number">3</span>)] <span class="string">range:</span>NSMakeRange(<span class="number">0</span>, <span class="number">7</span>)];</span><br><span class="line">self.textView.attributedText = string;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-3e892743a9f112f5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="设置文字方向"></p>
<ul>
<li>给文字添加阴影<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NSMutableAttributedString *string = [[NSMutableAttributedString alloc] initWithString:@<span class="string">"很好玩的富文本"</span>]<span class="comment">;</span></span><br><span class="line">NSShadow *<span class="keyword">shadow </span>= [[NSShadow alloc]init]<span class="comment">;</span></span><br><span class="line"><span class="keyword">shadow.shadowOffset </span>= CGSizeMake(<span class="number">5</span>, <span class="number">5</span>)<span class="comment">;</span></span><br><span class="line"><span class="keyword">shadow.shadowColor </span>= [UIColor <span class="keyword">blueColor];</span></span><br><span class="line"><span class="keyword">shadow.shadowBlurRadius </span>= <span class="number">1</span><span class="comment">;</span></span><br><span class="line">[string <span class="keyword">addAttribute:NSShadowAttributeName </span>value:<span class="keyword">shadow </span>range:NSMakeRange(<span class="number">4</span>, <span class="number">3</span>)]<span class="comment">;</span></span><br><span class="line">self.textView.attributedText = string<span class="comment">;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-8f882d994febb18b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="给文字添加阴影"></p>
<ul>
<li>图文混排</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableAttributedString</span> *string = [[<span class="built_in">NSMutableAttributedString</span> alloc] initWithString:<span class="string">@"很好玩的富文本"</span>];</span><br><span class="line"><span class="comment">// 创建图片图片附件</span></span><br><span class="line"><span class="built_in">NSTextAttachment</span> *attach = [[<span class="built_in">NSTextAttachment</span> alloc] init];</span><br><span class="line">attach.image = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"1.jpg"</span>];</span><br><span class="line">attach.bounds = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">20</span>);</span><br><span class="line"><span class="built_in">NSAttributedString</span> *attachString = [<span class="built_in">NSAttributedString</span> attributedStringWithAttachment:attach];</span><br><span class="line">[string appendAttributedString:attachString];</span><br><span class="line"><span class="keyword">self</span>.textView.attributedText = string;</span><br></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-27adc1a27e0637ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图文混排"></p>
<ul>
<li>文字偏移<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NSMutableAttributedString *string = [[NSMutableAttributedString alloc] <span class="string">initWithString:</span>@<span class="string">"很好玩的富文本"</span>];</span><br><span class="line">[string <span class="string">addAttribute:</span>NSBaselineOffsetAttributeName <span class="string">value:</span>@(<span class="number">10</span>) <span class="string">range:</span>NSMakeRange(<span class="number">0</span>, <span class="number">1</span>)];</span><br><span class="line">[string <span class="string">addAttribute:</span>NSBaselineOffsetAttributeName <span class="string">value:</span>@(<span class="number">20</span>) <span class="string">range:</span>NSMakeRange(<span class="number">1</span>, <span class="number">1</span>)];</span><br><span class="line">[string <span class="string">addAttribute:</span>NSBaselineOffsetAttributeName <span class="string">value:</span>@(<span class="number">30</span>) <span class="string">range:</span>NSMakeRange(<span class="number">2</span>, <span class="number">1</span>)];</span><br><span class="line">[string <span class="string">addAttribute:</span>NSBaselineOffsetAttributeName <span class="string">value:</span>@(<span class="number">40</span>) <span class="string">range:</span>NSMakeRange(<span class="number">3</span>, <span class="number">1</span>)];</span><br><span class="line">[string <span class="string">addAttribute:</span>NSBaselineOffsetAttributeName <span class="string">value:</span>@(<span class="number">50</span>) <span class="string">range:</span>NSMakeRange(<span class="number">4</span>, <span class="number">3</span>)];</span><br><span class="line">self.textView.attributedText = string;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-4e0d6a0908bfb1e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="文字偏移"></p>
<p>以上是对 iOS 中富文本相关的知识做的一些整理，如果有粗心写错的地方，还请朋友们指出！如果还有遗漏的地方，以后碰到了再来补充。。。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之 - 微信支付/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之 - 微信支付/" itemprop="url">
                  iOS开发之 - 微信支付
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/2665449-0d0a74ab4c5830ac.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="iOS开发之 - 微信支付"></p>
<blockquote>
<p>作为 iOS 开发者，支付无疑是很重要的，特别是这两年几乎到处都是微信支付、支付宝支付。相比支付宝支付，觉得微信支付还算简单，但还是建议预先看下<a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_1" target="_blank" rel="noopener">文档</a>。开始说文章的内容吧，这篇文章主要分为四个部分：创建应用、了解支付的流程、集成微信SDK，最后是实现支付的demo。</p>
</blockquote>
<ul>
<li><strong>第一步：创建应用</strong></li>
</ul>
<p><em>通常来说注册APP这样的事情是部门经理做的，所以这一步也可以忽略～～～</em></p>
<p>在 <a href="https://open.weixin.qq.com/cgi-bin/index?t=home/index&amp;lang=zh_CN&amp;token=0ebf4697e5671e8567a5c5f4682a4c6cb0fcaa92" target="_blank" rel="noopener">微信开放平台</a> 的管理中心 <a href="https://open.weixin.qq.com/cgi-bin/frame?t=home/app_tmpl&amp;lang=zh_CN" target="_blank" rel="noopener">创建一个应用。</a>此应用官方称七日内审核通过，一般都是三四天！而关于填写经营信息、填写商户信息、填写对公帐号信息在这里就忽略不写了。有兴趣的朋友可以了解下<a href="http://494075592.blog.51cto.com/10682677/1701260" target="_blank" rel="noopener">这篇文章</a>。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-723d6f42f6b41ba2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="创建应用"></p>
<ul>
<li><strong>第二步：了解支付的流程</strong></li>
</ul>
<p>如果做过其它支付，就会发现这些流程其实都差不多，就像我们平时用手机支付买东西一样。下边的流程两分钟大概就能读完，很容易理解！</p>
<p>1&gt; 用户使用 APP 客户端，选择商品下单。<br>2&gt; APP 客户端将用户的商品数据传给商户服务器，请求生成支付订单。<br>3&gt; 商户后台调用统一下单 API 向微信的服务器发送请求，微信服务器生成预付单，并生成一个 prepay_id 返回给商户后台。<br>4&gt; 商户后台将这个 prepay_id 返回给商户客户端。<br>5&gt; 用户点击确认支付，这时候商户客户端调用 SDK 打开微信客户端，进行微信支付。<br>6&gt; 微信客户端向微信服务器发起支付请求并返回支付结果（他们之间交互用的就是prepay_id这个参数，微信的服务器要验证微信客户端传过去的参数是否跟第三步中生成的那个id一致）。<br>7&gt; 用户输入支付密码后，微信客户端提交支付授权，跟微信服务器交互，完成支付<br>8&gt; 微信服务器给微信客户端发送支付结果提示，并异步给商户服务器发送支付结果通知。<br>9&gt; 商户客户端通过支付结果回调接口查询支付结果，并向后台检查支付结果是否正确，后台返回支付结果。<br>10&gt; 商户客户端显示支付结果，完成订单，发货。</p>
<ul>
<li><strong>第三步：集成SDK</strong></li>
</ul>
<p>其实严格来说，这一步才是微信支付的真正开始。首先我们应该下载 <a href="https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&amp;t=resource/res_list&amp;verify=1&amp;id=open1419319164&amp;lang=zh_CN" target="_blank" rel="noopener">微信SDK</a>，如有需要，还可把<a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=11_1_" target="_blank" rel="noopener">【微信支付】APP支付示例</a>下载下来看看。下面是集成 SDK 的具体步骤：</p>
<p>1.把下载好的 SDK 导入工程（如下图）（我下的是OpenSDK1.7.4版本）</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-a0dfa21d98e8d045.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="把下载好的 SDK 导入工程"></p>
<p>2.导入微信支付SDK依赖库（如下图）</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-f4bd0524a4a2d18f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="导入微信支付SDK依赖库"></p>
<p>3.设置URL Scheme<br>在注册微信平台APP的时候，会给一个唯一识别标识符（APPID）,需要填写在工程中。（如下图）</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-8c7b570a18293fc3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="设置URL Scheme"></p>
<hr>
<p><em>配置好上述参数后就可以写代码了～～～</em></p>
<ul>
<li><strong>第四部：代码</strong></li>
</ul>
<p>代码分为以下步骤：</p>
<p>1.在 Appdelegate 中注册微信 APPID<br>这是首先要做的事情。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)<span class="string">application:</span>(UIApplication *)application <span class="string">didFinishLaunchingWithOptions:</span>(NSDictionary *)launchOptions &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向微信终端注册ID</span></span><br><span class="line">[WXApi <span class="string">registerApp:</span>@<span class="string">"wx0f8d5e0eadd2d4b7"</span> <span class="string">withDescription:</span>@<span class="string">"demo test"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.获取微信支付所必要的参数<br>接着，在微信支付的.m文件中获取微信支付所必要的参数。为了提高数据安全性，下单、签名等操作一般都是在后台完成的，因此以下这些参数后台会给我们。我们主要得知道这些参数如何设置：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发起微信支付，设置参数</span></span><br><span class="line">PayReq *request   = [[PayReq alloc] init];  <span class="comment">// 创建支付对象</span></span><br><span class="line">request.openID = <span class="string">@""</span>; <span class="comment">// 由用户微信号和AppID组成的唯一标识</span></span><br><span class="line">request.partnerId = <span class="string">@""</span>; <span class="comment">// 商家ID</span></span><br><span class="line">request.prepayId  = <span class="string">@""</span>; <span class="comment">// 预支付订单ID</span></span><br><span class="line">request.package   = <span class="string">@"Sign=WXPay"</span>; <span class="comment">// 数据和签名</span></span><br><span class="line">request.nonceStr  = <span class="string">@""</span>; <span class="comment">// 随机编码</span></span><br><span class="line"><span class="built_in">NSDate</span> *date = [<span class="built_in">NSDate</span> date];</span><br><span class="line"><span class="built_in">NSString</span> * timeSp = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%ld"</span>, (<span class="keyword">long</span>)[date timeIntervalSince1970]];</span><br><span class="line"><span class="built_in">UInt32</span> timeStamp = [timeSp intValue];</span><br><span class="line">request.timeStamp = timeStamp; <span class="comment">// 时间戳</span></span><br><span class="line">request.sign = <span class="string">@""</span>; <span class="comment">// 签名，签名一般都会加密</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//发送请求到微信，等待微信返回 onResp</span></span><br><span class="line">[WXApi sendReq:request];</span><br></pre></td></tr></table></figure></p>
<p>3.微信支付回调<br>最后要在Appdelegate.m文件中添加微信支付结果 onResp 回调方法<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断发起的请求是否为微信支付，如果是就回调</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)app openURL:(<span class="built_in">NSURL</span> *)url options:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="keyword">id</span>&gt; *)options &#123;</span><br><span class="line"><span class="keyword">return</span> [WXApi handleOpenURL:url delegate:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - WXApiDelegate</span></span><br><span class="line"><span class="comment">// 微信支付结果回调方法</span></span><br><span class="line">- (<span class="keyword">void</span>)onResp:(BaseResp *)resp &#123;</span><br><span class="line"><span class="built_in">NSString</span> *payResoult = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%d"</span>, resp.errCode];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>([resp isKindOfClass:[PayResp <span class="keyword">class</span>]])&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">WXSuccess           = 0,    成功</span></span><br><span class="line"><span class="comment">WXErrCodeCommon     = -1,    普通错误类型</span></span><br><span class="line"><span class="comment">WXErrCodeUserCancel = -2,    用户点击取消并返回</span></span><br><span class="line"><span class="comment">WXErrCodeSentFail   = -3,    发送失败</span></span><br><span class="line"><span class="comment">WXErrCodeAuthDeny   = -4,    授权失败</span></span><br><span class="line"><span class="comment">WXErrCodeUnsupport  = -5,    微信不支持</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//支付返回结果，实际支付结果需要去微信服务器端查询</span></span><br><span class="line"><span class="keyword">switch</span> (resp.errCode) &#123;</span><br><span class="line"><span class="keyword">case</span> WXSuccess:</span><br><span class="line">payResoult = <span class="string">@"支付成功"</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> WXErrCodeCommon:</span><br><span class="line">payResoult = <span class="string">@"支付失败"</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> WXErrCodeUserCancel:</span><br><span class="line">payResoult = <span class="string">@"用户点击取消并返回"</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="comment">// 错误码 以及 错误提示字符串</span></span><br><span class="line">payResoult = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"支付结果：失败！retcode = %d, retstr = %@"</span>, resp.errCode,resp.errStr];</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<p>结束语：在开发中，微信支付常常与其它技术配合使用，比如MD5加密，AFN等等。有空闲的话会一一整理出来与大家分享！另外文章写的如果有什么错误，还请大家指出来，谢谢大家！</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘朋坤</p>
              <p class="site-description motion-element" itemprop="description">iOS 修炼中...</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘朋坤</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.1.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
