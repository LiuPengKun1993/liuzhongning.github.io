<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.1.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.1.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="iOS 修炼中...">
<meta property="og:type" content="website">
<meta property="og:title" content="以梦为马">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="以梦为马">
<meta property="og:description" content="iOS 修炼中...">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="以梦为马">
<meta name="twitter:description" content="iOS 修炼中...">






  <link rel="canonical" href="http://yoursite.com/page/4/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>以梦为马</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">以梦为马</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">谨以此纪念岁月</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-主页">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />主页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-归档">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之 - 毛玻璃&模糊视图&滤镜/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之 - 毛玻璃&模糊视图&滤镜/" itemprop="url">
                  iOS开发之 - 毛玻璃&模糊视图&滤镜
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>为了让界面更加美观，有时候我们需要将图片设置成模糊，比如下边这张图片：</p>
</blockquote>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-6946c7d084d2e1ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="CoreImage/CoreImage初窥"></p>
<p>这篇文章主要演示了三种模糊效果，如下：</p>
<h4 id="一、简单的毛玻璃效果："><a href="#一、简单的毛玻璃效果：" class="headerlink" title="一、简单的毛玻璃效果："></a>一、简单的毛玻璃效果：</h4><ul>
<li>原图<br><img src="http://upload-images.jianshu.io/upload_images/2665449-cb2dfce94d622fc0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="原图"></li>
</ul>
<ul>
<li><p>毛玻璃效果<br><img src="http://upload-images.jianshu.io/upload_images/2665449-df954aee7a52a2ab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="毛玻璃效果"></p>
</li>
<li><p>代码如下：</p>
</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;CoreImage/CoreImage.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIImageView</span> *imageView;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">[<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.imageView = [[<span class="built_in">UIImageView</span> alloc]initWithFrame:<span class="keyword">self</span>.view.frame];</span><br><span class="line"><span class="keyword">self</span>.imageView.image = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"1.jpg"</span>];</span><br><span class="line"><span class="keyword">self</span>.imageView.contentMode = <span class="built_in">UIViewContentModeScaleAspectFill</span>;</span><br><span class="line">[<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.imageView];</span><br><span class="line"></span><br><span class="line"><span class="built_in">UIButton</span> *button = [<span class="built_in">UIButton</span> buttonWithType:<span class="built_in">UIButtonTypeCustom</span>];</span><br><span class="line">button.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="keyword">self</span>.view.frame.size.height - <span class="number">80</span>, <span class="keyword">self</span>.view.frame.size.width, <span class="number">40</span>);</span><br><span class="line">[button setTitle:<span class="string">@"蒙奇·D·路飞"</span> forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">button.backgroundColor = [<span class="built_in">UIColor</span> brownColor];</span><br><span class="line">[button addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(<span class="string">"点击调用的方法"</span>) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">[<span class="keyword">self</span>.view addSubview:button];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>button 被点击时调用以下代码：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.imageView = [[<span class="built_in">UIImageView</span> alloc] initWithFrame:<span class="keyword">self</span>.view.frame];</span><br><span class="line"><span class="keyword">self</span>.imageView.image = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"1.jpg"</span>];</span><br><span class="line"><span class="built_in">UIBlurEffect</span> *blur = [<span class="built_in">UIBlurEffect</span> effectWithStyle:<span class="built_in">UIBlurEffectStyleLight</span>];</span><br><span class="line"><span class="built_in">UIVisualEffectView</span> *visualEffectView = [[<span class="built_in">UIVisualEffectView</span> alloc] initWithEffect:blur];</span><br><span class="line">visualEffectView.frame = <span class="keyword">self</span>.view.frame;</span><br><span class="line">[<span class="keyword">self</span>.imageView addSubview:visualEffectView];</span><br><span class="line"></span><br><span class="line"><span class="built_in">UIVibrancyEffect</span> *vibrancyEffect = [<span class="built_in">UIVibrancyEffect</span> effectForBlurEffect:blur];</span><br><span class="line"><span class="built_in">UIVisualEffectView</span> *ano = [[<span class="built_in">UIVisualEffectView</span> alloc] initWithEffect:vibrancyEffect];</span><br><span class="line">ano.frame = <span class="keyword">self</span>.view.frame;</span><br><span class="line"></span><br><span class="line"><span class="built_in">UILabel</span> *label = [[<span class="built_in">UILabel</span> alloc] init];</span><br><span class="line">label.font = [<span class="built_in">UIFont</span> systemFontOfSize:<span class="number">40</span>];</span><br><span class="line">label.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="keyword">self</span>.view.frame.size.height - <span class="number">120</span>, <span class="keyword">self</span>.view.frame.size.width, <span class="number">80</span>);</span><br><span class="line">label.textAlignment = <span class="built_in">NSTextAlignmentCenter</span>;</span><br><span class="line">label.text = <span class="string">@"蒙奇·D·路飞"</span>;</span><br><span class="line">[visualEffectView.contentView addSubview:ano];</span><br><span class="line">[ano.contentView addSubview:label];</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.imageView];</span><br></pre></td></tr></table></figure></p>
<h4 id="二、高斯模糊运动模糊等，先看效果图："><a href="#二、高斯模糊运动模糊等，先看效果图：" class="headerlink" title="二、高斯模糊运动模糊等，先看效果图："></a>二、高斯模糊运动模糊等，先看效果图：</h4><ul>
<li>原图</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-954940694c6fed53.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="原图"></p>
<ul>
<li><p>运动模糊效果图<br><img src="http://upload-images.jianshu.io/upload_images/2665449-d27b1bd30c08f616.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="运动模糊"></p>
</li>
<li><p>代码如下</p>
</li>
</ul>
<p>viewDidLoad 中的代码和“简单的毛玻璃效果”中的 viewDidLoad 是一样的，这里只简单贴出 button 被点击调用的代码<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CIImage</span> *inputImage = [<span class="built_in">CIImage</span> imageWithCGImage:<span class="keyword">self</span>.imageView.image.CGImage];</span><br><span class="line"></span><br><span class="line"><span class="comment">// CIGaussianBlur   高斯模糊</span></span><br><span class="line"><span class="comment">// CIBoxBlur        均值模糊</span></span><br><span class="line"><span class="comment">// CIDiscBlur       环形卷积模糊</span></span><br><span class="line"><span class="comment">// CIMotionBlur     运动模糊</span></span><br><span class="line"><span class="built_in">CIFilter</span> *filter = [<span class="built_in">CIFilter</span> filterWithName:<span class="string">@"CIMotionBlur"</span>];</span><br><span class="line">[filter setValue:inputImage forKey:kCIInputImageKey];</span><br><span class="line">[filter setValue:@<span class="number">5</span> forKey:kCIInputRadiusKey];</span><br><span class="line"><span class="built_in">CIContext</span> *context = [<span class="built_in">CIContext</span> contextWithOptions:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">CIImage</span> *outupImage = filter.outputImage;</span><br><span class="line"><span class="built_in">CGImageRef</span> imageRef = [context createCGImage:outupImage fromRect:outupImage.extent];</span><br><span class="line"><span class="keyword">self</span>.imageView.image= [<span class="built_in">UIImage</span> imageWithCGImage:imageRef];</span><br></pre></td></tr></table></figure></p>
<h4 id="三、滤镜效果，先看下效果图"><a href="#三、滤镜效果，先看下效果图" class="headerlink" title="三、滤镜效果，先看下效果图"></a>三、滤镜效果，先看下效果图</h4><ul>
<li><p>原图<br><img src="http://upload-images.jianshu.io/upload_images/2665449-503d38d5e10a65b7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="原图"></p>
</li>
<li><p>“怀旧”效果图<br><img src="http://upload-images.jianshu.io/upload_images/2665449-f1196625bd86712d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="“怀旧”效果图"></p>
</li>
</ul>
<ul>
<li>代码如下</li>
</ul>
<p>viewDidLoad 中的代码和“简单的毛玻璃效果”中的 viewDidLoad 是一样的，这里也只贴出 button 被点击调用的代码<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">CIContext</span> *context = [<span class="built_in">CIContext</span> contextWithOptions:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">CIImage</span> *inputImage = [[<span class="built_in">CIImage</span> alloc] initWithImage:<span class="keyword">self</span>.imageView.image];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 怀旧  CIPhotoEffectInstant</span></span><br><span class="line"><span class="comment">// 单色  CIPhotoEffectMono</span></span><br><span class="line"><span class="comment">// 黑白  CIPhotoEffectNoir</span></span><br><span class="line"><span class="comment">// 褪色  CIPhotoEffectFade</span></span><br><span class="line"><span class="comment">// 色调  CIPhotoEffectTonal</span></span><br><span class="line"><span class="comment">// 冲印  CIPhotoEffectProcess</span></span><br><span class="line"><span class="comment">// 岁月  CIPhotoEffectTransfer</span></span><br><span class="line"><span class="comment">// 铬黄  CIPhotoEffectChrome</span></span><br><span class="line"><span class="built_in">CIFilter</span> *filter = [<span class="built_in">CIFilter</span> filterWithName:<span class="string">@"CIPhotoEffectInstant"</span>];</span><br><span class="line">[filter setValue:inputImage forKey:kCIInputImageKey];</span><br><span class="line"><span class="built_in">CIImage</span> *result = [filter valueForKey:kCIOutputImageKey];</span><br><span class="line"><span class="built_in">CGImageRef</span> cgImage = [context createCGImage:result fromRect:[result extent]];</span><br><span class="line"><span class="built_in">UIImage</span> *resultImage = [<span class="built_in">UIImage</span> imageWithCGImage:cgImage];</span><br><span class="line"><span class="keyword">self</span>.imageView.image= [<span class="built_in">UIImage</span> imageWithCGImage:resultImage.CGImage];</span><br></pre></td></tr></table></figure></p>
<hr>
<p>这是今晚整理的 CoreImage 相关的知识，如果哪里写的有问题，欢迎大家指正！另外给大家分享一篇文章，里面有很多 iOS 9 出来的 Core Image新滤镜，<a href="http://www.cocoachina.com/ios/20151118/14253.html" target="_blank" rel="noopener">在这里。</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发技巧 - UIViewController 基类设计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发技巧 - UIViewController 基类设计/" itemprop="url">
                  iOS开发技巧 - UIViewController 基类设计
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>在项目开发中，所有控制器里面大概都有共同的属性，比如背景色、导航栏、tarBar 的设置等等，这时我们一般都会设计出来一个 <strong><code>UIViewController</code></strong> 的基类，通常叫做 <strong><code>baseViewController</code></strong>或<strong><code>rootViewController</code></strong>，在这个类里面设置所有控制器的共同的属性，然后项目中所有的控制器再继承自这个类。</p>
</blockquote>
<h5 id="一般来说这种基类控制器里面需要做的操作有以下几个："><a href="#一般来说这种基类控制器里面需要做的操作有以下几个：" class="headerlink" title="一般来说这种基类控制器里面需要做的操作有以下几个："></a>一般来说这种基类控制器里面需要做的操作有以下几个：</h5><ul>
<li>为 APP 设置统一的背景色</li>
<li>设置是否允许控制器自动调整高度（一般是 NO）</li>
<li>自定义导航栏返回按钮</li>
<li>重新布局视图大小，及时更新视图的 frame</li>
</ul>
<p>当然还有其它的一些，毕竟这和项目的具体需求息息相关，因此还要因项目而异。我这里主要就列出基类控制器中基本的常用的一些需求，和大家分享下，希望能帮到需要的人，少走弯路；另外文章如果有不足之处，也希望各位同行能多多的交流指点。</p>
<h4 id="UIViewController-基类控制器设计步骤"><a href="#UIViewController-基类控制器设计步骤" class="headerlink" title="UIViewController 基类控制器设计步骤"></a>UIViewController 基类控制器设计步骤</h4><h6 id="首先创建一个-UIViewController-类，命名为-NNBaseViewController"><a href="#首先创建一个-UIViewController-类，命名为-NNBaseViewController" class="headerlink" title="首先创建一个 UIViewController 类，命名为 NNBaseViewController"></a>首先创建一个 <code>UIViewController</code> 类，命名为 <code>NNBaseViewController</code></h6><h6 id="接着在-NNBaseViewController-m中做一些操作"><a href="#接着在-NNBaseViewController-m中做一些操作" class="headerlink" title="接着在 NNBaseViewController.m中做一些操作"></a>接着在 <code>NNBaseViewController.m</code>中做一些操作</h6><p>1.设置应用的统一背景色</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置应用的背景色</span></span><br><span class="line"><span class="keyword">self</span>.view.backgroundColor = [<span class="built_in">UIColor</span> lightGrayColor];</span><br></pre></td></tr></table></figure>
<p>2.将 automaticallyAdjustsScrollViewInsets 设置为NO，不然视图会下移64像素</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不允许 viewController 自动调整，我们自己布局；如果设置为YES，视图会自动下移 64 像素</span></span><br><span class="line"><span class="keyword">self</span>.automaticallyAdjustsScrollViewInsets = <span class="literal">NO</span>;</span><br></pre></td></tr></table></figure>
<p>3.有时候系统的返回按钮不符合应用的风格，所以就需要重写导航栏上的返回按钮</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - 自定义返回按钮</span></span><br><span class="line">- (<span class="keyword">void</span>)setupLeftBarButton &#123;</span><br><span class="line"><span class="comment">// 自定义 leftBarButtonItem ，UIImageRenderingModeAlwaysOriginal 防止图片被渲染</span></span><br><span class="line"><span class="keyword">self</span>.navigationItem.leftBarButtonItem = [[<span class="built_in">UIBarButtonItem</span> alloc]</span><br><span class="line">initWithImage:[[<span class="built_in">UIImage</span> imageNamed:<span class="string">@"Back-蓝"</span>] imageWithRenderingMode:<span class="built_in">UIImageRenderingModeAlwaysOriginal</span>]</span><br><span class="line">style:<span class="built_in">UIBarButtonItemStylePlain</span></span><br><span class="line">target:<span class="keyword">self</span></span><br><span class="line">action:<span class="keyword">@selector</span>(leftBarButtonClick)];</span><br><span class="line"><span class="comment">// 防止返回手势失效</span></span><br><span class="line"><span class="keyword">self</span>.navigationController.interactivePopGestureRecognizer.delegate = (<span class="keyword">id</span>&lt;<span class="built_in">UIGestureRecognizerDelegate</span>&gt;)<span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 返回按钮的点击事件</span></span><br><span class="line">- (<span class="keyword">void</span>)leftBarButtonClick &#123;</span><br><span class="line">[<span class="keyword">self</span>.navigationController popViewControllerAnimated:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然这里需要判断一下，不然首层控制器的导航栏上也会被设置上返回按钮 <code>leftBarButtonItem</code>，我是在 <code>- (void)viewDidLoad</code> 方法中判断的。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否有上级页面，有的话再调用</span></span><br><span class="line"><span class="keyword">if</span> (<span class="meta">[</span><span class="built_in">self</span>.navigationController.viewControllers indexOfObject:<span class="built_in">self</span><span class="meta">]</span> &gt; 0) &#123;</span><br><span class="line"><span class="meta">[</span><span class="built_in">self</span> setupLeftBarButton<span class="meta">]</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.接下来我们一起设置下 <code>View</code> 中视图的布局，根据视图中控件的最大的 Y 值和最大的 X 值调整 <code>View</code> 的 <code>frame</code> 。这个主要用在视图中控件比较多的时候，也需要具体分析，比如有时候应用中全是 <code>UITableView</code>，那么就不需要设置了，因为 <code>UITableView</code> 可以根据 <code>cell</code> 自动调整 <code>frame</code>。不过也有用到的时候，比如应用中需要计算高度的类有很多，那么就可以用这个统一设置，主要还是看项目需求。另外注意这个方法要放在 <code>- (void)viewWillAppear:(BOOL)animated</code>中。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewWillAppear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">[<span class="keyword">super</span> viewWillAppear:animated];</span><br><span class="line"></span><br><span class="line"><span class="built_in">CGFloat</span> baseViewHeight = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">CGFloat</span> baseViewWidth = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">NSArray</span> *subViews = <span class="keyword">self</span>.baseView.subviews;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历视图中的所有控件，求出最大的Y值和最大的X值</span></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">UIView</span> *view <span class="keyword">in</span> subViews) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">CGRectGetMaxY</span>(view.frame) &gt; baseViewHeight) &#123;</span><br><span class="line">baseViewHeight = <span class="built_in">CGRectGetMaxY</span>(view.frame);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">CGRectGetMaxX</span>(view.frame) &gt; baseViewWidth) &#123;</span><br><span class="line">baseViewWidth = <span class="built_in">CGRectGetMaxX</span>(view.frame);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 三目运算方法求出最大的宽是否大于屏幕宽，以及最大的高是否大于屏幕高</span></span><br><span class="line"><span class="built_in">CGFloat</span> NNHeight = baseViewHeight &gt; NNBaseViewSizeHeight ? baseViewHeight:NNBaseViewSizeHeight;</span><br><span class="line"><span class="built_in">CGFloat</span> NNWidth = baseViewWidth &gt; NNBaseViewSizeWidth ? baseViewWidth:NNBaseViewSizeWidth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.baseView.contentSize = <span class="built_in">CGSizeMake</span>(NNWidth, NNHeight);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码块中用到了一个属性 <code>baseView</code> ， <code>baseView</code> 属于 <code>UIScrollView</code> 类，相当于一个子视图容器，所有继承自 <code>NNBaseViewController</code> 的控制器都应该把子视图添加到  <code>baseView</code>上，这样才能更新它的 <code>frame</code>。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NNBaseViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** 子视图容器 */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIScrollView</span> *baseView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>另外别忘了在 <code>- (void)viewDidLoad</code> 这个方法中创建<code>baseView</code>并设置它的属性。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.baseView = [[<span class="built_in">UIScrollView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">64</span>, [<span class="built_in">UIScreen</span> mainScreen].bounds.size.width, [<span class="built_in">UIScreen</span> mainScreen].bounds.size.height - <span class="number">64</span>)];</span><br><span class="line"><span class="comment">// 是否反弹</span></span><br><span class="line"><span class="keyword">self</span>.baseView.bounces = <span class="literal">NO</span>;</span><br><span class="line"><span class="comment">// 是否显示滚动指示器</span></span><br><span class="line"><span class="keyword">self</span>.baseView.showsVerticalScrollIndicator = <span class="literal">NO</span>;</span><br><span class="line"><span class="keyword">self</span>.baseView.showsHorizontalScrollIndicator = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.baseView];</span><br><span class="line"><span class="keyword">self</span>.baseView.contentSize = NNContentSize;</span><br></pre></td></tr></table></figure>
<p>上面便是一个基本的 <code>UIViewController</code> 的基类，具体还是要根据项目的需要来设计。</p>
<hr>
<h4 id="接下来是完整的代码："><a href="#接下来是完整的代码：" class="headerlink" title="接下来是完整的代码："></a>接下来是完整的代码：</h4><h6 id="NNBaseViewController-h"><a href="#NNBaseViewController-h" class="headerlink" title="NNBaseViewController.h"></a>NNBaseViewController.h</h6><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NNBaseViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** 子视图容器 */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIScrollView</span> *baseView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h6 id="NNBaseViewController-m"><a href="#NNBaseViewController-m" class="headerlink" title="NNBaseViewController.m"></a>NNBaseViewController.m</h6><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"NNBaseViewController.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#define NNBaseViewSize self.baseView.bounds.size</span></span><br><span class="line"><span class="meta">#define NNBaseViewSizeHeight self.baseView.bounds.size.height</span></span><br><span class="line"><span class="meta">#define NNBaseViewSizeWidth self.baseView.bounds.size.width</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NNBaseViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NNBaseViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">[<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">[<span class="keyword">self</span> setupViews];</span><br><span class="line"><span class="comment">// 判断是否有上级页面，有的话再调用</span></span><br><span class="line"><span class="keyword">if</span> ([<span class="keyword">self</span>.navigationController.viewControllers indexOfObject:<span class="keyword">self</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">[<span class="keyword">self</span> setupLeftBarButton];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setupViews &#123;</span><br><span class="line"><span class="comment">// 设置应用的背景色</span></span><br><span class="line"><span class="keyword">self</span>.view.backgroundColor = [<span class="built_in">UIColor</span> lightGrayColor];</span><br><span class="line"><span class="comment">// 不允许 viewController 自动调整，我们自己布局；如果设置为YES，视图会自动下移 64 像素</span></span><br><span class="line"><span class="keyword">self</span>.automaticallyAdjustsScrollViewInsets = <span class="literal">NO</span>;</span><br><span class="line"><span class="keyword">self</span>.baseView = [[<span class="built_in">UIScrollView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">64</span>, [<span class="built_in">UIScreen</span> mainScreen].bounds.size.width, [<span class="built_in">UIScreen</span> mainScreen].bounds.size.height - <span class="number">64</span>)];</span><br><span class="line"><span class="comment">// 是否反弹</span></span><br><span class="line"><span class="keyword">self</span>.baseView.bounces = <span class="literal">NO</span>;</span><br><span class="line"><span class="comment">// 是否显示滚动指示器</span></span><br><span class="line"><span class="keyword">self</span>.baseView.showsVerticalScrollIndicator = <span class="literal">NO</span>;</span><br><span class="line"><span class="keyword">self</span>.baseView.showsHorizontalScrollIndicator = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.baseView];</span><br><span class="line"><span class="keyword">self</span>.baseView.contentSize = NNBaseViewSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewWillAppear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">[<span class="keyword">super</span> viewWillAppear:animated];</span><br><span class="line"></span><br><span class="line"><span class="built_in">CGFloat</span> baseViewHeight = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">CGFloat</span> baseViewWidth = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">NSArray</span> *subViews = <span class="keyword">self</span>.baseView.subviews;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历视图中的所有控件，求出最大的Y值和最大的X值</span></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">UIView</span> *view <span class="keyword">in</span> subViews) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">CGRectGetMaxY</span>(view.frame) &gt; baseViewHeight) &#123;</span><br><span class="line">baseViewHeight = <span class="built_in">CGRectGetMaxY</span>(view.frame);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">CGRectGetMaxX</span>(view.frame) &gt; baseViewWidth) &#123;</span><br><span class="line">baseViewWidth = <span class="built_in">CGRectGetMaxX</span>(view.frame);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 三目运算方法求出最大的宽和最大的高</span></span><br><span class="line"><span class="built_in">CGFloat</span> NNHeight = baseViewHeight &gt; NNBaseViewSizeHeight ? baseViewHeight:NNBaseViewSizeHeight;</span><br><span class="line"><span class="built_in">CGFloat</span> NNWidth = baseViewWidth &gt; NNBaseViewSizeWidth ? baseViewWidth:NNBaseViewSizeWidth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.baseView.contentSize = <span class="built_in">CGSizeMake</span>(NNWidth, NNHeight);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 自定义返回按钮</span></span><br><span class="line">- (<span class="keyword">void</span>)setupLeftBarButton &#123;</span><br><span class="line"><span class="comment">// 自定义 leftBarButtonItem ，UIImageRenderingModeAlwaysOriginal 防止图片被渲染</span></span><br><span class="line"><span class="keyword">self</span>.navigationItem.leftBarButtonItem = [[<span class="built_in">UIBarButtonItem</span> alloc]</span><br><span class="line">initWithImage:[[<span class="built_in">UIImage</span> imageNamed:<span class="string">@"Back-蓝"</span>] imageWithRenderingMode:<span class="built_in">UIImageRenderingModeAlwaysOriginal</span>]</span><br><span class="line">style:<span class="built_in">UIBarButtonItemStylePlain</span></span><br><span class="line">target:<span class="keyword">self</span></span><br><span class="line">action:<span class="keyword">@selector</span>(leftBarButtonClick)];</span><br><span class="line"><span class="comment">// 防止返回手势失效</span></span><br><span class="line"><span class="keyword">self</span>.navigationController.interactivePopGestureRecognizer.delegate = (<span class="keyword">id</span>&lt;<span class="built_in">UIGestureRecognizerDelegate</span>&gt;)<span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 返回按钮的点击事件</span></span><br><span class="line">- (<span class="keyword">void</span>)leftBarButtonClick &#123;</span><br><span class="line">[<span class="keyword">self</span>.navigationController popViewControllerAnimated:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/用 RunTime 为 UITextView 设置占位文本并实时改变文本框占位文本的颜色/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/用 RunTime 为 UITextView 设置占位文本并实时改变文本框占位文本的颜色/" itemprop="url">
                  用 RunTime 为 UITextView 设置占位文本并实时改变文本框占位文本的颜色
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><code>UITextView</code> 实现占位文本的方式有很多种，网上一搜一大把，，这里只介绍 <strong>最简单</strong> 的一种，如标题所述：<strong>用 <code>RunTime</code> 为 <code>UITextView</code> 设置占位文本并实时改变文本框占位文本的颜色。</strong></p>
</blockquote>
<blockquote>
<p>对 <code>RunTime</code> 不太了解的童鞋可以简单看下这篇文章：<a href="http://www.jianshu.com/p/d92452217f68" target="_blank" rel="noopener">iOS开发之 - Runtime</a>，懒得点击鼠标的话我这里也简单的说下，<code>Runtime 简称运行时，是苹果官方的一套比较底层的纯 C 语言 API, 用它可以做很多底层操作（比如访问隐藏的成员变量和方法）。</code></p>
</blockquote>
<p>OK，足够了，接下来我们就抓紧时间来看看如何用 RunTime 为 UITextView 设置占位文本并实时改变文本框占位文本的颜色。。。</p>
<h5 id="首先我们利用-RunTime-获取一下-UITextView-中一些隐藏的成员变量"><a href="#首先我们利用-RunTime-获取一下-UITextView-中一些隐藏的成员变量" class="headerlink" title="首先我们利用 RunTime 获取一下 UITextView 中一些隐藏的成员变量"></a>首先我们利用 RunTime 获取一下 UITextView 中一些隐藏的成员变量</h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">[<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line"><span class="comment">//  获取 UITextView 中所有的成员变量</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">Ivar *ivars = class_copyIvarList([<span class="built_in">UITextView</span> <span class="keyword">class</span>], &amp;count);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i ++) &#123;</span><br><span class="line">Ivar ivar = ivars[i];</span><br><span class="line"><span class="comment">// ivar_getName(ivar) 意思是获取成员变量名字，如果想获得成员变量的类型用这个 ivar_getTypeEncoding(ivar)</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name = ivar_getName(ivar);</span><br><span class="line"><span class="built_in">NSString</span> *objcName = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"    %d     %@    "</span>, i, objcName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 释放</span></span><br><span class="line">free(ivars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="打印结果如下（这里直接放截图）"><a href="#打印结果如下（这里直接放截图）" class="headerlink" title="打印结果如下（这里直接放截图）"></a>打印结果如下（这里直接放截图）</h5><p><img src="http://upload-images.jianshu.io/upload_images/2665449-065666a1bd7773b1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="UITextView 中的属性"></p>
<p>从上面的截图中我们可以看出，打印的结果里有一个 <code>placeHolderLabel</code> 的私有变量，即 <strong>UITextView 类内部有一个名为“_placeHolderLabel”的私有成员变量</strong>。那么就简单多了，我们现在就对这个私有变量进行操作。具体的步骤如下：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (void)setupTextView &#123;</span><br><span class="line">_textView = [[UITextView alloc] initWithFrame:CGRectMake(<span class="number">0</span>, <span class="number">50</span>, [UIScreen mainScreen].<span class="keyword">bounds.size.width, </span><span class="number">200</span>)]<span class="comment">;</span></span><br><span class="line">_textView.delegate = self<span class="comment">;</span></span><br><span class="line">_textView.tintColor = [UIColor whiteColor]<span class="comment">;</span></span><br><span class="line">_textView.font = [UIFont systemFontOfSize:<span class="number">15</span>.f]<span class="comment">;</span></span><br><span class="line">_textView.<span class="keyword">backgroundColor </span>=[UIColor grayColor]<span class="comment">;</span></span><br><span class="line">[self.view <span class="keyword">addSubview:_textView];</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">UILabel </span>*placeholderLabel = [[UILabel alloc] init]<span class="comment">;</span></span><br><span class="line">placeholderLabel<span class="meta">.text</span> = @<span class="string">"请输入内容请输入内容请输入内容请输入内容请输入内容请输入内容请输入内容请输入内容请输入内容请输入内容请输入内容"</span><span class="comment">;</span></span><br><span class="line">placeholderLabel.font = [UIFont systemFontOfSize:<span class="number">15</span>.f]<span class="comment">;</span></span><br><span class="line">placeholderLabel.textColor = [UIColor whiteColor]<span class="comment">;</span></span><br><span class="line">placeholderLabel.numberOfLines = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">[placeholderLabel sizeToFit]<span class="comment">;</span></span><br><span class="line">[_textView <span class="keyword">addSubview:placeholderLabel];</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">[_textView </span>setValue:placeholderLabel forKey:@<span class="string">"_placeholderLabel"</span>]<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码做的事情，<strong>无非是创建一个 UITextView 和一个 UILabel 控件，然后通过键值对的原理给 UITextView 中的 _placeholderLabel 这一属性赋值</strong>，，，就不详细注释了，重要的是这种思想。。。只需上面这段代码，我们就已经完成了利用 RunTime 为 UITextView 设置占位文本。效果图如下，比较丑但很实用😂：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-85668f6a6f72ba93.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="为 UITextView 设置占位文本"></p>
<h5 id="接下来我们开始实时改变文本框占位文本的颜色。"><a href="#接下来我们开始实时改变文本框占位文本的颜色。" class="headerlink" title="接下来我们开始实时改变文本框占位文本的颜色。"></a>接下来我们开始实时改变文本框占位文本的颜色。</h5><p>举个栗子：当我们开始输入时占位文本是白色，结束输入时占位文本是灰色。那我们在哪里设置比较好呢？我在 UITextViewDelegate 中找到了两个方法，可以解决我们的需求</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(BOOL)</span>textViewShouldBeginEditing:<span class="params">(UITextView *)</span>textView;</span><br><span class="line">- <span class="params">(BOOL)</span>textViewShouldEndEditing:<span class="params">(UITextView *)</span>textView;</span><br></pre></td></tr></table></figure>
<p>看名字就能猜到这俩方法是干嘛的了，这里不再多说，，，我们需要在这两个方法里进行一些操作，先贴代码。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - UITextViewDelegate</span></span><br><span class="line"><span class="meta">#pragma mark - 开始编辑 UITextView</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)textViewShouldBeginEditing:(<span class="built_in">UITextView</span> *)textView &#123;</span><br><span class="line"><span class="comment">// 设置高亮时，占位文字颜色为白色</span></span><br><span class="line">[_textView setValue:[<span class="built_in">UIColor</span> whiteColor] forKeyPath:<span class="string">@"_placeholderLabel.textColor"</span>];</span><br><span class="line"><span class="comment">// 设置光标颜色为白色</span></span><br><span class="line">_textView.tintColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line"><span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 结束编辑 UITextView</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)textViewShouldEndEditing:(<span class="built_in">UITextView</span> *)textView &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置非高亮状态下，占位文字颜色为 lightGrayColor</span></span><br><span class="line">[_textView setValue:[<span class="built_in">UIColor</span> lightGrayColor] forKeyPath:<span class="string">@"_placeholderLabel.textColor"</span>];</span><br><span class="line"><span class="comment">// 设置光标颜色为 lightGrayColor</span></span><br><span class="line">_textView.tintColor = [<span class="built_in">UIColor</span> lightGrayColor];</span><br><span class="line"><span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和上文设置占位文本的思想一样，这里也是 <strong>根据键值对的原理给 _placeholderLabel.textColor 赋值</strong>，开始编辑时设置为白色，结束编辑时设置为 lightGrayColor，具体请看代码中的注释。</p>
<p>到这里实时改变文本框占位文本的颜色也搞定了，是不是觉得很简单，先看下效果图（比较丑但很使用😂），文章结尾我会再次贴出完整的代码。。。自己以后看着方便，也可以帮助有需要的道友少走弯路，，不过文章如果有需要改正或改进的地方，还希望各位同行能多多指点。</p>
<h5 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h5><p><img src="http://upload-images.jianshu.io/upload_images/2665449-f89dfd4f1b745501.gif?imageMogr2/auto-orient/strip" alt="为 UITextView 设置占位文本并实时改变文本框占位文本的颜色"></p>
<h5 id="在需要-UITextView-的页面进行设置，NNViewController-h-中没有相关操作，直接在NNViewController-m-中进行设置即可，当然如果项目中用到-UITextView-这个类比较多的话，你也可以简单封装一下，以便多次利用。。。以下是全部代码"><a href="#在需要-UITextView-的页面进行设置，NNViewController-h-中没有相关操作，直接在NNViewController-m-中进行设置即可，当然如果项目中用到-UITextView-这个类比较多的话，你也可以简单封装一下，以便多次利用。。。以下是全部代码" class="headerlink" title="在需要 UITextView  的页面进行设置，NNViewController.h 中没有相关操作，直接在NNViewController.m 中进行设置即可，当然如果项目中用到 UITextView 这个类比较多的话，你也可以简单封装一下，以便多次利用。。。以下是全部代码"></a>在需要 <code>UITextView</code>  的页面进行设置，<code>NNViewController.h</code> 中没有相关操作，直接在<code>NNViewController.m</code> 中进行设置即可，当然如果项目中用到 <code>UITextView</code> 这个类比较多的话，你也可以简单封装一下，以便多次利用。。。以下是全部代码</h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"NNViewController.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NNViewController</span> ()&lt;<span class="title">UITextViewDelegate</span>&gt; </span>&#123;</span><br><span class="line"><span class="built_in">UITextView</span> *_textView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NNViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">[<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line"><span class="comment">//  获取 UITextView 中所有的成员变量</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">Ivar *ivars = class_copyIvarList([<span class="built_in">UITextView</span> <span class="keyword">class</span>], &amp;count);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i ++) &#123;</span><br><span class="line">Ivar ivar = ivars[i];</span><br><span class="line"><span class="comment">// ivar_getName(ivar) 意思是获取成员变量名字，如果想获得成员变量的类型用这个 ivar_getTypeEncoding(ivar)</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name = ivar_getName(ivar);</span><br><span class="line"><span class="built_in">NSString</span> *objcName = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"    %d     %@    "</span>, i, objcName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 释放</span></span><br><span class="line">free(ivars);</span><br><span class="line">[<span class="keyword">self</span> setupTextView];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setupTextView &#123;</span><br><span class="line">_textView = [[<span class="built_in">UITextView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">50</span>, [<span class="built_in">UIScreen</span> mainScreen].bounds.size.width, <span class="number">200</span>)];</span><br><span class="line">_textView.delegate = <span class="keyword">self</span>;</span><br><span class="line">_textView.tintColor = [<span class="built_in">UIColor</span> lightGrayColor];</span><br><span class="line">_textView.font = [<span class="built_in">UIFont</span> systemFontOfSize:<span class="number">15.</span>f];</span><br><span class="line">_textView.backgroundColor =[<span class="built_in">UIColor</span> grayColor];</span><br><span class="line">[<span class="keyword">self</span>.view addSubview:_textView];</span><br><span class="line"></span><br><span class="line"><span class="built_in">UILabel</span> *placeholderLabel = [[<span class="built_in">UILabel</span> alloc] init];</span><br><span class="line">placeholderLabel.text = <span class="string">@"请输入内容请输入内容请输入内容请输入内容请输入内容请输入内容请输入内容请输入内容请输入内容请输入内容请输入内容"</span>;</span><br><span class="line">placeholderLabel.font = [<span class="built_in">UIFont</span> systemFontOfSize:<span class="number">15.</span>f];</span><br><span class="line">placeholderLabel.textColor = [<span class="built_in">UIColor</span> lightGrayColor];</span><br><span class="line">placeholderLabel.numberOfLines = <span class="number">0</span>;</span><br><span class="line">[placeholderLabel sizeToFit];</span><br><span class="line">[_textView addSubview:placeholderLabel];</span><br><span class="line"></span><br><span class="line">[_textView setValue:placeholderLabel forKey:<span class="string">@"_placeholderLabel"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - UITextViewDelegate</span></span><br><span class="line"><span class="meta">#pragma mark - 开始编辑 UITextView</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)textViewShouldBeginEditing:(<span class="built_in">UITextView</span> *)textView &#123;</span><br><span class="line"><span class="comment">// 设置高亮时，占位文字颜色为白色</span></span><br><span class="line">[_textView setValue:[<span class="built_in">UIColor</span> whiteColor] forKeyPath:<span class="string">@"_placeholderLabel.textColor"</span>];</span><br><span class="line"><span class="comment">// 设置光标颜色为白色</span></span><br><span class="line">_textView.tintColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line"><span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 结束编辑 UITextView</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)textViewShouldEndEditing:(<span class="built_in">UITextView</span> *)textView &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置非高亮状态下，占位文字颜色为 lightGrayColor</span></span><br><span class="line">[_textView setValue:[<span class="built_in">UIColor</span> lightGrayColor] forKeyPath:<span class="string">@"_placeholderLabel.textColor"</span>];</span><br><span class="line"><span class="comment">// 设置光标颜色为 lightGrayColor</span></span><br><span class="line">_textView.tintColor = [<span class="built_in">UIColor</span> lightGrayColor];</span><br><span class="line"><span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - 点击空白页面时收回键盘</span></span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">[<span class="keyword">self</span>.view endEditing:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/设计模式-《重构》读书笔记及 APP 重构心得/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/设计模式-《重构》读书笔记及 APP 重构心得/" itemprop="url">
                  设计模式-《重构》读书笔记及 APP 重构心得
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>前段时间和一同事一起重构了两个 APP，正好想写一些重构心得，前天又在知乎上看到一前辈推荐《重构》这本书，据说是程序员的必读书籍，于是就粗略的读了一遍，对重构有了更深层次的认识了。这里结合 iOS 项目的重构，谈谈与重构相关的问题，做一下记录及分享。</p>
</blockquote>
<h2 id="一、《重构》读书笔记"><a href="#一、《重构》读书笔记" class="headerlink" title="一、《重构》读书笔记"></a>一、《重构》读书笔记</h2><h4 id="1-1-重构的定义"><a href="#1-1-重构的定义" class="headerlink" title="1.1 重构的定义"></a>1.1 重构的定义</h4><ul>
<li>“重构”这个词有两种不同的定义：</li>
<li>第一个定义是名词形式：<br><strong>重构（名词）：对软件内部结构的一种调整，目的是在不改变软件可观察行为的前提下，提高其可理解性，降低其修改成本。</strong></li>
<li>第二个定义是动词形式：<br><strong>重构（动词）：使用一系列重构手法，在不改变软件可观察行为的前提下，调整其结构。</strong></li>
</ul>
<p>重构的定义说明了两点，第一，重构的目的是使软件更容易被理解和修改；第二，重构不会改变软件可观察的行为——重构之后软件功能一如既往。</p>
<h4 id="1-2-为何重构？"><a href="#1-2-为何重构？" class="headerlink" title="1.2 为何重构？"></a>1.2 为何重构？</h4><ul>
<li><p><strong>重构可以帮你始终良好的控制自己的代码，它可以用于以下几个目的：</strong></p>
</li>
<li><p><strong>重构改进软件设计</strong><br>如果没有重构，程序的设计会逐渐腐败变质。当人们只为短期目的，或是在完全理解整体设计之前，就贸然修改代码，程序将逐渐失去自己的结构，程序员越来越难通过阅读源码而理解原来的设计。<br>完成同一件事情，设计不良的程序往往需要更多代码，这常常是因为代码在不同的地方使用完全相同的语句做同样的事情。因此改进设计的一个重要方向就是消除重复代码。</p>
</li>
<li><p><strong>重构使软件更容易理解</strong><br>书的前面有这么一句话：“任何一个傻瓜都能写出计算机可以理解的代码，唯有写出人类容易理解的代码，才是优秀的程序员。”而重构可以使代码结构更清晰，使代码更容易被理解。</p>
</li>
<li><p><strong>重构帮助找到 bug</strong><br>对代码进行重构，可以深入理解代码的作为，并恰到好处地把新的理解反馈回去，在重构的同时，我们可以发现某些代码逻辑写的不严谨或有问题。</p>
</li>
<li><p><strong>重构提高编程速度</strong><br>良好设计师维持软件开发速度的根本，重构可以帮你更快速地开发软件，因为它阻止系统腐败变质，它甚至还可以提高设计质量。</p>
</li>
</ul>
<h4 id="1-3-何时重构？"><a href="#1-3-何时重构？" class="headerlink" title="1.3 何时重构？"></a>1.3 何时重构？</h4><ul>
<li><p>怎样安排重构时间表？是不是应该每两个月就专门安排两个星期来进行重构呢？这里需要说明，重构不是一件应该特别拨出时间做的事情，重构应该随时随地进行。不应该为重构而重构，我们之所以重构，是因为想做别的事情，而重构可以帮助我们把那些事做好。</p>
</li>
<li><p><strong>三次法则（事不过三，三则重构）</strong><br>第一次做某件事时只管去做；第二次做类似的事情会产生反感，但还是可以去做；第三次再做类似的事情，就应该重构了。</p>
</li>
<li><p><strong>添加功能时重构</strong><br>最常见的重构时机就是我们想给软件添加新特性的时候，此时，重构的直接原因往往是为了帮助我们理解需要修改的代码——这些代码可能是别人写的，也可能是自己写的。</p>
</li>
<li><p><strong>修补错误时重构</strong><br>调试过程中重构，多半是为了让代码更具有可读性。</p>
</li>
<li><p><strong>复审代码时重构</strong><br>代码复审对于编写清晰代码很重要，比如我的代码也许对我自己来说很清晰，但对他人则不然，这是无法避免的，代码复审会让更多人有机会提出有用的建议，然后考虑是否可以通过重构来轻松的实现它们。</p>
</li>
</ul>
<h4 id="1-4-重构的基本技巧："><a href="#1-4-重构的基本技巧：" class="headerlink" title="1.4 重构的基本技巧："></a>1.4 重构的基本技巧：</h4><ul>
<li><strong>小步前进、频繁测试</strong></li>
</ul>
<h2 id="二、结合-iOS-项目重构心得"><a href="#二、结合-iOS-项目重构心得" class="headerlink" title="二、结合 iOS 项目重构心得"></a>二、结合 iOS 项目重构心得</h2><h4 id="2-1-项目目录结构"><a href="#2-1-项目目录结构" class="headerlink" title="2.1 项目目录结构"></a>2.1 项目目录结构</h4><p>项目的目录结构是开发中最基础的，但也是很重要的，清晰的目录结构能够让人一眼就看懂该项目的业务及功能，目录结构也能反应一个开发者的经验及架构水平。项目目录结构比较常规的有两种，第一种是按照业务分类，第二种是按照模块分类。当然具体还得根据具体的业务需求来做，适合自己的才是最好的。</p>
<p>这里有一篇关于项目目录结构的文章，有兴趣的童鞋可以读下：<a href="https://www.jianshu.com/p/77a948bcbc38" target="_blank" rel="noopener">iOS 项目的目录结构能看出你的开发经验</a></p>
<h4 id="2-2-业务与-UI"><a href="#2-2-业务与-UI" class="headerlink" title="2.2 业务与 UI"></a>2.2 业务与 UI</h4><p>这里不讨论 MVC 架构与 MVVM 架构，关于架构模式之间的争论有很多，个人比较赞同一个观点：<a href="https://www.jianshu.com/p/8c4679073393" target="_blank" rel="noopener">不要局限于 MVC、MVVM、MVP 等等一些架构模式，万变不离其宗，真正适用于项目的架构才是最好的架构。</a>刚接手的旧项目在设计初期以及开发过程中，没有进行合理的规划，以至于一些控制器过于臃肿，代码量很多都是超过了 1000 行，有的甚至超过了 1500 行，而且写的很乱。重构的目的，就是提高代码的可读性以及便于以后的维护，我这里按照 MVC 的架构模式，将 UI 部分进行抽离，将工具代码（比如计算球面两点之间的距离）进行封装，并放到了相关的工具类中，又对控制器中的冗余代码进行了整理，使得控制器中的代码减少至之前的三分之一以下。分享一张 cocoa 上的 MVC 架构图：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-afbd6c99f54d9c04.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MVC 架构"></p>
<h4 id="2-3-代码还是-xib、-storyboard？"><a href="#2-3-代码还是-xib、-storyboard？" class="headerlink" title="2.3 代码还是 xib、 storyboard？"></a>2.3 代码还是 xib、 storyboard？</h4><p>写 UI 界面用代码还是用 xib 一直是 iOS 界的争论，有的人倾向于使用代码，有的人倾向于使用 xib，巧神之前在博客中也讨论过这个问题，并给出了一些建议（个人比较赞同👍）：</p>
<ul>
<li>对于复杂的、动态生成的界面，建议使用手工编写界面。</li>
<li>对于需要统一风格的按钮或 UI 控件，建议使用手工用代码来构造。方便之后的修改和复用。</li>
<li>对于需要有继承或组合关系的 UIView 类或 UIViewController 类，建议用代码手工编写界面。</li>
<li>对于那些简单的、静态的、非核心功能界面，可以考虑使用 xib 或 storyboard 来完成。</li>
</ul>
<p>这里是巧神关于写 UI 用代码还是用 xib 的相关讨论： <a href="http://blog.devtang.com/2015/03/22/ios-dev-controversy-2/" title="iOS 开发中的争议（二）" target="_blank" rel="noopener">iOS 开发中的争议（二）</a></p>
<h4 id="2-4-模块化设计"><a href="#2-4-模块化设计" class="headerlink" title="2.4 模块化设计"></a>2.4 模块化设计</h4><p>什么是模块化？比如我们刚开始码代码的时候，有一个经常用的方法（比如还是计算球面两点之间的距离），由于这个方法经常用，我们会把这段代码拿出来放到一个公共类里，以便实现代码的复用，这就是简单的模块化。关于模块化设计的原则，一位阿里大神的建议如下：</p>
<ul>
<li>越底层的模块，应该越稳定，越抽象，越具有高复用度。</li>
<li>不要让稳定的模块依赖不稳定的模块， 减少依赖。</li>
<li>每个模块只做好一件事情，不要让 Common 出现（避免一大堆不相干的代码放进一个模块）。</li>
<li>按照架构的层数从上到下依赖，不要出现下层模块依赖上层模块的现象<br>业务模块之间也尽量不要耦合。</li>
</ul>
<p>对模块化设计感兴趣的童鞋可以看下这篇文章，绝对干货！<a href="https://blog.cnbluebox.com/blog/2015/11/28/module-and-decoupling/?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io" target="_blank" rel="noopener">模块化与解耦</a></p>
<h4 id="2-5-代码规范"><a href="#2-5-代码规范" class="headerlink" title="2.5 代码规范"></a>2.5 代码规范</h4><p>关于代码规范，每个程序员遵守的代码规范多多少少都会有些不同（比如什么时候该空格，常量变量的命名方式等等），之前听一前辈说过，尽量遵守那些“约定俗成”的代码规范，另外在编码时，要保证自己的代码规范始终一致，别给人一种你写的代码是几个人共写的错觉。</p>
<ul>
<li>命名规范<br>iOS 命名主要注意两个方面，第一是可读性高，别人一看这个名字就知道它的含义及作用；第二是防止命名冲突，命名时应遵循驼峰式命名法则，另外要加前缀，比如常量命名一般会在前面加上字母 k。</li>
<li><p>编码规范<br>关于编码规范有很多细节需要注意，比如函数方法一般不能过长；比如实例变量的修饰符要注意；再比如尽可能保证 .h 文件简洁，API 尽量写在实现文件里……编码时还有其它一些应该注意的，比如写 delegate 的时候类型应该为 weak，以避免循环引用；再比如经典的圆角问题，过多的使用 layer.masksToBounds 对系统的开销非常大，会使页面变的卡顿等等……这些编码细节有很多需要注意，就不一一列举了。</p>
</li>
<li><p>写注释<br>写注释写注释写注释，重要的事情说三遍😂。注释可以帮助其他同事更好的理解你写的代码，还方便自己以后的阅读。</p>
</li>
</ul>
<p>代码规范方面，这里也推荐一篇不错的文章：<a href="https://www.jianshu.com/p/b6dc945957fc" target="_blank" rel="noopener">iOS开发-代码细节优化(长期更新)</a></p>
<p>再安利一本书，《编写高质量 iOS 与 OS X 代码的 52 个有效方法》，这本书对编码时应注意的细节写的很全面，之前读过一遍，过几天会再读一遍，并记录。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之 - 键盘处理神器 IQKeyboardManager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之 - 键盘处理神器 IQKeyboardManager/" itemprop="url">
                  iOS开发之 - 键盘处理神器 IQKeyboardManager
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>  年后上班第一天，比较闲，上午的时候抽空整理了<code>iOS</code>开发中常用的易忘知识点：<a href="http://www.jianshu.com/p/328a4c65dc5c" target="_blank" rel="noopener">iOS开发之 - 小冷易忘知识点总结</a>，有兴趣的朋友们可以去看看。下午整理了之前用过的一个第三方库——键盘处理神器  <code>IQKeyboardManager</code>。</p>
</blockquote>
<blockquote>
<p>平常在开发中，用到输入框的地方不胜其数，当输入框位于屏幕底部时，弹起的键盘很可能覆盖输入框，导致用户看不到输入结果，体验较差…… <code>IQKeyboardManager</code> 可以很简单快捷的解决键盘遮盖输入框的问题，接下来就一起来学习一下吧。</p>
</blockquote>
<ul>
<li><p>先简单认识下 IQKeyboardManager<br>GitHub 地址：<a href="https://github.com/hackiftekhar/IQKeyboardManager" target="_blank" rel="noopener">GitHub 地址</a></p>
</li>
<li><p>官方示意效果图如下：</p>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-85b8ad91640b23c3.gif?imageMogr2/auto-orient/strip" alt="官方示意效果图"></p>
<hr>
<p>再贴一下自己做的简单效果图☺️<br>先说下我的 Xcode 版本是：Version 8.1 (8B62)，简单起见直接在 Main.storyboard 中拖入 7 个UITextField， 每个 UITextField 都设有占位文字。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-1cabc35287b06995.gif?imageMogr2/auto-orient/strip" alt="简单效果图☺️"></p>
<hr>
<h3 id="以下是-IQKeyboardManager-的一些具体使用"><a href="#以下是-IQKeyboardManager-的一些具体使用" class="headerlink" title="以下是 IQKeyboardManager 的一些具体使用"></a>以下是 IQKeyboardManager 的一些具体使用</h3><h4 id="1-用-Cocoapod-导入或直接下载拖进去，这里方便起见直接用-Cocoapod-导入。"><a href="#1-用-Cocoapod-导入或直接下载拖进去，这里方便起见直接用-Cocoapod-导入。" class="headerlink" title="1. 用 Cocoapod  导入或直接下载拖进去，这里方便起见直接用 Cocoapod 导入。"></a>1. 用 Cocoapod  导入或直接下载拖进去，这里方便起见直接用 Cocoapod 导入。</h4><p>IQKeyboardManager 的 GitHub地址：<a href="https://github.com/hackiftekhar/IQKeyboardManager" target="_blank" rel="noopener">IQKeyboardManager 的 GitHub 地址</a></p>
<h4 id="2-在-AppDelegate-m-中导入头文件"><a href="#2-在-AppDelegate-m-中导入头文件" class="headerlink" title="2. 在 AppDelegate.m 中导入头文件"></a>2. 在 AppDelegate.m 中导入头文件</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;IQKeyboardManager/IQKeyboardManager.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<h4 id="3-在-AppDelegate-中设置全局属性"><a href="#3-在-AppDelegate-中设置全局属性" class="headerlink" title="3. 在 AppDelegate 中设置全局属性"></a>3. 在 AppDelegate 中设置全局属性</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line"></span><br><span class="line">IQKeyboardManager *keyboardManager = [IQKeyboardManager sharedManager]; <span class="comment">// 获取类库的单例变量</span></span><br><span class="line"></span><br><span class="line">keyboardManager.enable = <span class="literal">YES</span>; <span class="comment">// 控制整个功能是否启用</span></span><br><span class="line"></span><br><span class="line">keyboardManager.shouldResignOnTouchOutside = <span class="literal">YES</span>; <span class="comment">// 控制点击背景是否收起键盘</span></span><br><span class="line"></span><br><span class="line">keyboardManager.shouldToolbarUsesTextFieldTintColor = <span class="literal">YES</span>; <span class="comment">// 控制键盘上的工具条文字颜色是否用户自定义</span></span><br><span class="line"></span><br><span class="line">keyboardManager.toolbarManageBehaviour = IQAutoToolbarBySubviews; <span class="comment">// 有多个输入框时，可以通过点击Toolbar 上的“前一个”“后一个”按钮来实现移动到不同的输入框</span></span><br><span class="line"></span><br><span class="line">keyboardManager.enableAutoToolbar = <span class="literal">YES</span>; <span class="comment">// 控制是否显示键盘上的工具条</span></span><br><span class="line"></span><br><span class="line">keyboardManager.shouldShowTextFieldPlaceholder = <span class="literal">YES</span>; <span class="comment">// 是否显示占位文字</span></span><br><span class="line"></span><br><span class="line">keyboardManager.placeholderFont = [<span class="built_in">UIFont</span> boldSystemFontOfSize:<span class="number">17</span>]; <span class="comment">// 设置占位文字的字体</span></span><br><span class="line"></span><br><span class="line">keyboardManager.keyboardDistanceFromTextField = <span class="number">10.0</span>f; <span class="comment">// 输入框距离键盘的距离</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-若某个类不需要使用-IQKeyboardManager，可以在这个类中这样设置"><a href="#4-若某个类不需要使用-IQKeyboardManager，可以在这个类中这样设置" class="headerlink" title="4. 若某个类不需要使用 IQKeyboardManager，可以在这个类中这样设置"></a>4. 若某个类不需要使用 IQKeyboardManager，可以在这个类中这样设置</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="string">viewWillAppear:</span>(BOOL)animated &#123;</span><br><span class="line">[<span class="keyword">super</span> <span class="string">viewWillAppear:</span>animated];</span><br><span class="line">[IQKeyboardManager sharedManager].enable = NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">viewWillDisappear:</span>(BOOL)animated &#123;</span><br><span class="line">[<span class="keyword">super</span> <span class="string">viewWillDisappear:</span>animated];</span><br><span class="line">[IQKeyboardManager sharedManager].enable = YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-常用属性介绍"><a href="#5-常用属性介绍" class="headerlink" title="5. 常用属性介绍"></a>5. 常用属性介绍</h4><ul>
<li><code>sharedManager</code>：获取类库的单例变量</li>
<li><code>enable</code>：项目使用不使用 IQKeyboardManager 这个类库，当然，某些页面可以根据需要单独设置</li>
<li><code>shouldResignOnTouchOutside</code>：点击背景页面时是否收起键盘</li>
<li><code>shouldToolbarUsesTextFieldTintColor</code>：控制键盘上的工具条文字颜色是否用户自定义，默认为 NO</li>
<li><code>toolbarManageBehaviour</code>：有多个输入框时，可以通过点击Toolbar 上的“前一个” “后一个”按钮来实现移动到不同的输入框</li>
<li><code>enableAutoToolbar</code>：是否显示键盘上的工具条</li>
<li><code>shouldShowTextFieldPlaceholder</code>：是否显示占位文字（如果输入框有占位文字，那么在 Toolbar 中默认会显示出来）</li>
<li><code>placeholderFont</code>：占位文字的字体大小</li>
<li><code>keyboardDistanceFromTextField</code>：输入框距离键盘的距离</li>
</ul>
<h4 id="6-再推荐几篇不错的相关文章"><a href="#6-再推荐几篇不错的相关文章" class="headerlink" title="6. 再推荐几篇不错的相关文章"></a>6. 再推荐几篇不错的相关文章</h4><ul>
<li><p><a href="http://www.jianshu.com/p/01c0682003a9" target="_blank" rel="noopener">iOS开发第三方库一 IQKeyboardManager</a></p>
</li>
<li><p><a href="https://my.oschina.net/u/1418722/blog/384477" target="_blank" rel="noopener">自动处理键盘事件的第三方库 IQKeyboardManager</a></p>
</li>
<li><p><a href="http://www.jianshu.com/p/3ea3db5429f3" target="_blank" rel="noopener">iOS开发之处理键盘问题神器IQKeyboardManager</a></p>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之源码解析 - Masonry/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之源码解析 - Masonry/" itemprop="url">
                  iOS开发之源码解析 - Masonry
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>这是 <em>GitHub</em> 上，<a href="https://github.com/SnapKit/Masonry" target="_blank" rel="noopener">Masonry</a> 官方对 <em>Masonry</em> 的介绍：</strong></p>
<blockquote>
<p><a href="https://github.com/SnapKit/Masonry" target="_blank" rel="noopener">Masonry</a>  is a light-weight layout framework which wraps AutoLayout with a nicer syntax. Masonry has its own layout <a href="https://en.wikipedia.org/wiki/Domain-specific_language" target="_blank" rel="noopener">DSL</a> which provides a chainable way of describing your NSLayoutConstraints which results in layout code that is more concise and readable. Masonry supports iOS and Mac OS X.</p>
</blockquote>
<p>译文如下：</p>
<blockquote>
<p><a href="https://github.com/SnapKit/Masonry" target="_blank" rel="noopener">Masonry</a> 是一个轻量级的布局框架，它通过一种友好的语法封装了自动布局。Masonry 通过链式语法 <a href="https://en.wikipedia.org/wiki/Domain-specific_language" target="_blank" rel="noopener">DSL(Domain-specific language)</a> 来封装 NSLayoutConstraints，使布局代码更加地简洁易读。Masonry 支持 iOS 和 Mac OS X。</p>
</blockquote>
<p>在分析 Masonry 源码之前，有必要先说一下 Masonry 的基本使用，而在说 Masonry 的基本使用之前，我们还是先来看看 storyboard 以及 xib 中是如何进行 AutoLayout 的，我截了两张图：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-a305784e0ac30193.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-a97902c3ba89e176.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>从上图我们可以看出，在 storyboard 和 xib 中，我们可以在可视化界面对控件进行 AutoLayout，操作较为简单方便。Masonry 的实现原理与这很相似，接下来我们就一起看看如何使用 Masonry 进行自动布局。</p>
<p>先看一下 Masonry 支持哪些属性：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*    以下属性返回一个新的 MASViewConstraint</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *left;      <span class="comment">// 左侧</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *top;       <span class="comment">// 上侧</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *right;     <span class="comment">// 右侧</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *bottom;    <span class="comment">// 下侧</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *leading;   <span class="comment">// 首部</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *trailing;  <span class="comment">// 尾部</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *width;     <span class="comment">// 宽</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *height;    <span class="comment">// 高</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *centerX;   <span class="comment">// 横向居中</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *centerY;   <span class="comment">// 纵向居中</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *baseline;  <span class="comment">// 文本基线</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*  返回一个 block 对象，block 的接收参数是 MASAttribute 类型,返回一个 MASCompositeConstraint 对象</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *(^attributes)(MASAttribute attrs);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*    返回一个 MASConstraint 对象，包含上下左右的布局信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *edges;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*    返回一个 MASConstraint 对象，包含宽高的布局信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *size;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*    返回一个 MASConstraint 对象，包含 centerX 和 centerY 信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *center;</span><br></pre></td></tr></table></figure>
<p>有了属性之后，怎样添加约束呢？<strong>使用 Masonry 添加约束的函数有三个</strong>，这三个方法我们在文件 <code>View+MASAdditions</code> 中可以查看到：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 新增约束</span></span><br><span class="line"><span class="selector-tag">-</span> (NSArray *)<span class="selector-tag">mas_makeConstraints</span><span class="selector-pseudo">:(void(NS_NOESCAPE</span> ^)(MASConstraintMaker *make))<span class="selector-tag">block</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 更新约束</span></span><br><span class="line"><span class="selector-tag">-</span> (NSArray *)<span class="selector-tag">mas_updateConstraints</span><span class="selector-pseudo">:(void(NS_NOESCAPE</span> ^)(MASConstraintMaker *make))<span class="selector-tag">block</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 清除旧约束，只保留新约束</span></span><br><span class="line"><span class="selector-tag">-</span> (NSArray *)<span class="selector-tag">mas_remakeConstraints</span><span class="selector-pseudo">:(void(NS_NOESCAPE</span> ^)(MASConstraintMaker *make))<span class="selector-tag">block</span>;</span><br></pre></td></tr></table></figure>
<p>上面这三个方法中最常用的是 <code>- (NSArray *)mas_makeConstraints:(void(NS_NOESCAPE ^)(MASConstraintMaker *make))block</code>。即第一个，接下来我们就尝试一下。</p>
<p>举个栗子：</p>
<p>导入 Masonry 框架之后，添加以下代码：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)layoutViews</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">UIImageView</span> *imageView = [[<span class="built_in">UIImageView</span> alloc] init];</span><br><span class="line">[imageView setImage:[<span class="built_in">UIImage</span> imageNamed:<span class="string">@"123"</span>]];</span><br><span class="line">[<span class="keyword">self</span>.view addSubview:imageView];</span><br><span class="line"></span><br><span class="line">[imageView mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">make.left.equalTo(<span class="keyword">self</span>.view).offset(<span class="number">100</span>);</span><br><span class="line">make.right.equalTo(<span class="keyword">self</span>.view).offset(<span class="number">-100</span>);</span><br><span class="line">make.top.equalTo(<span class="keyword">self</span>.view).offset(<span class="number">250</span>);</span><br><span class="line">make.bottom.equalTo(<span class="keyword">self</span>.view).offset(<span class="number">-250</span>);</span><br><span class="line">&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面这几句代码便可以对 UIImageView 控件进行约束，这里还有两点值得一提。第一点：<strong>下面这三种方式会实现相同的效果</strong><br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 第一种</span></span><br><span class="line">[imageView mas_makeConstraints:^(MASConstraintMaker *<span class="built_in">make</span>) &#123;</span><br><span class="line"><span class="built_in">make</span>.left.equalTo(self.<span class="built_in">view</span>).offset(<span class="number">100</span>);</span><br><span class="line"><span class="built_in">make</span>.right.equalTo(self.<span class="built_in">view</span>).offset(<span class="number">-100</span>);</span><br><span class="line"><span class="built_in">make</span>.top.equalTo(self.<span class="built_in">view</span>).offset(<span class="number">250</span>);</span><br><span class="line"><span class="built_in">make</span>.bottom.equalTo(self.<span class="built_in">view</span>).offset(<span class="number">-250</span>);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 第二种</span></span><br><span class="line">[imageView mas_makeConstraints:^(MASConstraintMaker *<span class="built_in">make</span>) &#123;</span><br><span class="line"><span class="built_in">make</span>.top.bottom.left.right.equalTo(self.<span class="built_in">view</span>).insets(UIEdgeInsetsMake(<span class="number">250</span>, <span class="number">100</span>, <span class="number">250</span>, <span class="number">100</span>));</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 第三种</span></span><br><span class="line">[imageView mas_makeConstraints:^(MASConstraintMaker *<span class="built_in">make</span>) &#123;</span><br><span class="line"><span class="built_in">make</span>.edges.equalTo(self.<span class="built_in">view</span>).insets(UIEdgeInsetsMake(<span class="number">250</span>, <span class="number">100</span>, <span class="number">250</span>, <span class="number">100</span>));</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>三种方式得出的效果图一样：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-ecf24222fa369f6e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>第二点：<strong>必须先把控件添加到视图上，才能对控件进行布局，否则程序会崩</strong>。即先 <code>addSubview:</code>，再 <code>mas_makeConstraints:</code> 。</p>
<hr>
<p><strong>以上是对 Masonry 使用的简单介绍。接下来我们开始分析它的源码</strong>。</p>
<p>通过对 Masonry  使用方法的了解，我们可以看出 Masonry 的使用过程还是很简洁的</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="name">imageView</span> mas_makeConstraints:^(<span class="name">MASConstraintMaker</span> *make) &#123;</span><br><span class="line">make.left.equalTo(<span class="name">self.view</span>).offset(<span class="name">100</span>)<span class="comment">;</span></span><br><span class="line">make.right.equalTo(<span class="name">self.view</span>).offset(<span class="name">-100</span>)<span class="comment">;</span></span><br><span class="line">make.top.equalTo(<span class="name">self.view</span>).offset(<span class="name">250</span>)<span class="comment">;</span></span><br><span class="line">make.bottom.equalTo(<span class="name">self.view</span>).offset(<span class="name">-250</span>)<span class="comment">;</span></span><br><span class="line">&#125;]<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>那我们就从 <code>mas_makeConstraints:</code> 这个方法开始探寻 Masonry 的源码。上文说到，Masonry 中设置约束最常用的方法是</p>
 <figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/// 新增约束</span></span><br><span class="line"> <span class="selector-tag">-</span> (NSArray *)<span class="selector-tag">mas_makeConstraints</span><span class="selector-pseudo">:(void(NS_NOESCAPE</span> ^)(MASConstraintMaker *make))<span class="selector-tag">block</span>;</span><br></pre></td></tr></table></figure>
<p> 同时，Masonry 还提供两个类方法用于更新和重建约束</p>
 <figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/// 更新约束</span></span><br><span class="line"> <span class="selector-tag">-</span> (NSArray *)<span class="selector-tag">mas_updateConstraints</span><span class="selector-pseudo">:(void(NS_NOESCAPE</span> ^)(MASConstraintMaker *make))<span class="selector-tag">block</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 清除旧约束，只保留新约束</span></span><br><span class="line"> <span class="selector-tag">-</span> (NSArray *)<span class="selector-tag">mas_remakeConstraints</span><span class="selector-pseudo">:(void(NS_NOESCAPE</span> ^)(MASConstraintMaker *make))<span class="selector-tag">block</span>;</span><br></pre></td></tr></table></figure>
<p> 这里我们就以  <code>mas_makeConstraints:</code>  为切入点开始分析 Masonry 这个框架。<code>mas_makeConstraints:</code>  这个方法位于分类<code>View+MASAdditions</code>中，方法的实现如下：</p>
 <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/// 新增约束</span></span><br><span class="line"> - (<span class="built_in">NSArray</span> *)mas_makeConstraints:(<span class="keyword">void</span>(^)(MASConstraintMaker *))block &#123;</span><br><span class="line"> <span class="comment">/// 我们是手动添加约束，因此将自动转换关闭</span></span><br><span class="line"> <span class="keyword">self</span>.translatesAutoresizingMaskIntoConstraints = <span class="literal">NO</span>;</span><br><span class="line"> <span class="comment">/// 创建 MASConstraintMaker 对象</span></span><br><span class="line"> MASConstraintMaker *constraintMaker = [[MASConstraintMaker alloc] initWithView:<span class="keyword">self</span>];</span><br><span class="line"> <span class="comment">/// 通过 block 进行值的回调</span></span><br><span class="line"> block(constraintMaker);</span><br><span class="line"> <span class="comment">/// 调用 install 方法</span></span><br><span class="line"> <span class="keyword">return</span> [constraintMaker install];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p> 该方法先去掉 AutoResizing 的自动转换（如果这个属性没有被正确设置，那么视图的约束不会被成功添加），接着初始化一个 MASConstraintMaker 对象，传递到 block 中，执行 block，最后调用 install 方法。</p>
<p> 第一次点击进来看到这个方法之后，我有几处疑问。</p>
<ul>
<li><strong>第一，MASConstraintMaker 类内部做了什么操作？</strong></li>
<li><strong>第二，回调 <code>block(constraintMaker)</code>有什么用？</strong></li>
<li><strong>第三，调用 <code>[constraintMaker install]</code> 方法实现了什么？</strong></li>
</ul>
<p> 我们先来分析一下 MASConstraintMaker 这个类。MASConstraintMaker 是 Masonry 框架整个 DSL 过程的控制中心，它控制着整个添加过程，上文我们总结 Masonry 支持哪些属性时，总结的那些属性就来自 MASConstraintMaker 类。我们知道 Masonry 是基于 AutoLayout 进行的封装，所以接着我们一起来看下 MASConstraintMaker 是如何发挥作用的。下面是 MASConstraintMaker 的初始化</p>
 <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">///  这里的 MAS_VIEW 是一个宏，#define MAS_VIEW UIView</span></span><br><span class="line"> - (<span class="keyword">id</span>)initWithView:(MAS_VIEW *)view &#123;</span><br><span class="line"> <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line"> <span class="keyword">if</span> (!<span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">self</span>.view = view;</span><br><span class="line"> <span class="keyword">self</span>.constraints = <span class="built_in">NSMutableArray</span>.new;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p> 从上边代码中我们可以清晰的看出，<strong>Masonry 在初始化 MASConstraintMaker 时，将当前的 view 赋给 MASConstraintMaker 类，并初始化一个  constraints 的空可变数组，作为约束数组</strong>。</p>
<p> 除此之外 MASConstraintMaker 还做了什么呢？</p>
<p> 先来到 MASConstraintMaker 的头文件 <code>MASConstraintMaker.h</code> 中，下面是一些比较常规的属性</p>
 <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> *    以下属性返回一个新的 MASViewConstraint</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *left;      <span class="comment">// 左侧</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *top;       <span class="comment">// 上侧</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *right;     <span class="comment">// 右侧</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *bottom;    <span class="comment">// 下侧</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *leading;   <span class="comment">// 首部</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *trailing;  <span class="comment">// 尾部</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *width;     <span class="comment">// 宽</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *height;    <span class="comment">// 高</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *centerX;   <span class="comment">// 横向居中</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *centerY;   <span class="comment">// 纵向居中</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *baseline;  <span class="comment">// 文本基线</span></span><br></pre></td></tr></table></figure>
<p> 另外可以在 MASConstraintMaker 的 <code>MASConstraintMaker.m</code> 中看到另一个属性 <code>@property (nonatomic, strong) NSMutableArray *constraints</code> ，用来存储 MASConstraint<br> <figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="variable">@interface</span> MASConstraintMaker () &lt;MASConstraintDelegate&gt;</span><br><span class="line"> </span><br><span class="line"> <span class="variable">@property</span> (nonatomic, weak) MAS_VIEW *view;</span><br><span class="line"> <span class="comment">/// 存储 MASConstraint</span></span><br><span class="line"> <span class="variable">@property</span> (nonatomic, strong) NSMutableArray *constraints;</span><br><span class="line"> </span><br><span class="line"> <span class="variable">@end</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>接下来我们通过下面这个例子来分析上面这些属性：</p>
</blockquote>
 <figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> [<span class="name">imageView</span> mas_makeConstraints:^(<span class="name">MASConstraintMaker</span> *make) &#123;</span><br><span class="line"> make.top.bottom.left.right.equalTo(<span class="name">self.view</span>).insets(<span class="name">UIEdgeInsetsMake</span>(<span class="name">250</span>, <span class="number">100</span>, <span class="number">250</span>, <span class="number">100</span>))<span class="comment">;</span></span><br><span class="line"> &#125;]<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>block 中首先会执行 <code>make.top</code> ，会先调用一个增加约束的通用方法<code>- (MASConstraint *)addConstraintWithLayoutAttribute:(NSLayoutAttribute)layoutAttribute</code>  ，接着会调用 MASConstraintMaker 中 MASConstraintDelegate 的 <code>- (MASConstraint *)constraint:(MASConstraint *)constraint addConstraintWithLayoutAttribute:(NSLayoutAttribute)layoutAttribute</code> 方法。具体代码如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/// 重写 getter 方法</span></span><br><span class="line"> - (MASConstraint *)top &#123;</span><br><span class="line"> <span class="keyword">return</span> [self <span class="string">addConstraintWithLayoutAttribute:</span>NSLayoutAttributeTop];</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 增加约束的通用方法</span></span><br><span class="line"> - (MASConstraint *)<span class="string">addConstraintWithLayoutAttribute:</span>(NSLayoutAttribute)layoutAttribute &#123;</span><br><span class="line"> <span class="keyword">return</span> [self <span class="string">constraint:</span>nil <span class="string">addConstraintWithLayoutAttribute:</span>layoutAttribute];</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 通过 NSLayoutAttribute 添加约束</span></span><br><span class="line"> - (MASConstraint *)<span class="string">constraint:</span>(MASConstraint *)constraint <span class="string">addConstraintWithLayoutAttribute:</span>(NSLayoutAttribute)layoutAttribute &#123;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 构造 MASViewAttribute</span></span><br><span class="line"> MASViewAttribute *viewAttribute = [[MASViewAttribute alloc] <span class="string">initWithView:</span>self.view <span class="string">layoutAttribute:</span>layoutAttribute];</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 通过 MASViewAttribute 构造第一个 MASViewConstraint</span></span><br><span class="line"> MASViewConstraint *newConstraint = [[MASViewConstraint alloc] <span class="string">initWithFirstViewAttribute:</span>viewAttribute];</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 如果存在 contraint，则把 constraint 和 newConstraint 组合成 MASCompositeConstraint</span></span><br><span class="line"> <span class="keyword">if</span> ([constraint <span class="string">isKindOfClass:</span>MASViewConstraint.<span class="keyword">class</span>]) &#123;</span><br><span class="line"> <span class="comment">//replace with composite constraint</span></span><br><span class="line"> NSArray *children = @[constraint, newConstraint];</span><br><span class="line"> MASCompositeConstraint *compositeConstraint = [[MASCompositeConstraint alloc] <span class="string">initWithChildren:</span>children];</span><br><span class="line"> compositeConstraint.delegate = self;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 替换原来的 constraint 成新的 MASCompositeConstraint</span></span><br><span class="line"> [self <span class="string">constraint:</span>constraint <span class="string">shouldBeReplacedWithConstraint:</span>compositeConstraint];</span><br><span class="line"> <span class="keyword">return</span> compositeConstraint;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 不存在则设置 constraint 到 self.constraints</span></span><br><span class="line"> <span class="keyword">if</span> (!constraint) &#123;</span><br><span class="line"> <span class="comment">/// 设置delegate</span></span><br><span class="line"> newConstraint.delegate = self;</span><br><span class="line"> <span class="comment">/// 将约束添加到self.constraints</span></span><br><span class="line"> [self.constraints <span class="string">addObject:</span>newConstraint];</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/// 返回刚刚创建的 MASViewConstraint 对象</span></span><br><span class="line"> <span class="keyword">return</span> newConstraint;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>值得一提的是，当调用 <code>make.top</code> 的时候会创建一个只有 firstViewAttribute 的 MASViewConstraint 对象，并且<strong>进入不存在 constraint 的代码部分</strong>，详情见代码块中的注释。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/// 不存在则设置 constraint 到 self.constraints</span></span><br><span class="line"> <span class="keyword">if</span> (!constraint) &#123;</span><br><span class="line"> <span class="comment">/// 设置delegate</span></span><br><span class="line"> <span class="keyword">new</span><span class="type">Constraint</span>.delegate = self;</span><br><span class="line"> <span class="comment">/// 将约束添加到self.constraints</span></span><br><span class="line"> [self.constraints addObject:<span class="type">newConstraint</span>];</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/// 返回刚刚创建的 MASViewConstraint 对象</span></span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span><span class="type">Constraint</span>;</span><br></pre></td></tr></table></figure>
<p><strong>在这个方法的实现过程中，<code>make.top</code> 的返回值是 MASViewConstraint 对象</strong>。</p>
</li>
<li><p>当执行到 <code>make.top.bottom</code> 的时候，其实<strong>是对 MASViewConstraint 对象 .bottom 的调用</strong>，会走到 MASViewConstraint 中重写的 <code>- (MASConstraint *)addConstraintWithLayoutAttribute:(NSLayoutAttribute)layoutAttribute</code>方法，然后最终还是会调用这个代理方法 <code>- (MASConstraint *)constraint:(MASConstraint *)constraint addConstraintWithLayoutAttribute:(NSLayoutAttribute)layoutAttribute</code></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> - (MASConstraint *)<span class="string">addConstraintWithLayoutAttribute:</span>(NSLayoutAttribute)layoutAttribute &#123;</span><br><span class="line"> NSAssert(!self.hasLayoutRelation, @<span class="string">"Attributes should be chained before defining the constraint relation"</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">return</span> [self.delegate <span class="string">constraint:</span>self <span class="string">addConstraintWithLayoutAttribute:</span>layoutAttribute];</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 通过 NSLayoutAttribute 添加约束</span></span><br><span class="line"> - (MASConstraint *)<span class="string">constraint:</span>(MASConstraint *)constraint <span class="string">addConstraintWithLayoutAttribute:</span>(NSLayoutAttribute)layoutAttribute &#123;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 构造 MASViewAttribute</span></span><br><span class="line"> MASViewAttribute *viewAttribute = [[MASViewAttribute alloc] <span class="string">initWithView:</span>self.view <span class="string">layoutAttribute:</span>layoutAttribute];</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 通过 MASViewAttribute 构造第一个 MASViewConstraint</span></span><br><span class="line"> MASViewConstraint *newConstraint = [[MASViewConstraint alloc] <span class="string">initWithFirstViewAttribute:</span>viewAttribute];</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 如果存在 contraint，则把 constraint 和 newConstraint 组合成 MASCompositeConstraint</span></span><br><span class="line"> <span class="keyword">if</span> ([constraint <span class="string">isKindOfClass:</span>MASViewConstraint.<span class="keyword">class</span>]) &#123;</span><br><span class="line"> <span class="comment">//replace with composite constraint</span></span><br><span class="line"> NSArray *children = @[constraint, newConstraint];</span><br><span class="line"> MASCompositeConstraint *compositeConstraint = [[MASCompositeConstraint alloc] <span class="string">initWithChildren:</span>children];</span><br><span class="line"> compositeConstraint.delegate = self;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 替换原来的 constraint 成新的 MASCompositeConstraint</span></span><br><span class="line"> [self <span class="string">constraint:</span>constraint <span class="string">shouldBeReplacedWithConstraint:</span>compositeConstraint];</span><br><span class="line"> <span class="keyword">return</span> compositeConstraint;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 不存在则设置 constraint 到 self.constraints</span></span><br><span class="line"> <span class="keyword">if</span> (!constraint) &#123;</span><br><span class="line"> <span class="comment">/// 设置delegate</span></span><br><span class="line"> newConstraint.delegate = self;</span><br><span class="line"> <span class="comment">/// 将约束添加到self.constraints</span></span><br><span class="line"> [self.constraints <span class="string">addObject:</span>newConstraint];</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/// 返回刚刚创建的 MASViewConstraint 对象</span></span><br><span class="line"> <span class="keyword">return</span> newConstraint;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>和前面的执行过程不同，因为 MASViewConstraint 的 delegate 对象是刚才设置过的 MASConstraintMaker 对象，并且因为 constraint 不是 nil，所以会进入</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/// 如果存在 contraint，则把 constraint 和 newConstraint 组合成 MASCompositeConstraint</span></span><br><span class="line"> <span class="keyword">if</span> ([constraint <span class="string">isKindOfClass:</span>MASViewConstraint.<span class="keyword">class</span>]) &#123;</span><br><span class="line"> <span class="comment">//replace with composite constraint</span></span><br><span class="line"> NSArray *children = @[constraint, newConstraint];</span><br><span class="line"> MASCompositeConstraint *compositeConstraint = [[MASCompositeConstraint alloc] <span class="string">initWithChildren:</span>children];</span><br><span class="line"> compositeConstraint.delegate = self;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 替换原来的 constraint 成新的 MASCompositeConstraint</span></span><br><span class="line"> [self <span class="string">constraint:</span>constraint <span class="string">shouldBeReplacedWithConstraint:</span>compositeConstraint];</span><br><span class="line"> <span class="keyword">return</span> compositeConstraint;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>因此<strong>调用 make.top.bottom 返回的是一个 MASCompositeConstraint 对象</strong>。</p>
</li>
<li><p>当程序执行到 <code>make.top.bottom.left</code> 时，就<strong>是对 MASCompositeConstraint 中 .left 的调用</strong>，会走 MASCompositeConstraint 中的重写方法 <code>- (MASConstraint *)addConstraintWithLayoutAttribute:(NSLayoutAttribute)layoutAttribute</code>，接着会调用 <code>- (MASConstraint *)constraint:(MASConstraint __unused *)constraint addConstraintWithLayoutAttribute:(NSLayoutAttribute)layoutAttribute</code>方法，最终还是会调用 <code>- (MASConstraint *)constraint:(MASConstraint *)constraint addConstraintWithLayoutAttribute:(NSLayoutAttribute)layoutAttribute</code>。代码如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> - (MASConstraint *)<span class="string">addConstraintWithLayoutAttribute:</span>(NSLayoutAttribute)layoutAttribute &#123;</span><br><span class="line"> [self <span class="string">constraint:</span>self <span class="string">addConstraintWithLayoutAttribute:</span>layoutAttribute];</span><br><span class="line"> <span class="keyword">return</span> self;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> - (MASConstraint *)<span class="string">constraint:</span>(MASConstraint __unused *)constraint <span class="string">addConstraintWithLayoutAttribute:</span>(NSLayoutAttribute)layoutAttribute &#123;</span><br><span class="line"> id&lt;MASConstraintDelegate&gt; strongDelegate = self.delegate;</span><br><span class="line"> MASConstraint *newConstraint = [strongDelegate <span class="string">constraint:</span>self <span class="string">addConstraintWithLayoutAttribute:</span>layoutAttribute];</span><br><span class="line"> newConstraint.delegate = self;</span><br><span class="line"> [self.childConstraints <span class="string">addObject:</span>newConstraint];</span><br><span class="line"> <span class="keyword">return</span> newConstraint;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 通过 NSLayoutAttribute 添加约束</span></span><br><span class="line"> - (MASConstraint *)<span class="string">constraint:</span>(MASConstraint *)constraint <span class="string">addConstraintWithLayoutAttribute:</span>(NSLayoutAttribute)layoutAttribute &#123;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 构造 MASViewAttribute</span></span><br><span class="line"> MASViewAttribute *viewAttribute = [[MASViewAttribute alloc] <span class="string">initWithView:</span>self.view <span class="string">layoutAttribute:</span>layoutAttribute];</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 通过 MASViewAttribute 构造第一个 MASViewConstraint</span></span><br><span class="line"> MASViewConstraint *newConstraint = [[MASViewConstraint alloc] <span class="string">initWithFirstViewAttribute:</span>viewAttribute];</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 如果存在 contraint，则把 constraint 和 newConstraint 组合成 MASCompositeConstraint</span></span><br><span class="line"> <span class="keyword">if</span> ([constraint <span class="string">isKindOfClass:</span>MASViewConstraint.<span class="keyword">class</span>]) &#123;</span><br><span class="line"> <span class="comment">//replace with composite constraint</span></span><br><span class="line"> NSArray *children = @[constraint, newConstraint];</span><br><span class="line"> MASCompositeConstraint *compositeConstraint = [[MASCompositeConstraint alloc] <span class="string">initWithChildren:</span>children];</span><br><span class="line"> compositeConstraint.delegate = self;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 替换原来的 constraint 成新的 MASCompositeConstraint</span></span><br><span class="line"> [self <span class="string">constraint:</span>constraint <span class="string">shouldBeReplacedWithConstraint:</span>compositeConstraint];</span><br><span class="line"> <span class="keyword">return</span> compositeConstraint;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 不存在则设置 constraint 到 self.constraints</span></span><br><span class="line"> <span class="keyword">if</span> (!constraint) &#123;</span><br><span class="line"> newConstraint.delegate = self;</span><br><span class="line"> [self.constraints <span class="string">addObject:</span>newConstraint];</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> newConstraint;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p> <strong>但这次 <code>if ([constraint isKindOfClass:MASViewConstraint.class])</code> 与 <code>if (!constraint)</code> 都不会进入，只直接返回 MASViewConstraint 对象，然后回到 <code>- (MASConstraint *)constraint:(MASConstraint __unused *)constraint addConstraintWithLayoutAttribute:(NSLayoutAttribute)layoutAttribute</code> 方法中设置它的 delegate，并且将对象存入 MASCompositeConstraint 的 childConstraints 中。</strong></p>
<ul>
<li><p>之后再有更多的链式 MASConstraint 的组合（比如执行到 <code>make.top.bottom.left.right</code>），也只是 MASCompositeConstraint 的调用，直接加入 childConstraints 中即可。</p>
</li>
<li><p>至于 <code>equalTo(self.view)</code> 的调用过程，这里有必要说明一下，<code>equalTo(self.view)</code> 在文件 MASConstraint 中执行 <code>- (MASConstraint * (^)(id))equalTo</code> 方法，接着调用 MASViewConstraint 中的 <code>- (MASConstraint * (^)(id, NSLayoutRelation))equalToWithRelation</code> 方法。代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> <span class="comment">/// MASConstraint 是一个抽象类，其中有很多的方法都必须在子类中覆写。Masonry 中有两个 MASConstraint 的子类，分别是 MASViewConstraint 和 MASCompositeConstraint</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// MASConstraint.m</span></span><br><span class="line"> - (MASConstraint * (^)(<span class="keyword">id</span>))equalTo &#123;</span><br><span class="line"> <span class="keyword">return</span> ^<span class="keyword">id</span>(<span class="keyword">id</span> attribute) &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">self</span>.equalToWithRelation(attribute, <span class="built_in">NSLayoutRelationEqual</span>);</span><br><span class="line"> &#125;;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// MASViewConstraint.m</span></span><br><span class="line"> - (MASConstraint * (^)(<span class="keyword">id</span>, <span class="built_in">NSLayoutRelation</span>))equalToWithRelation &#123;</span><br><span class="line"> <span class="keyword">return</span> ^<span class="keyword">id</span>(<span class="keyword">id</span> attribute, <span class="built_in">NSLayoutRelation</span> relation) &#123;</span><br><span class="line"> <span class="keyword">if</span> ([attribute isKindOfClass:<span class="built_in">NSArray</span>.class]) &#123;</span><br><span class="line"> <span class="built_in">NSAssert</span>(!<span class="keyword">self</span>.hasLayoutRelation, <span class="string">@"Redefinition of constraint relation"</span>);</span><br><span class="line"> <span class="built_in">NSMutableArray</span> *children = <span class="built_in">NSMutableArray</span>.new;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">id</span> attr <span class="keyword">in</span> attribute) &#123;</span><br><span class="line"> MASViewConstraint *viewConstraint = [<span class="keyword">self</span> <span class="keyword">copy</span>];</span><br><span class="line"> viewConstraint.layoutRelation = relation;</span><br><span class="line"> viewConstraint.secondViewAttribute = attr;</span><br><span class="line"> [children addObject:viewConstraint];</span><br><span class="line"> &#125;</span><br><span class="line"> MASCompositeConstraint *compositeConstraint = [[MASCompositeConstraint alloc] initWithChildren:children];</span><br><span class="line"> compositeConstraint.delegate = <span class="keyword">self</span>.delegate;</span><br><span class="line"> [<span class="keyword">self</span>.delegate constraint:<span class="keyword">self</span> shouldBeReplacedWithConstraint:compositeConstraint];</span><br><span class="line"> <span class="keyword">return</span> compositeConstraint;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="built_in">NSAssert</span>(!<span class="keyword">self</span>.hasLayoutRelation || <span class="keyword">self</span>.layoutRelation == relation &amp;&amp; [attribute isKindOfClass:<span class="built_in">NSValue</span>.class], <span class="string">@"Redefinition of constraint relation"</span>);</span><br><span class="line"> <span class="keyword">self</span>.layoutRelation = relation;</span><br><span class="line"> <span class="keyword">self</span>.secondViewAttribute = attribute;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p> <code>- (MASConstraint * (^)(id))equalTo</code> 方法提供了参数 attribute 和布局关系 NSLayoutRelationEqual，这两个参数会传递到 <code>- (MASConstraint * (^)(id, NSLayoutRelation))equalToWithRelation</code> 中，设置 constraint 的布局关系和 secondViewAttribute 属性，为 <code>[constraintMaker install]</code> 做准备。</p>
<p> 到这里基本上就把上文的那个例子说完了，通过例子让我们对 MASConstraintMaker 中的一些常规属性有了一定的了解，同时也明白了 <code>block(constraintMaker)</code> 这个方法的作用——<strong>在调用  <code>block(constraintMaker)</code> 时，对 constraintMaker 进行配置</strong>。 MASConstraintMaker 中还有一些别的属性，我们再一起来看看吧</p>
 <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  返回一个 block 对象，block 的接收参数是 MASAttribute 类型，返回一个 MASCompositeConstraint 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *(^attributes)(MASAttribute attrs);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> *    返回一个 MASConstraint 对象，包含上下左右的布局</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *edges;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> *    返回一个 MASConstraint 对象，包含宽高的布局</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *size;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> *    返回一个 MASConstraint 对象，包含 centerX 和 centerY</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *center;</span><br></pre></td></tr></table></figure>
<p> 这里只简单的介绍一下上面的几个属性</p>
<blockquote>
<ol>
<li><code>attributes</code>：返回一个 block 对象，block 的接收参数是 MASAttribute 类型，返回 MASCompositeConstraint 对象<ol start="2">
<li><code>edges</code>：返回一个 MASConstraint 对象，同时包含了上下左右的布局</li>
<li><code>size</code>：返回一个 MASConstraint 对象，同时包含了宽高的布局</li>
<li><code>center</code>：返回一个 MASConstraint 对象，同时包含了 centerX 和centerY</li>
</ol>
</li>
</ol>
</blockquote>
<p> <strong>接下来我们来分析 <code>[constraintMaker install]</code> 方法</strong>。</p>
<p> 我们在<code>- (NSArray *)mas_makeConstraints:(void(^)(MASConstraintMaker *))block</code> 方法的最后会调用 <code>[constraintMaker install]</code>  方法来添加所有存储在 <code>self.constraints</code> 数组中的所有约束。</p>
 <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> - (<span class="built_in">NSArray</span> *)install &#123;</span><br><span class="line"> <span class="comment">/// 是否需要删除原来的约束</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">self</span>.removeExisting) &#123;</span><br><span class="line"> <span class="comment">/// 获得所有约束</span></span><br><span class="line"> <span class="built_in">NSArray</span> *installedConstraints = [MASViewConstraint installedConstraintsForView:<span class="keyword">self</span>.view];</span><br><span class="line"> <span class="comment">/// 删除所有约束</span></span><br><span class="line"> <span class="keyword">for</span> (MASConstraint *constraint <span class="keyword">in</span> installedConstraints) &#123;</span><br><span class="line"> [constraint uninstall];</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">NSArray</span> *constraints = <span class="keyword">self</span>.constraints.copy;</span><br><span class="line"> <span class="keyword">for</span> (MASConstraint *constraint <span class="keyword">in</span> constraints) &#123;</span><br><span class="line"> constraint.updateExisting = <span class="keyword">self</span>.updateExisting;</span><br><span class="line"> [constraint install];</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/// 去除所有缓存的约束结构体</span></span><br><span class="line"> [<span class="keyword">self</span>.constraints removeAllObjects];</span><br><span class="line"> <span class="keyword">return</span> constraints;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p> 这个方法会先判断当前视图的约束是否需要删除，如果我们之前调用过 <code>- (NSArray *)mas_remakeConstraints:(void(NS_NOESCAPE ^)(MASConstraintMaker *make))block</code> 这个方法（它会把 removeExisting 的 BOOL 值设为 YES），那么视图中的原有约束就会被全被删除。接着往下走，程序会遍历 constraints 数组，发送 install 消息。</p>
 <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/// MASViewConstraint.m</span></span><br><span class="line"> - (<span class="keyword">void</span>)install &#123;</span><br><span class="line"> <span class="comment">/// 已经有约束</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">self</span>.hasBeenInstalled) &#123;</span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 支持 active 且已经有约束</span></span><br><span class="line"> <span class="keyword">if</span> ([<span class="keyword">self</span> supportsActiveProperty] &amp;&amp; <span class="keyword">self</span>.layoutConstraint) &#123;</span><br><span class="line"> <span class="comment">/// 激活约束</span></span><br><span class="line"> <span class="keyword">self</span>.layoutConstraint.active = <span class="literal">YES</span>;</span><br><span class="line"> <span class="comment">/// 添加约束缓存</span></span><br><span class="line"> [<span class="keyword">self</span>.firstViewAttribute.view.mas_installedConstraints addObject:<span class="keyword">self</span>];</span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 获得 firstLayoutItem, firstLayoutAttribute, secondLayoutItem, secondLayoutAttribute</span></span><br><span class="line"> MAS_VIEW *firstLayoutItem = <span class="keyword">self</span>.firstViewAttribute.item;</span><br><span class="line"> <span class="built_in">NSLayoutAttribute</span> firstLayoutAttribute = <span class="keyword">self</span>.firstViewAttribute.layoutAttribute;</span><br><span class="line"> MAS_VIEW *secondLayoutItem = <span class="keyword">self</span>.secondViewAttribute.item;</span><br><span class="line"> <span class="built_in">NSLayoutAttribute</span> secondLayoutAttribute = <span class="keyword">self</span>.secondViewAttribute.layoutAttribute;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// alignment attributes must have a secondViewAttribute</span></span><br><span class="line"> <span class="comment">// therefore we assume that is refering to superview</span></span><br><span class="line"> <span class="comment">// eg make.left.equalTo(@10)</span></span><br><span class="line"> <span class="keyword">if</span> (!<span class="keyword">self</span>.firstViewAttribute.isSizeAttribute &amp;&amp; !<span class="keyword">self</span>.secondViewAttribute) &#123;</span><br><span class="line"> secondLayoutItem = <span class="keyword">self</span>.firstViewAttribute.view.superview;</span><br><span class="line"> secondLayoutAttribute = firstLayoutAttribute;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// NSLayoutConstraint 的创建，生成约束，MASLayoutConstraint 其实就是 NSLayoutConstraint 的别名</span></span><br><span class="line"> MASLayoutConstraint *layoutConstraint</span><br><span class="line"> = [MASLayoutConstraint constraintWithItem:firstLayoutItem</span><br><span class="line"> attribute:firstLayoutAttribute</span><br><span class="line"> relatedBy:<span class="keyword">self</span>.layoutRelation</span><br><span class="line"> toItem:secondLayoutItem</span><br><span class="line"> attribute:secondLayoutAttribute</span><br><span class="line"> multiplier:<span class="keyword">self</span>.layoutMultiplier</span><br><span class="line"> constant:<span class="keyword">self</span>.layoutConstant];</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 设置 priority 和 mas_key</span></span><br><span class="line"> layoutConstraint.priority = <span class="keyword">self</span>.layoutPriority;</span><br><span class="line"> layoutConstraint.mas_key = <span class="keyword">self</span>.mas_key;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 如果 secondViewAttribute 有 view 对象</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">self</span>.secondViewAttribute.view) &#123;</span><br><span class="line"> <span class="comment">/// 取得两个 view 的最小公共 view</span></span><br><span class="line"> MAS_VIEW *closestCommonSuperview = [<span class="keyword">self</span>.firstViewAttribute.view mas_closestCommonSuperview:<span class="keyword">self</span>.secondViewAttribute.view];</span><br><span class="line"> <span class="built_in">NSAssert</span>(closestCommonSuperview,</span><br><span class="line"> <span class="string">@"couldn't find a common superview for %@ and %@"</span>,</span><br><span class="line"> <span class="keyword">self</span>.firstViewAttribute.view, <span class="keyword">self</span>.secondViewAttribute.view);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 设置约束 view 为此 view</span></span><br><span class="line"> <span class="keyword">self</span>.installedView = closestCommonSuperview;</span><br><span class="line"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">self</span>.firstViewAttribute.isSizeAttribute) &#123;</span><br><span class="line"> <span class="keyword">self</span>.installedView = <span class="keyword">self</span>.firstViewAttribute.view;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="keyword">self</span>.installedView = <span class="keyword">self</span>.firstViewAttribute.view.superview;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 已经存在的约束</span></span><br><span class="line"> MASLayoutConstraint *existingConstraint = <span class="literal">nil</span>;</span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">self</span>.updateExisting) &#123; <span class="comment">// 需要更新</span></span><br><span class="line"> existingConstraint = [<span class="keyword">self</span> layoutConstraintSimilarTo:layoutConstraint];</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (existingConstraint) &#123; <span class="comment">// 如果存在则替换约束</span></span><br><span class="line"> <span class="comment">// just update the constant</span></span><br><span class="line"> existingConstraint.constant = layoutConstraint.constant;</span><br><span class="line"> <span class="keyword">self</span>.layoutConstraint = existingConstraint;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="comment">/// 其它情况则直接添加约束</span></span><br><span class="line"> [<span class="keyword">self</span>.installedView addConstraint:layoutConstraint];</span><br><span class="line"> <span class="keyword">self</span>.layoutConstraint = layoutConstraint;</span><br><span class="line"> [firstLayoutItem.mas_installedConstraints addObject:<span class="keyword">self</span>];</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p> 上面这个方法是为当前视图添加约束的最后的方法，首先这个方法会先获取即将用于初始化 NSLayoutConstraint 的子类的几个属性</p>
 <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/// MASViewConstraint.m</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 获得 firstLayoutItem, firstLayoutAttribute, secondLayoutItem, secondLayoutAttribute</span></span><br><span class="line"> MAS_VIEW *firstLayoutItem = <span class="keyword">self</span>.firstViewAttribute.item;</span><br><span class="line"> <span class="built_in">NSLayoutAttribute</span> firstLayoutAttribute = <span class="keyword">self</span>.firstViewAttribute.layoutAttribute;</span><br><span class="line"> MAS_VIEW *secondLayoutItem = <span class="keyword">self</span>.secondViewAttribute.item;</span><br><span class="line"> <span class="built_in">NSLayoutAttribute</span> secondLayoutAttribute = <span class="keyword">self</span>.secondViewAttribute.layoutAttribute;</span><br></pre></td></tr></table></figure>
<p> 然后判断当前即将添加的约束，如果不是 size 类型并且没有提供 self.secondViewAttribute，会自动将约束添加到 superview 上</p>
 <figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> /<span class="regexp">//</span> MASViewConstraint.m</span><br><span class="line"> <span class="keyword">if</span> (!<span class="keyword">self</span>.firstViewAttribute.isSizeAttribute &amp;&amp; !<span class="keyword">self</span>.secondViewAttribute) &#123;</span><br><span class="line"> secondLayoutItem = <span class="keyword">self</span>.firstViewAttribute.view.superview;</span><br><span class="line"> secondLayoutAttribute = firstLayoutAttribute;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p> 接着创建 MASLayoutConstraint 对象</p>
 <figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/// MASViewConstraint.m</span></span><br><span class="line"> <span class="comment">/// NSLayoutConstraint 的创建，生成约束，MASLayoutConstraint 其实就是 NSLayoutConstraint 的别名</span></span><br><span class="line"> MASLayoutConstraint *layoutConstraint</span><br><span class="line"> = [MASLayoutConstraint constraintWithItem:firstLayoutItem</span><br><span class="line"><span class="symbol"> attribute:</span>firstLayoutAttribute</span><br><span class="line"><span class="symbol"> relatedBy:</span>self.layoutRelation</span><br><span class="line"><span class="symbol"> toItem:</span>secondLayoutItem</span><br><span class="line"><span class="symbol"> attribute:</span>secondLayoutAttribute</span><br><span class="line"><span class="symbol"> multiplier:</span>self.layoutMultiplier</span><br><span class="line"><span class="symbol"> constant:</span>self.layoutConstant];</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 设置 priority 和 mas_key</span></span><br><span class="line"> layoutConstraint.priority = self.layoutPriority;</span><br><span class="line"> layoutConstraint.mas_key = self.mas_key;</span><br></pre></td></tr></table></figure>
<p> 创建完约束对象后，我们要寻找该约束添加到那个 View 上。下方的代码段就是获取接收该约束对象的视图。如果是两个视图相对约束，就获取两种的公共父视图。如果添加的是 Width 或者 Height，那么就添加到当前视图上。如果既没有指定相对视图，也不是 Size 类型的约束，那么就将该约束对象添加到当前视图的父视图上。代码实现如下：</p>
 <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/// MASViewConstraint.m</span></span><br><span class="line"> <span class="comment">/// 如果 secondViewAttribute 有 view 对象</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">self</span>.secondViewAttribute.view) &#123;</span><br><span class="line"> <span class="comment">/// 取得两个 view 的最小公共 view</span></span><br><span class="line"> MAS_VIEW *closestCommonSuperview = [<span class="keyword">self</span>.firstViewAttribute.view mas_closestCommonSuperview:<span class="keyword">self</span>.secondViewAttribute.view];</span><br><span class="line"> <span class="built_in">NSAssert</span>(closestCommonSuperview,</span><br><span class="line"> <span class="string">@"couldn't find a common superview for %@ and %@"</span>,</span><br><span class="line"> <span class="keyword">self</span>.firstViewAttribute.view, <span class="keyword">self</span>.secondViewAttribute.view);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 设置约束 view 为此 view</span></span><br><span class="line"> <span class="keyword">self</span>.installedView = closestCommonSuperview;</span><br><span class="line"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">self</span>.firstViewAttribute.isSizeAttribute) &#123;</span><br><span class="line"> <span class="keyword">self</span>.installedView = <span class="keyword">self</span>.firstViewAttribute.view;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="keyword">self</span>.installedView = <span class="keyword">self</span>.firstViewAttribute.view.superview;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p> 加约束时我们要判断是否需要对约束进行更新，如果需要，就替换约束，如果不需要就直接添加约束即可。添加成功后我们将通过 mas_installedConstraints 属性记录一下本次添加的约束。<br> <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/// 已经存在的约束</span></span><br><span class="line"> MASLayoutConstraint *existingConstraint = <span class="literal">nil</span>;</span><br><span class="line"> <span class="keyword">if</span> (<span class="keyword">self</span>.updateExisting) &#123; <span class="comment">// 需要更新</span></span><br><span class="line"> existingConstraint = [<span class="keyword">self</span> layoutConstraintSimilarTo:layoutConstraint];</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (existingConstraint) &#123; <span class="comment">// 如果存在则替换约束</span></span><br><span class="line"> <span class="comment">// just update the constant</span></span><br><span class="line"> existingConstraint.constant = layoutConstraint.constant;</span><br><span class="line"> <span class="keyword">self</span>.layoutConstraint = existingConstraint;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="comment">/// 其它情况则直接添加约束</span></span><br><span class="line"> [<span class="keyword">self</span>.installedView addConstraint:layoutConstraint];</span><br><span class="line"> <span class="keyword">self</span>.layoutConstraint = layoutConstraint;</span><br><span class="line"> [firstLayoutItem.mas_installedConstraints addObject:<span class="keyword">self</span>];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>到此为止，对 <a href="https://github.com/SnapKit/Masonry" target="_blank" rel="noopener">Masonry</a>  源码的简单介绍已接近尾声了。。。<a href="https://github.com/SnapKit/Masonry" target="_blank" rel="noopener">Masonry</a>  的代码流程简单来讲就是提供给我们一个 MASConstraintMaker，然后我们根据 Masonry 提供的语法，添加约束。最后 Masonry 解析约束，将真正的约束关系添加到相应的视图上。</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/15/iOS开发之源码解析 - MBProgressHUD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘朋坤">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="以梦为马">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/15/iOS开发之源码解析 - MBProgressHUD/" itemprop="url">
                  iOS开发之源码解析 - MBProgressHUD
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-15T12:30:20+08:00">2018-04-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><a href="https://github.com/jdg/MBProgressHUD" target="_blank" rel="noopener">MBProgressHUD</a> 是一个为 <code>APP</code> 添加 <code>HUD</code> 窗口的第三方框架，使用起来极其简单方便，关于 <code>MBProgressHUD</code> 的使用方法，<code>GitHub</code> 上有详细的说明，这里就不多加介绍了，本文主要是从源码的角度分析 <code>MBProgressHUD</code>的具体实现。</p>
</blockquote>
<ul>
<li>先来对 <a href="https://github.com/jdg/MBProgressHUD" target="_blank" rel="noopener">MBProgressHUD</a> 有个大体的认识，这是刚从 <code>GitHub</code> 上拉下来的代码，如下图，MBProgressHUD 的主要文件只有两个：<br><br><br></li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-3cbf54d2915cfc84.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MBProgressHUD 源码解析"></p>
<hr>
<p>下面我们就开始分析 <a href="https://github.com/jdg/MBProgressHUD" target="_blank" rel="noopener">MBProgressHUD</a> 的具体实现。在此之前先了解下文章的目录，本文主要有三个部分：</p>
<ol>
<li><strong>MBProgressHUD 核心 API</strong></li>
</ol>
<ul>
<li>这一部分讲的主要是 MBProgressHUD 的一些属性方法等，主要是为了对 MBProgressHUD 先有个大概的认识</li>
</ul>
<ol start="2">
<li><strong>show 系列方法</strong></li>
</ol>
<ul>
<li>这一部分主要是展示 HUD 窗口时调用的方法及代码分析</li>
</ul>
<ol start="3">
<li><strong>hide 系列方法</strong></li>
</ol>
<ul>
<li>这一部分主要是隐藏 HUD 窗口时调用的方法及代码分析</li>
</ul>
<p><br><br></p>
<p><strong>begin~~~</strong></p>
<h2 id="一、MBProgressHUD-核心-API"><a href="#一、MBProgressHUD-核心-API" class="headerlink" title="一、MBProgressHUD 核心 API"></a>一、MBProgressHUD 核心 API</h2><blockquote>
<p>这一部分讲的主要是 MBProgressHUD 的一些属性方法等，主要是为了对 MBProgressHUD 先有个大概的认识</p>
</blockquote>
<h4 id="1-1-模式"><a href="#1-1-模式" class="headerlink" title="1.1 模式"></a>1.1 模式</h4><p>首先来看看 <a href="https://github.com/jdg/MBProgressHUD" target="_blank" rel="noopener">MBProgressHUD</a> 中定义的枚举，<code>mode</code> 一共有六种显示样式：</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/// 显示样式</span><br><span class="line">typedef <span class="type">NS_ENUM</span>(<span class="type">NSInteger</span>, <span class="type">MBProgressHUDMode</span>) &#123;</span><br><span class="line">/// 默认模式, 系统自带的指示器</span><br><span class="line"><span class="type">MBProgressHUDModeIndeterminate</span>,</span><br><span class="line">/// 圆形饼图</span><br><span class="line"><span class="type">MBProgressHUDModeDeterminate</span>,</span><br><span class="line">/// 水平进度条</span><br><span class="line"><span class="type">MBProgressHUDModeDeterminateHorizontalBar</span>,</span><br><span class="line">/// 圆环</span><br><span class="line"><span class="type">MBProgressHUDModeAnnularDeterminate</span>,</span><br><span class="line">/// 自定义视图</span><br><span class="line"><span class="type">MBProgressHUDModeCustomView</span>,</span><br><span class="line">/// 只显示文字</span><br><span class="line"><span class="type">MBProgressHUDModeText</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>简单的效果图如下（颜色尺寸等都可以优化，我这里只是简单地示例）：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-2c0e36917095f806.gif?imageMogr2/auto-orient/strip" alt="默认模式：hud.mode = MBProgressHUDModeIndeterminate"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-33d61502f23a1cb8.gif?imageMogr2/auto-orient/strip" alt="圆形饼图：hud.mode = MBProgressHUDModeDeterminate"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-137f0865dea6bc2c.gif?imageMogr2/auto-orient/strip" alt="水平进度条：hud.mode = MBProgressHUDModeDeterminateHorizontalBar"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-6813068f5afe1668.gif?imageMogr2/auto-orient/strip" alt="圆环：hud.mode = MBProgressHUDModeAnnularDeterminate"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-9afbf851e3b786ed.gif?imageMogr2/auto-orient/strip" alt="自定义视图：hud.mode = MBProgressHUDModeCustomView"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-bfa363444cff270a.gif?imageMogr2/auto-orient/strip" alt="只显示文字：hud.mode = MBProgressHUDModeText"></p>
<p><br><br></p>
<h4 id="1-2-动画效果"><a href="#1-2-动画效果" class="headerlink" title="1.2 动画效果"></a>1.2 动画效果</h4><p>MBProgressHUD 在显示 HUD 窗口的时候，一般都伴随着动画效果，MBProgressHUD 中的动画效果也是一个枚举，如下：</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">typedef <span class="type">NS_ENUM</span>(<span class="type">NSInteger</span>, <span class="type">MBProgressHUDAnimation</span>) &#123;</span><br><span class="line">///  默认效果，只有透明度变化</span><br><span class="line"><span class="type">MBProgressHUDAnimationFade</span>,</span><br><span class="line">/// 透明度变化 + 形变 (放大时出现缩小消失)</span><br><span class="line"><span class="type">MBProgressHUDAnimationZoom</span>,</span><br><span class="line">/// 透明度变化 + 形变 (缩小)</span><br><span class="line"><span class="type">MBProgressHUDAnimationZoomOut</span>,</span><br><span class="line">/// 透明度变化 + 形变 (放大)</span><br><span class="line"><span class="type">MBProgressHUDAnimationZoomIn</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><em>这里先简单的罗列出来，下文中还会多次用到。</em><br><br><br></p>
<h4 id="1-3-MBProgressHUD-组成"><a href="#1-3-MBProgressHUD-组成" class="headerlink" title="1.3 MBProgressHUD 组成"></a>1.3 MBProgressHUD 组成</h4><p><code>MBProgressHUD</code> 主要由四部分组成：<strong>loading 动画视图</strong>、<strong>标题文本框</strong>、<strong>详情文本框</strong>、<strong>HUD 背景框</strong>，如下图。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-c61402fca48f7cea.gif?imageMogr2/auto-orient/strip" alt="MBProgressHUD 组成"></p>
<p>之前用 <code>MBProgressHUD</code> 设置标题文本详情文本是通过几个属性来实现的，功能少也较为繁琐，因此被遗弃了；现在设置标题文本详情文本等十分简便，直接通过 label 等控件就可以实现，而且在功能上也有很大的扩展，详情请看下面这个代码块：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// bezelView 是指包括文本和指示器的视图，和自定义的 customView 类似</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) MBBackgroundView *bezelView;</span><br><span class="line"><span class="comment">/// backgroundView 背景视图</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) MBBackgroundView *backgroundView;</span><br><span class="line"><span class="comment">/// customView 自定义视图</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>) <span class="built_in">UIView</span> *customView;</span><br><span class="line"><span class="comment">/// label 指的是标题文本</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">UILabel</span> *label;</span><br><span class="line"><span class="comment">/// detailsLabel指的是详情文本</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">UILabel</span> *detailsLabel;</span><br><span class="line"><span class="comment">/// hud 窗口还可以加入button，添加事件</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">UIButton</span> *button;</span><br></pre></td></tr></table></figure>
<p>另外这里再附加两张 <code>MBProgressHUD</code> 的整体布局图，以便更好地认识 <code>MBProgressHUD</code>。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-c955394ba5fe50c9.gif?imageMogr2/auto-orient/strip" alt=" MBProgressHUD 的整体布局图 1"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-edeee858374f6c16.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MBProgressHUD 的整体布局图 2"></p>
<p><strong>简单介绍</strong>：</p>
<ul>
<li>backgroundView：整个背景图层，可以通过 MBBackgroundView 的 style 属性设置</li>
<li>bezelView：提供元素 （indicator、label、detailLabel、button）的背景</li>
<li>indicator：指示器显示进度情况 这个视图由我们设定的mode属性决定</li>
<li>label：显示标题文本</li>
<li>detailLabel：显示详情文本</li>
<li>button：添加点击事件<br><br><br></li>
</ul>
<h4 id="1-4-MBProgressHUD-中的属性"><a href="#1-4-MBProgressHUD-中的属性" class="headerlink" title="1.4 MBProgressHUD 中的属性"></a>1.4 MBProgressHUD 中的属性</h4><p>MBProgressHUD 文件中主要包括四个类，它们分别是 <strong>MBProgressHUD</strong>、<strong>MBRoundProgressView</strong>、 <strong>MBBarProgressView</strong>、 <strong>MBBackgroundView</strong>。这四个类各有各的用法，比如如果是进度条模式(MBProgressHUDModeDeterminateHorizontalBar)，则使用的是 <code>MBBarProgressView</code> 类；如果是饼图模式(MBProgressHUDModeDeterminate)或环形模式(MBProgressHUDModeAnnularDeterminate)，则使用的是 <code>MBRoundProgressView</code>类。下面是这四个类的相关属性。</p>
<h6 id="1-41-MBProgressHUD-相关属性"><a href="#1-41-MBProgressHUD-相关属性" class="headerlink" title="1.41  MBProgressHUD 相关属性"></a>1.41  MBProgressHUD 相关属性</h6><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// show 方法触发到显示 HUD 窗口的间隔时间，默认是 0</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSTimeInterval</span> graceTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// HUD 窗口显示的最短时间，默认是 0</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSTimeInterval</span> minShowTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// HUD 窗口显示模式, 默认是系统自带的指示器</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) MBProgressHUDMode mode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 进度条指示器以及文本的颜色</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>) <span class="built_in">UIColor</span> *contentColor <span class="built_in">UI_APPEARANCE_SELECTOR</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// HUD 窗口显示和隐藏的动画类型MBProgressHUD</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) MBProgressHUDAnimation animationType <span class="built_in">UI_APPEARANCE_SELECTOR</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// HUD 窗口位置设置，比如 hud.offset = CGPointMake(0.f, MBProgressMaxOffset)，可以移到底部中心位置</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CGPoint</span> offset <span class="built_in">UI_APPEARANCE_SELECTOR</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// HUD 元素到 HUD 边缘的距离，默认是 20.f</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> margin <span class="built_in">UI_APPEARANCE_SELECTOR</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// HUD 窗口背景框的最小尺寸</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CGSize</span> minSize <span class="built_in">UI_APPEARANCE_SELECTOR</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 是否强制 HUD 背景框宽高相等</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>, <span class="keyword">getter</span> = isSquare) <span class="built_in">BOOL</span> square <span class="built_in">UI_APPEARANCE_SELECTOR</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 进度条 (0.0 到 1.0)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">float</span> progress;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// bezelView 是指包括文本和指示器的视图，和自定义的 customView 类似</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) MBBackgroundView *bezelView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// backgroundView 背景视图</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) MBBackgroundView *backgroundView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// customView 自定义视图</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>) <span class="built_in">UIView</span> *customView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// label 指的是标题文本</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">UILabel</span> *label;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// detailsLabel指的是详情文本</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">UILabel</span> *detailsLabel;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// hud 窗口还可以加入button，添加事件</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">UIButton</span> *button;</span><br></pre></td></tr></table></figure>
<h6 id="1-42-MBRoundProgressView-相关属性"><a href="#1-42-MBRoundProgressView-相关属性" class="headerlink" title="1.42 MBRoundProgressView 相关属性"></a>1.42 MBRoundProgressView 相关属性</h6><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 进度条 (0.0 到 1.0)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">float</span> progress;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 进度条颜色</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *progressColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 进度条指示器的颜色</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *progressTintColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 进度条指示器的背景颜色，只适用在 iOS7 以上，默认为半透明的白色 (透明度 0.1)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *backgroundTintColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 显示模式，NO = 圆形；YES = 环形。默认是 NO</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">getter</span> = isAnnular) <span class="built_in">BOOL</span> annular;</span><br></pre></td></tr></table></figure>
<h6 id="1-43-MBBarProgressView-相关属性"><a href="#1-43-MBBarProgressView-相关属性" class="headerlink" title="1.43 MBBarProgressView 相关属性"></a>1.43 MBBarProgressView 相关属性</h6><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 进度条 (0.0 到 1.0)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">float</span> progress;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 进度条边界线的颜色，默认是白色</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *lineColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 进度条背景色，默认是透明</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *progressRemainingColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 进度条颜色</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *progressColor;</span><br></pre></td></tr></table></figure>
<h6 id="1-44-MBBackgroundView-相关属性"><a href="#1-44-MBBackgroundView-相关属性" class="headerlink" title="1.44 MBBackgroundView 相关属性"></a>1.44 MBBackgroundView 相关属性</h6><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 背景图层样式，有两种，iOS7 或者以上版本默认风格是MBProgressHUDBackgroundStyleBlur，其他为MBProgressHUDBackgroundStyleSolidColor，由于 iOS7 不支持 UIVisualEffectView，所以在 iOS7 和更高版本中会有所不同</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) MBProgressHUDBackgroundStyle style;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 背景颜色，由于 iOS7 不支持 UIVisualEffectView，所以在 iOS7 和更高版本中会有所不同</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *color;</span><br></pre></td></tr></table></figure>
<p><br><br></p>
<h4 id="1-5-MBProgressHUD-中的一些方法"><a href="#1-5-MBProgressHUD-中的一些方法" class="headerlink" title="1.5 MBProgressHUD 中的一些方法"></a>1.5 MBProgressHUD 中的一些方法</h4><h6 id="1-51-类方法"><a href="#1-51-类方法" class="headerlink" title="1.51 类方法"></a>1.51 类方法</h6><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 创建一个 HUD 窗口，并把它显示在 view 上，还可以设置是否有动画</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)showHUDAddedTo:(<span class="built_in">UIView</span> *)view animated:(<span class="built_in">BOOL</span>)animated;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 找到最上层的 HUD subview 并把它隐藏，成功为YES、其他情况为 NO</span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)hideHUDForView:(<span class="built_in">UIView</span> *)view animated:(<span class="built_in">BOOL</span>)animated;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 返回最上层的 HUD subview</span></span><br><span class="line">+ (<span class="keyword">nullable</span> MBProgressHUD *)HUDForView:(<span class="built_in">UIView</span> *)view;</span><br></pre></td></tr></table></figure>
<p>这三个类方法中，常用的是第一个函数<code>+ (instancetype)showHUDAddedTo:(UIView *)view animated:(BOOL)animated;</code>直接创建 HUD，并把它显示在 view 上，用起来极其方便</p>
<h6 id="1-52-对象方法"><a href="#1-52-对象方法" class="headerlink" title="1.52 对象方法"></a>1.52 对象方法</h6><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 以view为基准创建初始化一个HUD对象，为HUD的初始化构造函数</span></span><br><span class="line"><span class="selector-tag">-</span> (instancetype)<span class="selector-tag">initWithView</span><span class="selector-pseudo">:(UIView</span> *)<span class="selector-tag">view</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 显示HUD控件，此函数应该在主线程中调用</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">showAnimated</span><span class="selector-pseudo">:(BOOL)animated</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 隐藏HUD控件，animated控制是否显示动画。对应于- (void)showAnimated:(BOOL)animated;</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">hideAnimated</span><span class="selector-pseudo">:(BOOL)animated</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 在delay时间之后隐藏HUD，animated控制显示动画与否，delay控制延迟时间</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">hideAnimated</span><span class="selector-pseudo">:(BOOL)animated</span> <span class="selector-tag">afterDelay</span><span class="selector-pseudo">:(NSTimeInterval)delay</span>;</span><br></pre></td></tr></table></figure>
<p>这几个对象方法中，常用的也有两个<code>- (void)hideAnimated:(BOOL)animated;</code>和<code>- (void)hideAnimated:(BOOL)animated afterDelay:(NSTimeInterval)delay;</code></p>
<p><br><br></p>
<h2 id="二、show-系列方法"><a href="#二、show-系列方法" class="headerlink" title="二、show 系列方法"></a>二、show 系列方法</h2><blockquote>
<p>这一部分主要是展示 HUD 窗口时调用的方法及代码分析</p>
</blockquote>
<p>下面这个方法在我们创建 MBProgressHUD 对象时首先调用</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+ (instance<span class="keyword">type</span>)showHUDAddedTo:(<span class="type">UIView</span> *)view animated:(<span class="type">BOOL</span>)animated &#123;</span><br><span class="line"></span><br><span class="line">/// 创建并初始化 <span class="type">MBProgressHUD</span> 对象，根据传进来的 view 来设定</span><br><span class="line"><span class="type">MBProgressHUD</span> *hud = [[self alloc] initWithView:view];</span><br><span class="line"></span><br><span class="line">/// 移除 <span class="type">HUD</span> 窗口</span><br><span class="line">hud.removeFromSuperViewOnHide = <span class="type">YES</span>;</span><br><span class="line"></span><br><span class="line">/// 添加到 <span class="type">View</span> 上，并显示</span><br><span class="line">[view addSubview:hud];</span><br><span class="line">[hud showAnimated:animated];</span><br><span class="line">return hud;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法会调用两个主要方法：<code>- (id)initWithView:(UIView *)view</code> 和 <code>- (void)showAnimated:(BOOL)animated</code>，具体的调用流程如下图：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-effb289399c57e61.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="show 相关的方法调用"></p>
<p>当然在 MBProgressHUD 中，<code>+ (instancetype)showHUDAddedTo:(UIView *)view animated:(BOOL)animated</code> 调用的方法远不止上图列的这些，图上列的只是几个主要方法。接下来我们就根据程序的执行过程来一步一步分析一下代码。</p>
<p>在方法 <code>- (id)initWithView:(UIView *)view</code>中，调用 <code>- (instancetype)initWithFrame:(CGRect)frame</code>，接着会调用<code>- (void)commonInit</code>。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)initWithView:(<span class="built_in">UIView</span> *)view &#123;</span><br><span class="line"><span class="built_in">NSAssert</span>(view, <span class="string">@"View must not be nil."</span>);</span><br><span class="line"><span class="keyword">return</span> [<span class="keyword">self</span> initWithFrame:view.bounds];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithFrame:(<span class="built_in">CGRect</span>)frame &#123;</span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">self</span> = [<span class="keyword">super</span> initWithFrame:frame])) &#123;</span><br><span class="line">[<span class="keyword">self</span> commonInit];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)aDecoder &#123;</span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">self</span> = [<span class="keyword">super</span> initWithCoder:aDecoder])) &#123;</span><br><span class="line">[<span class="keyword">self</span> commonInit];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)commonInit &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 默认效果, 透明度变化</span></span><br><span class="line">_animationType = MBProgressHUDAnimationFade;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 默认模式, 系统自带的指示器</span></span><br><span class="line">_mode = MBProgressHUDModeIndeterminate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// HUD 元素到 HUD 边缘的距离，默认是 20.f</span></span><br><span class="line">_margin = <span class="number">20.0</span>f;</span><br><span class="line">_opacity = <span class="number">1.</span>f;</span><br><span class="line">_defaultMotionEffectsEnabled = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认颜色，根据当前的 iOS 版本</span></span><br><span class="line"><span class="built_in">BOOL</span> isLegacy = kCFCoreFoundationVersionNumber &lt; kCFCoreFoundationVersionNumber_iOS_7_0;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 进度条指示器以及文本的颜色</span></span><br><span class="line">_contentColor = isLegacy ? [<span class="built_in">UIColor</span> whiteColor] : [<span class="built_in">UIColor</span> colorWithWhite:<span class="number">0.</span>f alpha:<span class="number">0.7</span>f];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// opaque 类似 Alpha，表示当前 UIView 的不透明度，设置是否之后对于 UIView 的显示并没有什么影响,官方文档的意思是 opaque 默认为 YES，如果 alpha 小于 1，那么应该设置 opaque 设置为 NO，当 alpha 为 1，opaque设置为 NO</span></span><br><span class="line"><span class="keyword">self</span>.opaque = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 背景色</span></span><br><span class="line"><span class="keyword">self</span>.backgroundColor = [<span class="built_in">UIColor</span> clearColor];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 透明度为 0</span></span><br><span class="line"><span class="keyword">self</span>.alpha = <span class="number">0.0</span>f;</span><br><span class="line"><span class="comment">/// 自动调整子控件与父控件之间的宽高</span></span><br><span class="line"><span class="keyword">self</span>.autoresizingMask = <span class="built_in">UIViewAutoresizingFlexibleWidth</span> | <span class="built_in">UIViewAutoresizingFlexibleHeight</span>;</span><br><span class="line"><span class="keyword">self</span>.layer.allowsGroupOpacity = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 设置所需的子view</span></span><br><span class="line">[<span class="keyword">self</span> setupViews];</span><br><span class="line"><span class="comment">/// 设置指示器样式</span></span><br><span class="line">[<span class="keyword">self</span> updateIndicators];</span><br><span class="line"><span class="comment">/// 注册通知</span></span><br><span class="line">[<span class="keyword">self</span> registerForNotifications];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面代码块中的代码已经加过注释，因此在这里不再累述某句代码有什么作用，这里直接说程序的执行流程。当程序执行到 <code>- (void)commonInit</code> 这个方法时，会相继执行<code>- (void)setupViews</code>，<code>- (void)updateIndicators</code>，<code>- (void)registerForNotifications</code> 这三个方法，当然在执行这三个方法期间，也会执行其它的方法，比如会执行<code>- (void)updateForBackgroundStyle</code> 和<code>- (void)updateBezelMotionEffects</code>等等，这和你设置的 mode 的模式，以及和 label，detailsLabel ，button 这一系列元素，以及和相应的属性都有一定的关系。</p>
<p>接着我们来分析一下 <code>- (void)setupViews</code>，<code>- (void)updateIndicators</code>，<code>- (void)registerForNotifications</code> 这三个方法。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setupViews &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 进度条指示器以及文本的颜色</span></span><br><span class="line"><span class="built_in">UIColor</span> *defaultColor = <span class="keyword">self</span>.contentColor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 创建背景视图</span></span><br><span class="line">MBBackgroundView *backgroundView = [[MBBackgroundView alloc] initWithFrame:<span class="keyword">self</span>.bounds];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 背景图层样式</span></span><br><span class="line">backgroundView.style = MBProgressHUDBackgroundStyleSolidColor;</span><br><span class="line">backgroundView.backgroundColor = [<span class="built_in">UIColor</span> clearColor];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 自动调整 view 的宽度和高度</span></span><br><span class="line">backgroundView.autoresizingMask = <span class="built_in">UIViewAutoresizingFlexibleWidth</span> | <span class="built_in">UIViewAutoresizingFlexibleHeight</span>;</span><br><span class="line">backgroundView.alpha = <span class="number">0.</span>f;</span><br><span class="line">[<span class="keyword">self</span> addSubview:backgroundView];</span><br><span class="line">_backgroundView = backgroundView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 创建背景视图（和上面那个大小不同）</span></span><br><span class="line">MBBackgroundView *bezelView = [MBBackgroundView new];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 代码层面使用 Autolayout，需要对使用的 View 的translatesAutoresizingMaskIntoConstraints 属性设置为NO</span></span><br><span class="line">bezelView.translatesAutoresizingMaskIntoConstraints = <span class="literal">NO</span>;</span><br><span class="line">bezelView.layer.cornerRadius = <span class="number">5.</span>f;</span><br><span class="line">bezelView.alpha = <span class="number">0.</span>f;</span><br><span class="line">[<span class="keyword">self</span> addSubview:bezelView];</span><br><span class="line">_bezelView = bezelView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 调用 updateBezelMotionEffects 方法，设置视差效果</span></span><br><span class="line">[<span class="keyword">self</span> updateBezelMotionEffects];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 创建 label 标签，显示主要文本</span></span><br><span class="line"><span class="built_in">UILabel</span> *label = [<span class="built_in">UILabel</span> new];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 取消文字大小自适应</span></span><br><span class="line">label.adjustsFontSizeToFitWidth = <span class="literal">NO</span>;</span><br><span class="line">label.textAlignment = <span class="built_in">NSTextAlignmentCenter</span>;</span><br><span class="line">label.textColor = defaultColor;</span><br><span class="line">label.font = [<span class="built_in">UIFont</span> boldSystemFontOfSize:MBDefaultLabelFontSize];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// opaque 类似 Alpha，表示当前 UIView 的不透明度，设置是否之后对于 UIView 的显示并没有什么影响,官方文档的意思是 opaque 默认为 YES，如果 alpha 小于 1，那么应该设置 opaque 设置为 NO，当 alpha 为 1，opaque设置为 NO</span></span><br><span class="line">label.opaque = <span class="literal">NO</span>;</span><br><span class="line">label.backgroundColor = [<span class="built_in">UIColor</span> clearColor];</span><br><span class="line">_label = label;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 创建 detailsLabel 标签，显示详细信息</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UILabel</span> *detailsLabel = [<span class="built_in">UILabel</span> new];</span><br><span class="line"><span class="comment">/// 取消文字大小自适应</span></span><br><span class="line">detailsLabel.adjustsFontSizeToFitWidth = <span class="literal">NO</span>;</span><br><span class="line">detailsLabel.textAlignment = <span class="built_in">NSTextAlignmentCenter</span>;</span><br><span class="line">detailsLabel.textColor = defaultColor;</span><br><span class="line">detailsLabel.numberOfLines = <span class="number">0</span>;</span><br><span class="line">detailsLabel.font = [<span class="built_in">UIFont</span> boldSystemFontOfSize:MBDefaultDetailsLabelFontSize];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// opaque 类似 Alpha，表示当前 UIView 的不透明度，设置是否之后对于 UIView 的显示并没有什么影响,官方文档的意思是 opaque 默认为 YES，如果 alpha 小于 1，那么应该设置 opaque 设置为 NO，当 alpha 为 1，opaque设置为 NO</span></span><br><span class="line">detailsLabel.opaque = <span class="literal">NO</span>;</span><br><span class="line">detailsLabel.backgroundColor = [<span class="built_in">UIColor</span> clearColor];</span><br><span class="line">_detailsLabel = detailsLabel;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 创建 button 按钮，并添加响应按钮</span></span><br><span class="line"><span class="built_in">UIButton</span> *button = [MBProgressHUDRoundedButton buttonWithType:<span class="built_in">UIButtonTypeCustom</span>];</span><br><span class="line">button.titleLabel.textAlignment = <span class="built_in">NSTextAlignmentCenter</span>;</span><br><span class="line">button.titleLabel.font = [<span class="built_in">UIFont</span> boldSystemFontOfSize:MBDefaultDetailsLabelFontSize];</span><br><span class="line">[button setTitleColor:defaultColor forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">_button = button;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 将 label，detailLabel，button 添加到蒙版视图</span></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">UIView</span> *view <span class="keyword">in</span> @[label, detailsLabel, button]) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 代码层面使用 Autolayout，需要对使用的 View 的translatesAutoresizingMaskIntoConstraints 属性设置为NO</span></span><br><span class="line">view.translatesAutoresizingMaskIntoConstraints = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 为视图设置水平方向上优先级为 998 的压缩阻力</span></span><br><span class="line">[view setContentCompressionResistancePriority:<span class="number">998.</span>f forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 为视图设置垂直方向上优先级为 998 的压缩阻力</span></span><br><span class="line">[view setContentCompressionResistancePriority:<span class="number">998.</span>f forAxis:<span class="built_in">UILayoutConstraintAxisVertical</span>];</span><br><span class="line">[bezelView addSubview:view];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 创建顶部视图</span></span><br><span class="line"><span class="built_in">UIView</span> *topSpacer = [<span class="built_in">UIView</span> new];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 代码层面使用 Autolayout，需要对使用的 View 的translatesAutoresizingMaskIntoConstraints 属性设置为NO</span></span><br><span class="line">topSpacer.translatesAutoresizingMaskIntoConstraints = <span class="literal">NO</span>;</span><br><span class="line">topSpacer.hidden = <span class="literal">YES</span>;</span><br><span class="line">[bezelView addSubview:topSpacer];</span><br><span class="line">_topSpacer = topSpacer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 创建底部视图</span></span><br><span class="line"><span class="built_in">UIView</span> *bottomSpacer = [<span class="built_in">UIView</span> new];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 代码层面使用 Autolayout，需要对使用的 View 的translatesAutoresizingMaskIntoConstraints 属性设置为NO</span></span><br><span class="line">bottomSpacer.translatesAutoresizingMaskIntoConstraints = <span class="literal">NO</span>;</span><br><span class="line">bottomSpacer.hidden = <span class="literal">YES</span>;</span><br><span class="line">[bezelView addSubview:bottomSpacer];</span><br><span class="line">_bottomSpacer = bottomSpacer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)updateIndicators &#123;</span><br><span class="line"><span class="built_in">UIView</span> *indicator = <span class="keyword">self</span>.indicator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 判断当前指示器是否是 UIActivityIndicatorView</span></span><br><span class="line"><span class="built_in">BOOL</span> isActivityIndicator = [indicator isKindOfClass:[<span class="built_in">UIActivityIndicatorView</span> <span class="keyword">class</span>]];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 判断当前指示器是否是 MBRoundProgressView</span></span><br><span class="line"><span class="built_in">BOOL</span> isRoundIndicator = [indicator isKindOfClass:[MBRoundProgressView <span class="keyword">class</span>]];</span><br><span class="line"></span><br><span class="line">MBProgressHUDMode mode = <span class="keyword">self</span>.mode;</span><br><span class="line"><span class="comment">/// MBProgressHUDModeIndeterminate:系统自带的指示器</span></span><br><span class="line"><span class="keyword">if</span> (mode == MBProgressHUDModeIndeterminate) &#123;</span><br><span class="line"><span class="keyword">if</span> (!isActivityIndicator) &#123;</span><br><span class="line"><span class="comment">// 如果当前指示器不属于 UIActivityIndicatorView 类型，则移除之前的indicator，重新创建</span></span><br><span class="line">[indicator removeFromSuperview];</span><br><span class="line">indicator = [[<span class="built_in">UIActivityIndicatorView</span> alloc] initWithActivityIndicatorStyle:<span class="built_in">UIActivityIndicatorViewStyleWhiteLarge</span>];</span><br><span class="line">[(<span class="built_in">UIActivityIndicatorView</span> *)indicator startAnimating];</span><br><span class="line">[<span class="keyword">self</span>.bezelView addSubview:indicator];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (mode == MBProgressHUDModeDeterminateHorizontalBar) &#123;</span><br><span class="line"><span class="comment">/// 如果当前指示器不属于 MBBarProgressView 类型，则移除之前的indicator，重新创建</span></span><br><span class="line">[indicator removeFromSuperview];</span><br><span class="line">indicator = [[MBBarProgressView alloc] init];</span><br><span class="line">[<span class="keyword">self</span>.bezelView addSubview:indicator];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (mode == MBProgressHUDModeDeterminate || mode == MBProgressHUDModeAnnularDeterminate) &#123;</span><br><span class="line"><span class="keyword">if</span> (!isRoundIndicator) &#123;</span><br><span class="line"><span class="comment">/// 如果当前指示器不属于 MBRoundProgressView 类型，则移除之前的indicator，重新创建</span></span><br><span class="line">[indicator removeFromSuperview];</span><br><span class="line">indicator = [[MBRoundProgressView alloc] init];</span><br><span class="line">[<span class="keyword">self</span>.bezelView addSubview:indicator];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (mode == MBProgressHUDModeAnnularDeterminate) &#123; <span class="comment">/// 圆环指示器</span></span><br><span class="line">[(MBRoundProgressView *)indicator setAnnular:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (mode == MBProgressHUDModeCustomView &amp;&amp; <span class="keyword">self</span>.customView != indicator) &#123; <span class="comment">/// 自定义视图指示器</span></span><br><span class="line">[indicator removeFromSuperview];</span><br><span class="line">indicator = <span class="keyword">self</span>.customView;</span><br><span class="line">[<span class="keyword">self</span>.bezelView addSubview:indicator];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (mode == MBProgressHUDModeText) &#123; <span class="comment">/// 文本形式，去除指示器视图</span></span><br><span class="line">[indicator removeFromSuperview];</span><br><span class="line">indicator = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// 代码层面使用 Autolayout，需要对使用的 View 的translatesAutoresizingMaskIntoConstraints 属性设置为NO</span></span><br><span class="line">indicator.translatesAutoresizingMaskIntoConstraints = <span class="literal">NO</span>;</span><br><span class="line"><span class="keyword">self</span>.indicator = indicator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ([indicator respondsToSelector:<span class="keyword">@selector</span>(setProgress:)]) &#123;</span><br><span class="line"><span class="comment">/// 设置进度条的数值</span></span><br><span class="line">[(<span class="keyword">id</span>)indicator setValue:@(<span class="keyword">self</span>.progress) forKey:<span class="string">@"progress"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 为视图设置水平方向上优先级为 998 的压缩阻力</span></span><br><span class="line">[indicator setContentCompressionResistancePriority:<span class="number">998.</span>f forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 为视图设置垂直方向上优先级为 998 的压缩阻力</span></span><br><span class="line">[indicator setContentCompressionResistancePriority:<span class="number">998.</span>f forAxis:<span class="built_in">UILayoutConstraintAxisVertical</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 设置控件颜色</span></span><br><span class="line">[<span class="keyword">self</span> updateViewsForColor:<span class="keyword">self</span>.contentColor];</span><br><span class="line"><span class="comment">/// 更新布局</span></span><br><span class="line">[<span class="keyword">self</span> setNeedsUpdateConstraints];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)registerForNotifications &#123;</span><br><span class="line"><span class="meta">#if !TARGET_OS_TV</span></span><br><span class="line"><span class="built_in">NSNotificationCenter</span> *nc = [<span class="built_in">NSNotificationCenter</span> defaultCenter];</span><br><span class="line"><span class="comment">/// 通过通知 UIApplicationDidChangeStatusBarOrientationNotification 来处理屏幕转屏事件</span></span><br><span class="line">[nc addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(statusBarOrientationDidChange:)</span><br><span class="line">name:<span class="built_in">UIApplicationDidChangeStatusBarOrientationNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由上面代码我们可以看出，在方法<code>- (void)setupViews</code>中，创建了 backgroundView、bezelView、label、detailsLabel、button 这几个控件，并使用 for 循环把 label、detailsLabel、button 添加到bezelView 视图中，最后还创建了顶部视图和底部视图，不过默认是隐藏的。有一点值得说明，在创建 button 时并没有设置 button 的 size 等属性，那么这个按钮是不会显示的。在这里 MBProgressHUD 重写了一个 Unbutton 的子类 MBProgressHUDRoundedButton。这个子类里面有一个方法，<code>- (CGSize)intrinsicContentSize</code>，通过这个方法来设置 Unbutton 的 size。</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">CGSize</span>)intrinsicContentSize &#123;</span><br><span class="line"><span class="comment">/// 只有当有事件才显示（这里也告诉我们，如果这个 button 没有任何事件的话，它的大小就是 CGSizeZero，即不会显示）</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.allControlEvents == <span class="number">0</span>) <span class="keyword">return</span> <span class="built_in">CGSizeZero</span>;</span><br><span class="line"><span class="built_in">CGSize</span> size = [<span class="keyword">super</span> intrinsicContentSize];</span><br><span class="line"><span class="comment">// Add some side padding</span></span><br><span class="line">size.width += <span class="number">20.</span>f;</span><br><span class="line"><span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>- (void)updateIndicators</code>这个方法主要是用来设置 indicator 指示器的，根据 mode 的属性显示不同的形式，具体可以参看代码注释。这个方法最后调用的是<code>setNeedsUpdateConstraints</code>函数，这个函数是系统自带的方法，它会自动调用<code>- (void)updateConstraints</code> 方法，<code>- (void)updateConstraints</code> 主要作用是更新各个控件的布局，我们稍后再对这个方法进行详细分析。</p>
</li>
<li><p><code>- (void)registerForNotifications</code>这个方法中的代码量很少，它的作用是通过通知 UIApplicationDidChangeStatusBarOrientationNotification 来处理屏幕转屏事件</p>
</li>
</ul>
<p>当<code>- (void)registerForNotifications</code>这一系列方法执行完毕之后，程序会重新返回到<code>+ (instancetype)showHUDAddedTo:(UIView *)view animated:(BOOL)animated</code>这个方法中，接着调用另一个主要函数<code>- (void)showAnimated:(BOOL)animated</code>。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)showAnimated:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 显示放在主线程中</span></span><br><span class="line">MBMainThreadAssert();</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 取消定时器</span></span><br><span class="line">[<span class="keyword">self</span>.minShowTimer invalidate];</span><br><span class="line"><span class="keyword">self</span>.useAnimation = animated;</span><br><span class="line"><span class="keyword">self</span>.finished = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 如果设置了宽限时间graceTime，则延迟显示（避免 HUD 一闪而过的差体验）</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.graceTime &gt; <span class="number">0.0</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 创建定时器，把它加入 NSRunLoop 中</span></span><br><span class="line"><span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:<span class="keyword">self</span>.graceTime target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(handleGraceTimer:) userInfo:<span class="literal">nil</span> repeats:<span class="literal">NO</span>];</span><br><span class="line">[[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:timer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line"><span class="keyword">self</span>.graceTimer = timer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 没有设置 graceTime，则直接显示</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">[<span class="keyword">self</span> showUsingAnimation:<span class="keyword">self</span>.useAnimation];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 设置宽限时间 graceTime时调用的方法</span></span><br><span class="line">- (<span class="keyword">void</span>)handleGraceTimer:(<span class="built_in">NSTimer</span> *)theTimer &#123;</span><br><span class="line"><span class="comment">// Show the HUD only if the task is still running</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">self</span>.hasFinished) &#123;</span><br><span class="line">[<span class="keyword">self</span> showUsingAnimation:<span class="keyword">self</span>.useAnimation];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)showUsingAnimation:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line"><span class="comment">/// 移除所有动画</span></span><br><span class="line">[<span class="keyword">self</span>.bezelView.layer removeAllAnimations];</span><br><span class="line">[<span class="keyword">self</span>.backgroundView.layer removeAllAnimations];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 取消 hideDelayTimer</span></span><br><span class="line">[<span class="keyword">self</span>.hideDelayTimer invalidate];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 开始时间</span></span><br><span class="line"><span class="keyword">self</span>.showStarted = [<span class="built_in">NSDate</span> date];</span><br><span class="line"><span class="keyword">self</span>.alpha = <span class="number">1.</span>f;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 以防我们隐藏 NSProgress 对象</span></span><br><span class="line">[<span class="keyword">self</span> setNSProgressDisplayLinkEnabled:<span class="literal">YES</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (animated) &#123;</span><br><span class="line">[<span class="keyword">self</span> animateIn:<span class="literal">YES</span> withType:<span class="keyword">self</span>.animationType completion:<span class="literal">NULL</span>];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/// 方法弃用告警</span></span><br><span class="line"><span class="meta">#pragma clang diagnostic push</span></span><br><span class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Wdeprecated-declarations"</span></span></span><br><span class="line"><span class="keyword">self</span>.bezelView.alpha = <span class="keyword">self</span>.opacity;</span><br><span class="line"><span class="meta">#pragma clang diagnostic pop</span></span><br><span class="line"><span class="keyword">self</span>.backgroundView.alpha = <span class="number">1.</span>f;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由上面这段代码我们可以看出，在方法<code>- (void)showAnimated:(BOOL)animated</code>中，无论我们有没有设置<code>graceTime</code>这个属性，最后都会去执行一个方法 <code>- (void)showUsingAnimation:(BOOL)animated</code>，<code>- (void)showUsingAnimation:(BOOL)animated</code> 这个方法在上面已经做过注释，不再细说，不过有两小点值得我们注意，第一点是 <code>- (void)showUsingAnimation:(BOOL)animated</code> 在执行过程中调用了一个方法 <code>- (void)setNSProgressDisplayLinkEnabled:(BOOL)enabled</code>，先来看下这个方法<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setNSProgressDisplayLinkEnabled:(<span class="built_in">BOOL</span>)enabled &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 这里使用 CADisplayLink，是因为如果使用 KVO 机制会非常消耗主线程（因为 NSProgress 频率非常快）</span></span><br><span class="line"><span class="keyword">if</span> (enabled &amp;&amp; <span class="keyword">self</span>.progressObject) &#123;</span><br><span class="line"><span class="comment">/// 创建 CADisplayLink 对象</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">self</span>.progressObjectDisplayLink) &#123;</span><br><span class="line"><span class="keyword">self</span>.progressObjectDisplayLink = [<span class="built_in">CADisplayLink</span> displayLinkWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(updateProgressFromProgressObject)];</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">self</span>.progressObjectDisplayLink = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法是关于 <code>CADisplayLink</code> 的，<code>CADisplayLink</code> 是一个能让我们以和屏幕刷新率相同的频率将内容画到屏幕上的定时器。我们在应用中创建一个新的 <code>CADisplayLink</code> 对象，把它添加到一个<code>runloop</code> 中，并给它提供一个 <code>target</code> 和 <code>selector</code> 在屏幕刷新的时候调用。一旦 <code>CADisplayLink</code> 以特定的模式注册到 <code>runloop</code> 之后，每当屏幕需要刷新，<code>runloop</code> 就会向 <code>CADisplayLink</code> 指定的<code>target</code> 发送一次指定的 <code>selector</code> 消息， <code>CADisplayLink</code> 类对应的 <code>selector</code> 就会被调用一次。</p>
<p><code>- (void)showUsingAnimation:(BOOL)animated</code> 这个方法中还有一点值得注意，就是只有具有动画效果的前提下，即 <code>animated</code> 为真时才会调用 <code>- (void)animateIn:(BOOL)animatingIn withType:(MBProgressHUDAnimation)type completion:(void(^)(BOOL finished))completion</code> 这个方法，下面我们再一起来看下这个方法。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// animated 为真时调用，消失或出现时的伸缩效果，以及透明度</span></span><br><span class="line">- (<span class="keyword">void</span>)animateIn:(<span class="built_in">BOOL</span>)animatingIn withType:(MBProgressHUDAnimation)type completion:(<span class="keyword">void</span>(^)(<span class="built_in">BOOL</span> finished))completion &#123;</span><br><span class="line"><span class="comment">/// 自动确定正确的缩放动画类型，关于 MBProgressHUDAnimation 的几种类型，上文已全部列出，这里不再详细介绍</span></span><br><span class="line"><span class="keyword">if</span> (type == MBProgressHUDAnimationZoom) &#123;</span><br><span class="line">type = animatingIn ? MBProgressHUDAnimationZoomIn : MBProgressHUDAnimationZoomOut;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// CGAffineTransformMakeScale 中的两个参数，分别代表x和y方向缩放倍数</span></span><br><span class="line"><span class="built_in">CGAffineTransform</span> small = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">0.5</span>f, <span class="number">0.5</span>f);</span><br><span class="line"><span class="built_in">CGAffineTransform</span> large = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">1.5</span>f, <span class="number">1.5</span>f);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 设定初始状态</span></span><br><span class="line"><span class="built_in">UIView</span> *bezelView = <span class="keyword">self</span>.bezelView;</span><br><span class="line"><span class="keyword">if</span> (animatingIn &amp;&amp; bezelView.alpha == <span class="number">0.</span>f &amp;&amp; type == MBProgressHUDAnimationZoomIn) &#123;</span><br><span class="line">bezelView.transform = small; <span class="comment">/// 缩放</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (animatingIn &amp;&amp; bezelView.alpha == <span class="number">0.</span>f &amp;&amp; type == MBProgressHUDAnimationZoomOut) &#123;</span><br><span class="line">bezelView.transform = large; <span class="comment">/// 扩大</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 创建动画任务</span></span><br><span class="line">dispatch_block_t animations = ^&#123;</span><br><span class="line"><span class="keyword">if</span> (animatingIn) &#123;</span><br><span class="line">bezelView.transform = <span class="built_in">CGAffineTransformIdentity</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!animatingIn &amp;&amp; type == MBProgressHUDAnimationZoomIn) &#123;</span><br><span class="line">bezelView.transform = large;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!animatingIn &amp;&amp; type == MBProgressHUDAnimationZoomOut) &#123;</span><br><span class="line">bezelView.transform = small;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 方法弃用告警</span></span><br><span class="line"><span class="meta">#pragma clang diagnostic push</span></span><br><span class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Wdeprecated-declarations"</span></span></span><br><span class="line">bezelView.alpha = animatingIn ? <span class="keyword">self</span>.opacity : <span class="number">0.</span>f;</span><br><span class="line"><span class="meta">#pragma clang diagnostic pop</span></span><br><span class="line"><span class="keyword">self</span>.backgroundView.alpha = animatingIn ? <span class="number">1.</span>f : <span class="number">0.</span>f;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 动画的两种形式，&gt;= iOS7 的是一种形式，iOS7以下是另一种</span></span><br><span class="line"><span class="meta">#if __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= 70000 || TARGET_OS_TV</span></span><br><span class="line"><span class="keyword">if</span> (kCFCoreFoundationVersionNumber &gt;= kCFCoreFoundationVersionNumber_iOS_7_0) &#123;</span><br><span class="line"><span class="comment">/// 只支持 &gt;= iOS7</span></span><br><span class="line">[<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.3</span> delay:<span class="number">0.</span> usingSpringWithDamping:<span class="number">1.</span>f initialSpringVelocity:<span class="number">0.</span>f options:<span class="built_in">UIViewAnimationOptionBeginFromCurrentState</span> animations:animations completion:completion];</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">[<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.3</span> delay:<span class="number">0.</span> options:<span class="built_in">UIViewAnimationOptionBeginFromCurrentState</span> animations:animations completion:completion];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>- (void)animateIn:(BOOL)animatingIn withType:(MBProgressHUDAnimation)type completion:(void(^)(BOOL finished))completion</code> 这个方法，无论是处于 show 状态还是处于 hide 状态，都会调用，下边我们再一起看下 hide 系列的一些方法。</p>
<h2 id="三、hide-系列方法"><a href="#三、hide-系列方法" class="headerlink" title="三、hide 系列方法"></a>三、hide 系列方法</h2><blockquote>
<p>这一部分主要是隐藏 HUD 窗口时调用的方法及代码分析</p>
</blockquote>
<p>关于隐藏 HUD 窗口，MBProgressHUD 给我们提供的方法有以下几个：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 找到最上层的 HUD subview 并把它隐藏，成功为YES、其他情况为 NO</span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)hideHUDForView:(<span class="built_in">UIView</span> *)view animated:(<span class="built_in">BOOL</span>)animated;</span><br><span class="line"></span><br><span class="line"><span class="comment">//隐藏HUD控件，animated控制是否显示动画。对应于- (void)showAnimated:(BOOL)animated;</span></span><br><span class="line">- (<span class="keyword">void</span>)hideAnimated:(<span class="built_in">BOOL</span>)animated;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在delay时间之后隐藏HUD，animated控制显示动画与否，delay控制延迟时间</span></span><br><span class="line">- (<span class="keyword">void</span>)hideAnimated:(<span class="built_in">BOOL</span>)animated afterDelay:(<span class="built_in">NSTimeInterval</span>)delay;</span><br></pre></td></tr></table></figure></p>
<p>最常用的是后面两个： <code>- (void)hideAnimated:(BOOL)animated</code> 和  <code>- (void)hideAnimated:(BOOL)animated afterDelay:(NSTimeInterval)delay</code>，这两个方法的本质是相同的，不同的只是形式，也就是说这两个方法的实现流程基本上是一致的，只不过 <code>- (void)hideAnimated:(BOOL)animated afterDelay:(NSTimeInterval)delay</code> 多执行一两个方法而已。下面我们就来具体分析下 hide 系列的方法。</p>
<ul>
<li>首先还是来说说<code>+ (BOOL)hideHUDForView:(UIView *)view animated:(BOOL)animated</code>这个函数，如果调用这个方法来隐藏 HUD 窗口，那么会先调用两个方法：</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)hideHUDForView:(<span class="built_in">UIView</span> *)view animated:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line"><span class="comment">/// 获取当前 view 的最上面的 HUD</span></span><br><span class="line">MBProgressHUD *hud = [<span class="keyword">self</span> HUDForView:view];</span><br><span class="line"><span class="keyword">if</span> (hud != <span class="literal">nil</span>) &#123;</span><br><span class="line"><span class="comment">/// 移除 HUD 窗口</span></span><br><span class="line">hud.removeFromSuperViewOnHide = <span class="literal">YES</span>;</span><br><span class="line">[hud hideAnimated:animated];</span><br><span class="line"><span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (MBProgressHUD *)HUDForView:(<span class="built_in">UIView</span> *)view &#123;</span><br><span class="line"><span class="comment">/// NSEnumerator 是一个枚举器，依附于集合类（NSArray,NSSet,NSDictionary等），reverseObjectEnumerator 倒序遍历</span></span><br><span class="line"><span class="built_in">NSEnumerator</span> *subviewsEnum = [view.subviews reverseObjectEnumerator];</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">UIView</span> *subview <span class="keyword">in</span> subviewsEnum) &#123;</span><br><span class="line"><span class="keyword">if</span> ([subview isKindOfClass:<span class="keyword">self</span>]) &#123;</span><br><span class="line"><span class="keyword">return</span> (MBProgressHUD *)subview;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当执行完上面这两个方法之后，接下来执行的方法和调用<code>- (void)hideAnimated:(BOOL)animated</code>隐藏 HUD 窗口时执行的方法相同，所以下边会详细分析。</p>
<ul>
<li>接下来说说调用<code>- (void)hideAnimated:(BOOL)animated afterDelay:(NSTimeInterval)delay</code> 隐藏 HUD 窗口时的情况，上文已经说过，调用这个方法会比调用<code>- (void)hideAnimated:(BOOL)animated</code> 多执行一两个方法：</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="string">hideAnimated:</span>(BOOL)animated <span class="string">afterDelay:</span>(NSTimeInterval)delay &#123;</span><br><span class="line"><span class="comment">/// 创建定时器，并把它加入到 NSRunLoop 中</span></span><br><span class="line">NSTimer *timer = [NSTimer <span class="string">timerWithTimeInterval:</span>delay <span class="string">target:</span>self <span class="string">selector:</span><span class="meta">@selector</span>(<span class="string">handleHideTimer:</span>) <span class="string">userInfo:</span>@(animated) <span class="string">repeats:</span>NO];</span><br><span class="line">[[NSRunLoop currentRunLoop] <span class="string">addTimer:</span>timer <span class="string">forMode:</span>NSRunLoopCommonModes];</span><br><span class="line">self.hideDelayTimer = timer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">handleHideTimer:</span>(NSTimer *)timer &#123;</span><br><span class="line">[self <span class="string">hideAnimated:</span>[timer.userInfo boolValue]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由上面代码可以清晰的看出，<code>- (void)hideAnimated:(BOOL)animated afterDelay:(NSTimeInterval)delay</code> 这个方法中加了一个定时器，当执行完这个定时器的<code>selector</code>时，就会执行<code>- (void)hideAnimated:(BOOL)animated</code>方法。</p>
<ul>
<li>由此可见无论使用哪种方法隐藏 HUD 窗口，最终都会来到这个方法，<code>- (void)hideAnimated:(BOOL)animated</code>，接下来我们就来分析下这个方法的具体调用流程，先看个图：</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/2665449-d01f3044d62ba8d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="hide 相关的方法调用"></p>
<p>上图显示的是 hide 相关的方法调用，只罗列了几个主要方法。接下来我们就来分析下这几个主要方法。先来到<code>- (void)hideAnimated:(BOOL)animated</code>方法中：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)hideAnimated:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">MBMainThreadAssert();</span><br><span class="line">[<span class="keyword">self</span>.graceTimer invalidate];</span><br><span class="line"><span class="keyword">self</span>.useAnimation = animated;</span><br><span class="line"><span class="keyword">self</span>.finished = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 如果设置了最小显示时间，则执行此步骤，否则直接隐藏</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.minShowTime &gt; <span class="number">0.0</span> &amp;&amp; <span class="keyword">self</span>.showStarted) &#123;</span><br><span class="line"><span class="built_in">NSTimeInterval</span> interv = [[<span class="built_in">NSDate</span> date] timeIntervalSinceDate:<span class="keyword">self</span>.showStarted];</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 如果 minShowTime 比较大，则暂时不触发 HUD 的隐藏，而是启动一个 NSTimer</span></span><br><span class="line"><span class="keyword">if</span> (interv &lt; <span class="keyword">self</span>.minShowTime) &#123;</span><br><span class="line"><span class="comment">/// 创建定时器，并把它加入到 NSRunLoop 中</span></span><br><span class="line"><span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:(<span class="keyword">self</span>.minShowTime - interv) target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(handleMinShowTimer:) userInfo:<span class="literal">nil</span> repeats:<span class="literal">NO</span>];</span><br><span class="line">[[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:timer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line"><span class="keyword">self</span>.minShowTimer = timer;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// 直接隐藏 HUD</span></span><br><span class="line">[<span class="keyword">self</span> hideUsingAnimation:<span class="keyword">self</span>.useAnimation];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)handleMinShowTimer:(<span class="built_in">NSTimer</span> *)theTimer &#123;</span><br><span class="line">[<span class="keyword">self</span> hideUsingAnimation:<span class="keyword">self</span>.useAnimation];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面代码块中可以看出，无论我们有没有设置最小显示时间 <code>self.minShowTime</code>，都会触发 <code>- (void)hideUsingAnimation:(BOOL)animated</code> 这个方法，因此程序最后都会来到 <code>- (void)hideUsingAnimation:(BOOL)animated</code> 这个方法中：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)hideUsingAnimation:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line"><span class="keyword">if</span> (animated &amp;&amp; <span class="keyword">self</span>.showStarted) &#123;</span><br><span class="line"><span class="comment">/// 将 showStarted 设为 nil</span></span><br><span class="line"><span class="keyword">self</span>.showStarted = <span class="literal">nil</span>;</span><br><span class="line">[<span class="keyword">self</span> animateIn:<span class="literal">NO</span> withType:<span class="keyword">self</span>.animationType completion:^(<span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line">[<span class="keyword">self</span> done];</span><br><span class="line">&#125;];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">self</span>.showStarted = <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">self</span>.bezelView.alpha = <span class="number">0.</span>f;</span><br><span class="line"><span class="keyword">self</span>.backgroundView.alpha = <span class="number">1.</span>f;</span><br><span class="line">[<span class="keyword">self</span> done];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法和 show 系列的 <code>- (void)showUsingAnimation:(BOOL)animated</code> 方法一样，只要设定 animated 的属性为 YES，最终都会走到 <code>- (void)animateIn:(BOOL)animatingIn withType:(MBProgressHUDAnimation)type completion:(void(^)(BOOL finished))completion</code> 这个方法中，同时会执行一个方法：<code>- (void)done</code>，接下来我们来看一下这两个方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// animated 为真时调用，消失或出现时的伸缩效果，以及透明度</span></span><br><span class="line">- (<span class="keyword">void</span>)animateIn:(<span class="built_in">BOOL</span>)animatingIn withType:(MBProgressHUDAnimation)type completion:(<span class="keyword">void</span>(^)(<span class="built_in">BOOL</span> finished))completion &#123;</span><br><span class="line"><span class="comment">/// 自动确定正确的缩放动画类型，关于 MBProgressHUDAnimation 的几种类型，上文已全部列出，这里不再详细介绍</span></span><br><span class="line"><span class="keyword">if</span> (type == MBProgressHUDAnimationZoom) &#123;</span><br><span class="line">type = animatingIn ? MBProgressHUDAnimationZoomIn : MBProgressHUDAnimationZoomOut;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// CGAffineTransformMakeScale 中的两个参数，分别代表x和y方向缩放倍数</span></span><br><span class="line"><span class="built_in">CGAffineTransform</span> small = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">0.5</span>f, <span class="number">0.5</span>f);</span><br><span class="line"><span class="built_in">CGAffineTransform</span> large = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">1.5</span>f, <span class="number">1.5</span>f);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 设定初始状态</span></span><br><span class="line"><span class="built_in">UIView</span> *bezelView = <span class="keyword">self</span>.bezelView;</span><br><span class="line"><span class="keyword">if</span> (animatingIn &amp;&amp; bezelView.alpha == <span class="number">0.</span>f &amp;&amp; type == MBProgressHUDAnimationZoomIn) &#123;</span><br><span class="line">bezelView.transform = small; <span class="comment">/// 缩放</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (animatingIn &amp;&amp; bezelView.alpha == <span class="number">0.</span>f &amp;&amp; type == MBProgressHUDAnimationZoomOut) &#123;</span><br><span class="line">bezelView.transform = large; <span class="comment">/// 扩大</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 创建动画任务</span></span><br><span class="line">dispatch_block_t animations = ^&#123;</span><br><span class="line"><span class="keyword">if</span> (animatingIn) &#123;</span><br><span class="line">bezelView.transform = <span class="built_in">CGAffineTransformIdentity</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!animatingIn &amp;&amp; type == MBProgressHUDAnimationZoomIn) &#123;</span><br><span class="line">bezelView.transform = large;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!animatingIn &amp;&amp; type == MBProgressHUDAnimationZoomOut) &#123;</span><br><span class="line">bezelView.transform = small;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 方法弃用告警</span></span><br><span class="line"><span class="meta">#pragma clang diagnostic push</span></span><br><span class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Wdeprecated-declarations"</span></span></span><br><span class="line">bezelView.alpha = animatingIn ? <span class="keyword">self</span>.opacity : <span class="number">0.</span>f;</span><br><span class="line"><span class="meta">#pragma clang diagnostic pop</span></span><br><span class="line"><span class="keyword">self</span>.backgroundView.alpha = animatingIn ? <span class="number">1.</span>f : <span class="number">0.</span>f;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 动画的两种形式，&gt;= iOS7 的是一种形式，iOS7以下是另一种</span></span><br><span class="line"><span class="meta">#if __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= 70000 || TARGET_OS_TV</span></span><br><span class="line"><span class="keyword">if</span> (kCFCoreFoundationVersionNumber &gt;= kCFCoreFoundationVersionNumber_iOS_7_0) &#123;</span><br><span class="line"><span class="comment">/// 只支持 &gt;= iOS7</span></span><br><span class="line">[<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.3</span> delay:<span class="number">0.</span> usingSpringWithDamping:<span class="number">1.</span>f initialSpringVelocity:<span class="number">0.</span>f options:<span class="built_in">UIViewAnimationOptionBeginFromCurrentState</span> animations:animations completion:completion];</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">[<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.3</span> delay:<span class="number">0.</span> options:<span class="built_in">UIViewAnimationOptionBeginFromCurrentState</span> animations:animations completion:completion];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)done &#123;</span><br><span class="line"><span class="comment">/// 取消 hideDelayTimer</span></span><br><span class="line">[<span class="keyword">self</span>.hideDelayTimer invalidate];</span><br><span class="line"><span class="comment">/// 隐藏 NSProgress 对象</span></span><br><span class="line">[<span class="keyword">self</span> setNSProgressDisplayLinkEnabled:<span class="literal">NO</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.hasFinished) &#123;</span><br><span class="line"><span class="keyword">self</span>.alpha = <span class="number">0.0</span>f;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.removeFromSuperViewOnHide) &#123;</span><br><span class="line"><span class="comment">/// 从父视图中移除</span></span><br><span class="line">[<span class="keyword">self</span> removeFromSuperview];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">MBProgressHUDCompletionBlock completionBlock = <span class="keyword">self</span>.completionBlock;</span><br><span class="line"><span class="keyword">if</span> (completionBlock) &#123;</span><br><span class="line">completionBlock();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">id</span>&lt;MBProgressHUDDelegate&gt; delegate = <span class="keyword">self</span>.delegate;</span><br><span class="line"><span class="keyword">if</span> ([delegate respondsToSelector:<span class="keyword">@selector</span>(hudWasHidden:)]) &#123;</span><br><span class="line">[delegate performSelector:<span class="keyword">@selector</span>(hudWasHidden:) withObject:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 <code>- (void)animateIn:(BOOL)animatingIn withType:(MBProgressHUDAnimation)type completion:(void(^)(BOOL finished))completion</code> 这个方法，只要 <code>animated</code> 的属性为 YES，都会调用；而在<code>- (void)done</code> 这个方法中，如果 removeFromSuperViewOnHide 属性为 YES，则将自己从父视图上移除；如果有 completionBlock 回调函数，则执行回调；如果实现了代理并实现了代理方法，则执行代理方法。而且我们还观察到在 hide 时，也会调用 <code>- (void)setNSProgressDisplayLinkEnabled:(BOOL)enabled</code> 方法，只是在 hide 时 enabled 为 NO。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setNSProgressDisplayLinkEnabled:(<span class="built_in">BOOL</span>)enabled &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 这里使用 CADisplayLink，是因为如果使用 KVO 机制会非常消耗主线程（因为 NSProgress 频率非常快）</span></span><br><span class="line"><span class="keyword">if</span> (enabled &amp;&amp; <span class="keyword">self</span>.progressObject) &#123;</span><br><span class="line"><span class="comment">/// 创建 CADisplayLink 对象</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">self</span>.progressObjectDisplayLink) &#123;</span><br><span class="line"><span class="keyword">self</span>.progressObjectDisplayLink = [<span class="built_in">CADisplayLink</span> displayLinkWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(updateProgressFromProgressObject)];</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">self</span>.progressObjectDisplayLink = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>over</strong></p>
<hr>
<p>以上便是对 MBProgressHUD 源码的一些总结和认识，如果有不足之处，还希望各位道友能多指点哈！</p>
<hr>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘朋坤</p>
              <p class="site-description motion-element" itemprop="description">iOS 修炼中...</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">37</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘朋坤</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.1.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
